<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TRPG ì¼ì • â€” Neverending Cthulhu</title>

<!-- ëª¨ë“  ë§í¬ë¥¼ ê°™ì€ íƒ­ì—ì„œ ì—´ê¸° -->
<base target="_self">

<style>
  :root{
    --bg:#0d1a1f; --ink:#e6eef2; --muted:#a8bcc6; --line:#1f2b31;
    --brand:#4C8DA9; --accent:#86d2c7;
    --white:255 255 255; --alpha:.22; --blur:14px;
    --shadow-lg: 0 12px 28px rgba(0,0,0,.35), 0 4px 10px rgba(0,0,0,.25);
    --shadow-md: 0 8px 18px rgba(0,0,0,.28), 0 2px 8px rgba(0,0,0,.18);
  }
  html,body{ height:100% }
  body{
    margin:0; background:
      radial-gradient(900px 500px at 70% -10%, rgba(76,141,169,.18), transparent 60%),
      radial-gradient(700px 400px at 5% 110%, rgba(134,210,199,.12), transparent 60%),
      var(--bg);
    color:var(--ink);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo","Malgun Gothic","ë§‘ì€ ê³ ë”•", sans-serif;
    display:flex; flex-direction:column;
  }
  .wrap{max-width:1220px; width:100%; margin:24px auto; padding:0 16px; flex:1; display:flex; flex-direction:column;}

  .toolbar{
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    background: rgba(var(--white), var(--alpha));
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:12px;
    backdrop-filter:saturate(140%) blur(var(--blur));
    -webkit-backdrop-filter:saturate(140%) blur(var(--blur));
    margin-bottom:16px; box-shadow: var(--shadow-md);
  }

  .btn{
    appearance:none; user-select:none; -webkit-tap-highlight-color: transparent;
    display:inline-flex; align-items:center; gap:10px;
    border-radius:12px; padding:10px 14px; font-weight:800; letter-spacing:.01em;
    cursor:pointer; border:1px solid rgba(255,255,255,.08);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    color:var(--ink);
    box-shadow: 0 1px 0 rgba(255,255,255,.06) inset, var(--shadow-md);
    transition: transform .16s cubic-bezier(.22,.8,.2,1), box-shadow .16s, background .16s, border-color .16s;
    backdrop-filter: saturate(140%) blur(8px);
    -webkit-backdrop-filter: saturate(140%) blur(8px);
  }
  .btn svg{ width:16px; height:16px; opacity:.9 }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 1px 0 rgba(255,255,255,.1) inset, 0 10px 22px rgba(0,0,0,.35) }
  .btn:active{ transform: translateY(0); box-shadow: none }
  .btn:focus-visible{ outline: none; box-shadow: 0 0 0 2px rgba(134,210,199,.5), var(--shadow-md) }
  .btn--ghost{ background: rgba(255,255,255,.06); }
  .btn--brand{
    background: linear-gradient(180deg, rgba(76,141,169,.55), rgba(76,141,169,.35));
    border-color: rgba(76,141,169,.55); color:#0b1519;
  }
  .btn--brand:hover{ box-shadow: 0 1px 0 rgba(255,255,255,.25) inset, 0 12px 26px rgba(76,141,169,.35) }

  .pill{
    display:inline-flex; gap:6px; padding:6px;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.08);
    border-radius:999px;
  }
  .pill button{
    border:0; background:transparent; color:var(--muted);
    padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer;
    transition: all .18s cubic-bezier(.22,.8,.2,1);
  }
  .pill button[aria-pressed="true"]{
    background: linear-gradient(180deg, rgba(76,141,169,.20), rgba(76,141,169,.12));
    box-shadow: 0 1px 0 rgba(255,255,255,.12) inset, 0 0 0 1px rgba(255,255,255,.10) inset;
    color:var(--ink);
  }
  .pill button:hover{ transform: translateY(-1px) }
  .toolbar .spacer{ flex:1 }

  .card{
    background: rgba(15, 28, 33, .55); border:1px solid rgba(255,255,255,.08); border-radius:18px;
    backdrop-filter:saturate(140%) blur(var(--blur)); -webkit-backdrop-filter:saturate(140%) blur(var(--blur));
    box-shadow: var(--shadow-lg); padding:12px; flex:1; display:flex; min-height: 680px;
  }
  #cal{height:100%; width:100%}

  .toastui-calendar-day-name{background:rgba(255,255,255,.06); border-bottom:1px solid var(--line); color:var(--muted)}
  .toastui-calendar-grid-cell{border-color:var(--line)}
  .toastui-calendar-panel + .toastui-calendar-panel .toastui-calendar-grid-cell{border-top-color:var(--line)}
  .toastui-calendar-week-view .toastui-calendar-panel-resizer{border-color:var(--line)}
  .toastui-calendar-time{color:var(--muted)}
  .toastui-calendar-grid-selection{background: rgba(76,141,169,.14); border: 1px solid rgba(76,141,169,.45)}
  .toastui-calendar-popup-container{border-radius:12px; color:#0b1519}
  .toastui-calendar-popup-container .toastui-calendar-section-button{color:#0b1519}
</style>

<!-- â˜… ë¨¼ì €: Toast UI ë¡œë”ë¥¼ ì„ ì–¸(ì „ì—­ Promise ì œê³µ) -->
<script>
  (function(){
    const CSS_CANDIDATES = [
      'https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.css',
      'https://unpkg.com/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.css',
      './vendor/toastui/toastui-calendar.min.css'
    ];
    const JS_CANDIDATES = [
      'https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.js',
      'https://unpkg.com/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.js',
      './vendor/toastui/toastui-calendar.min.js'
    ];

    function loadCSS(url){
      return new Promise((resolve,reject)=>{
        const link=document.createElement('link');
        link.rel='stylesheet'; link.href=url;
        link.onload=()=>resolve(url);
        link.onerror=()=>reject(new Error('css fail: '+url));
        document.head.appendChild(link);
      });
    }
    function loadJS(url){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=url; s.defer=true;
        s.onload=()=>resolve(url);
        s.onerror=()=>reject(new Error('js fail: '+url));
        document.head.appendChild(s);
      });
    }
    async function trySeq(list, loader){
      let last;
      for (const u of list){
        try { await loader(u); return u; }
        catch(e){ last=e; }
      }
      throw last || new Error('all failed');
    }

    // ì „ì—­ Promise: ì´ˆê¸°í™” ì½”ë“œê°€ ì´ê±¸ ê¸°ë‹¤ë¦¼
    window.toastuiReady = (async () => {
      try{
        // CSSëŠ” best-effort: í•˜ë‚˜ ì„±ê³µí•˜ë©´ ì¢‹ê³ , ì‹¤íŒ¨í•´ë„ ì§„í–‰
        try { await trySeq(CSS_CANDIDATES, loadCSS); } catch(_){}
        await trySeq(JS_CANDIDATES, loadJS);

        // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ê°€ ë¡œë“œëë”ë¼ë„, ì „ì—­ ê°ì²´ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ í•œ ë²ˆ ë” í™•ì¸
        const t0 = performance.now();
        while (!window.toastui || !window.toastui.Calendar){
          if (performance.now() - t0 > 5000) throw new Error('toastui boot timeout');
          await new Promise(r=>setTimeout(r,30));
        }
        return true;
      }catch(err){
        console.error('ToastUI load failed:', err);
        return false;
      }
    })();
  })();
</script>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button class="btn btn--ghost" id="home" aria-label="í™ˆ">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>í™ˆ</span>
      </button>
      <button class="btn btn--ghost" id="back" aria-label="ë’¤ë¡œê°€ê¸°">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg>
        <span>ë’¤ë¡œ</span>
      </button>

      <div class="pill" role="tablist" aria-label="ë·° ì„ íƒ" style="margin-left:8px">
        <button data-view="month" aria-pressed="true">ì›”ê°„</button>
        <button data-view="week"  aria-pressed="false">ì£¼ê°„</button>
        <button data-view="day"   aria-pressed="false">ì¼ê°„</button>
      </div>

      <div class="spacer"></div>

      <button class="btn btn--ghost" id="reload-json">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn--ghost" id="export-json">ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn--brand" id="quick-add">ìƒˆ ì¼ì •</button>

      <button class="btn btn--ghost" id="prev" aria-label="ì´ì „">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg>
        <span>ì´ì „</span>
      </button>
      <button class="btn btn--brand" id="today"><span>ì˜¤ëŠ˜</span></button>
      <button class="btn btn--ghost" id="next" aria-label="ë‹¤ìŒ">
        <span>ë‹¤ìŒ</span>
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="m8.59 16.59 4.58-4.59-4.58-4.59L10 6l6 6-6 6z"/></svg>
      </button>
    </div>

    <div class="card">
      <div id="cal" aria-label="TRPG ìº˜ë¦°ë”"></div>
    </div>
  </div>

<!-- ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸: ë°˜ë“œì‹œ toastuiReadyë¥¼ ê¸°ë‹¤ë¦° ë’¤ ì‹œì‘ -->
<script>
  function getProjectHome(){
    const seg = location.pathname.split('/').filter(Boolean);
    return seg.length >= 1 ? '/' + seg[0] + '/' : '/';
  }
  const HOME_URL = getProjectHome();

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('home').onclick = () => location.href = HOME_URL;
    document.getElementById('back').onclick = () => (history.length > 1 ? history.back() : location.href = HOME_URL);

    window.addEventListener('keydown', (e) => {
      if (e.target && /input|textarea|select/i.test(e.target.tagName)) return;
      if (/^[hH]$/.test(e.key)) { e.preventDefault(); location.href = HOME_URL; }
      if (/^[bB]$/.test(e.key)) { e.preventDefault(); history.length > 1 ? history.back() : location.href = HOME_URL; }
    });

    // ğŸ‘‰ ì—¬ê¸°ì„œ ë¡œë”ë¥¼ ë°˜ë“œì‹œ ê¸°ë‹¤ë¦¼
    window.toastuiReady.then((ok) => {
      if (!ok || !window.toastui || !toastui.Calendar){
        const m = 'âš ï¸ ìº˜ë¦°ë” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì–´ë–¤ CDN/ë¡œì»¬ì—ì„œë„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ì‚¬ë‚´ë§ì´ë©´ cdn.jsdelivr.net / unpkg.com í—ˆìš© ë˜ëŠ” <code>schedule/vendor/toastui/</code>ì— íŒŒì¼ì„ ë„£ì–´ì£¼ì„¸ìš”.';
        (document.getElementById('cal')||document.body).innerHTML = m;
        console.error('Error: ToastUI not available after load attempts');
        return;
      }

      const cal = new toastui.Calendar('#cal', {
        defaultView:'month',
        theme:{
          common:{ backgroundColor:'transparent',
                   gridSelection:{ backgroundColor:'rgba(76,141,169,.14)', border:'1px solid rgba(76,141,169,.45)' },
                   saturday:{ color:'#9fc7d6' }, dayName:{ color:'#a8bcc6' }, today:{ color:'#86d2c7' } },
          month:{ dayName:{ backgroundColor:'rgba(255,255,255,.06)' },
                  dayCell:{ borderLeft:'1px solid var(--line)', borderBottom:'1px solid var(--line)' },
                  weekend:{ backgroundColor:'transparent' }, today:{ color:'#86d2c7' } },
          week:{ dayName:{ backgroundColor:'rgba(255,255,255,.06)', borderBottom:'1px solid var(--line)' },
                 nowIndicatorPast:{ border:'1px solid var(--brand)' },
                 nowIndicatorBullet:{ backgroundColor:'var(--brand)' },
                 nowIndicatorToday:{ border:'1px solid var(--brand)' } },
        },
        usageStatistics:false,
        month:{ startDayOfWeek:1 },
        week:{ startDayOfWeek:1, hourStart:8, hourEnd:24 },
        calendars:[
          { id:'session', name:'ì„¸ì…˜', color:'#0b1519', backgroundColor:'#4C8DA9' },
          { id:'prep',    name:'í”„ë ™',  color:'#0b1519', backgroundColor:'#86D2C7' },
          { id:'off',     name:'íœ´ì‹',  color:'#0b1519', backgroundColor:'#6AA3B8' }
        ],
      });

      // ë·° ì „í™˜ / ë„¤ë¹„
      const btns = document.querySelectorAll('[data-view]');
      const setView = v => { btns.forEach(b=>b.setAttribute('aria-pressed', String(b.dataset.view===v))); cal.changeView(v,true); };
      btns.forEach(b => b.addEventListener('click', () => setView(b.dataset.view)));
      document.getElementById('prev').onclick  = () => cal.prev();
      document.getElementById('next').onclick  = () => cal.next();
      document.getElementById('today').onclick = () => cal.today();

      // ===== JSON ë¶ˆëŸ¬ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸° + ë¹ ë¥¸ ì¶”ê°€ =====
      async function loadFromRepo() {
        const url = new URL('events.json', location.href); url.searchParams.set('v', Date.now());
        try{
          const res = await fetch(url.toString(), { cache:'no-store' });
          if (!res.ok) throw new Error('HTTP '+res.status);
          const raw = await res.json();
          const data = raw.map(e=>({ ...e, start: e.start?new Date(e.start):null, end: e.end?new Date(e.end):null }));
          cal.clear?.(); cal.createEvents?.(data);
        }catch(err){
          console.warn('events.json ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('âš ï¸ events.jsonì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\níŒŒì¼ì´ ìˆëŠ”ì§€, ê²½ë¡œê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        }
      }
      const serialize = () => cal.getEvents().map(e=>({
        id:e.id, calendarId:e.calendarId, title:e.title||'',
        start:e.start?new Date(e.start).toISOString():null,
        end:e.end?new Date(e.end).toISOString():null,
        category:e.category || (e.isAllday?'allday':'time'),
      }));
      const downloadJSON = (filename, dataObj) => {
        const blob = new Blob([JSON.stringify(dataObj,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a');
        a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };
      async function quickAdd(){
        const title = prompt('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„¸ì…˜ Ep.03)'); if (!title) return;
        const startStr = prompt('ì‹œì‘ (ì˜ˆ: 2025-09-22 19:30 ë˜ëŠ” 2025-09-22)'); if (!startStr) return;
        const endStr = prompt('ë (ì˜ˆ: 2025-09-22 22:30 / ì¢…ì¼ì´ë©´ ë¹„ì›Œë‘ê¸°)', '');
        const parseDT = s => !s ? null : (/\d{2}:\d{2}/.test(s) ? new Date(s.replace(' ','T')+':00') : new Date(s));
        const start=parseDT(startStr), end=endStr?parseDT(endStr):null, allday = !/\d{2}:\d{2}/.test(startStr) && !endStr;
        cal.createEvents?.([{
          id:crypto.randomUUID(), calendarId:'session', title, start,
          end: end || (allday?start:new Date(start.getTime()+2*60*60*1000)), category:allday?'allday':'time'
        }]);
        localStorage.setItem('events:autosave', JSON.stringify(serialize()));
        if (confirm('ì¶”ê°€ ì™„ë£Œ! ì§€ê¸ˆ ë‚´ë³´ë‚´ê¸°(ë‹¤ìš´ë¡œë“œ) í• ê¹Œìš”?')) downloadJSON('events.json', serialize());
      }

      document.getElementById('reload-json').onclick = () => loadFromRepo();
      document.getElementById('export-json').onclick = () => {
        downloadJSON('events.json', serialize());
        alert('events.jsonì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.\në¦¬í¬ì˜ schedule/events.jsonì— ì—…ë¡œë“œ/ì»¤ë°‹í•˜ì„¸ìš”.');
      };
      document.getElementById('quick-add').onclick = () => quickAdd();

      // ìë™ ì„ì‹œ ì €ì¥(ë‚´ ë¸Œë¼ìš°ì €)
      const autosaved = localStorage.getItem('events:autosave');
      if (autosaved){
        try{
          const data = JSON.parse(autosaved).map(e=>({ ...e, start:e.start?new Date(e.start):null, end:e.end?new Date(e.end):null }));
          if (data.length) cal.createEvents?.(data);
        }catch{}
      }
      const save = () => localStorage.setItem('events:autosave', JSON.stringify(serialize()));
      cal.on?.('afterCreateEvent', save);
      cal.on?.('afterUpdateEvent', save);
      cal.on?.('afterDeleteEvent', save);

      // ìµœì´ˆ í•œ ë²ˆ repoì—ì„œ ë¡œë“œ(ìˆìœ¼ë©´)
      loadFromRepo();
    }); // end toastuiReady
  });
</script>
</body>
</html>
