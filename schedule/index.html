<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Schedule</title>

<!-- 1) Toast UI Calendar CSS (v2.1.3) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.css">

<!-- 2) Popup용 Date/Time picker CSS (필수) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.5/dist/tui-time-picker.min.css">

<style>
  :root{
    /* 라이트 기본값 */
    --cal-bg: #ffffff;
    --cal-fg: #0f1720;
    --cal-grid: #e5e7eb;
    --cal-subgrid: #f2f4f7;
    --toolbar-bg: #0f1720;
    --toolbar-fg: #e8f0f3;
  }
  [data-theme="dark"]{
    --cal-bg: #0b1217;
    --cal-fg: #e6eef2;
    --cal-grid: #23323c;
    --cal-subgrid: #16232b;
    --toolbar-bg: #0b1217;
    --toolbar-fg: #dce7ee;
  }
  /* 상단 바 */
  .bar{position:sticky;top:0;z-index:5;display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;background:var(--toolbar-bg);color:var(--toolbar-fg);box-shadow:0 1px 0 rgba(255,255,255,.06) inset}
  .bar button{all:unset;cursor:pointer;border:1px solid rgba(255,255,255,.18);padding:.35rem .6rem;border-radius:.75rem}
  .bar button:hover{background:rgba(255,255,255,.08)}
  .sp{flex:1}
  body{margin:0;background:var(--cal-bg);color:var(--cal-fg);font:14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo","Malgun Gothic","맑은 고딕", sans-serif}

  /* 캘린더 컨테이너 */
  #calendar{height:calc(100vh - 52px);}

  /* ——— 라이트/다크가 “실제 캘린더 내부”까지 먹도록 최소 셀/그리드 배경과 선만 확실히 오버라이드 ——— */
  #calendar,
  #calendar .toastui-calendar,
  #calendar .toastui-calendar-layout,
  #calendar .toastui-calendar-panel,
  #calendar .toastui-calendar-month,
  #calendar .toastui-calendar-week,
  #calendar .toastui-calendar-day,
  #calendar .toastui-calendar-timegrid,
  #calendar .toastui-calendar-daygrid,
  #calendar .toastui-calendar-allday,
  #calendar .toastui-calendar-grid {
    background: var(--cal-bg) !important;
    color: var(--cal-fg) !important;
  }
  /* 격자선/테두리 */
  #calendar .toastui-calendar-gridline,
  #calendar .toastui-calendar-grid-cell,
  #calendar .toastui-calendar-dayname,
  #calendar .toastui-calendar-panel>.toastui-calendar-panel:not(.toastui-calendar-panel--resizer) {
    border-color: var(--cal-grid) !important;
  }
  /* 시간 그리드의 옅은 보조선 */
  #calendar .toastui-calendar-timegrid-hourline,
  #calendar .toastui-calendar-timegrid-halfhourline {
    border-color: var(--cal-subgrid) !important;
  }
</style>
</head>
<body data-theme="dark"><!-- 기본 다크 -->

  <div class="bar">
    <button onclick="history.back()">← 뒤로</button>
    <button onclick="location.href='/'">🏠 메인</button>
    <button onclick="cal.prev()">◀ 이전</button>
    <button onclick="cal.today()">오늘</button>
    <button onclick="cal.next()">다음 ▶</button>
    <div class="sp"></div>
    <button id="view-month">월</button>
    <button id="view-week">주</button>
    <button id="view-day">일</button>
    <button id="compact-toggle">컴팩트</button>
    <button id="theme-toggle">라이트/다크</button>
    <button id="add-btn">+ 새 일정</button>
  </div>

  <div id="calendar"></div>

  <!-- JS: Calendar 본체 + 팝업 의존성 -->
  <script src="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.5/dist/tui-time-picker.min.js"></script>

  <script>
    // UMD 전역 찾기 (환경별 네임스페이스 차이 방지)
    const CalendarCtor = (window.toastui && window.toastui.Calendar) || (window.tui && window.tui.Calendar) || window.Calendar;
    if (!CalendarCtor) {
      alert('캘린더 스크립트를 불러오지 못했습니다.\n(광고 차단기에서 jsDelivr/unpkg 차단해제 필요)');
    }

    // 로컬스토리지 저장/불러오기
    const STORE_KEY = '__tui_events__';
    const loadEvents = () => {
      try { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }
      catch { return []; }
    };
    const saveEvents = (events) => localStorage.setItem(STORE_KEY, JSON.stringify(events));

    // 카테고리(캘린더 그룹)
    const calendars = [
      { id:'personal', name:'개인', backgroundColor:'#22c55e', borderColor:'#22c55e' },
      { id:'project',  name:'프로젝트', backgroundColor:'#3b82f6', borderColor:'#3b82f6' },
      { id:'deadline', name:'마감', backgroundColor:'#ef4444', borderColor:'#ef4444' }
    ];

    // 인스턴스
    const cal = new CalendarCtor('#calendar', {
      defaultView: 'month',
      isReadOnly: false,
      usageStatistics: false,
      calendars,
      // 팝업 활성화 (공식 옵션)
      useFormPopup: true,
      useDetailPopup: true,
      // 그리드 선택(클릭/더블클릭로 범위 선택)
      month: { gridSelection: { enableClick: true, enableDbClick: true } },
      week:  { gridSelection: { enableClick: true, enableDbClick: true }, hourStart: 8, hourEnd: 22 },
    });

    // 초기 데이터 적용
    const seed = loadEvents();
    if (seed.length === 0) {
      const today = new Date();
      const iso = (d)=> d.toISOString().slice(0,19);
      seed.push(
        { id: crypto.randomUUID(), calendarId:'personal', title:'예시 일정', start: iso(new Date(today.getFullYear(), today.getMonth(), today.getDate(), 10, 0)), end: iso(new Date(today.getFullYear(), today.getMonth(), today.getDate(), 11, 0)), category:'time' }
      );
      saveEvents(seed);
    }
    cal.createEvents(seed);

    // ——— 팝업 통해 "저장" 시: 실제 이벤트 생성/갱신/삭제 ———
    cal.on('beforeCreateEvent', (ev) => {
      const evObj = {
        id: crypto.randomUUID(),
        calendarId: ev.calendarId || 'personal',
        title: ev.title || '(제목 없음)',
        start: ev.start.toDate ? ev.start.toDate() : ev.start,
        end:   ev.end.toDate   ? ev.end.toDate()   : ev.end,
        isAllday: !!ev.isAllday,
        category: ev.isAllday ? 'allday' : 'time'
      };
      cal.createEvents([evObj]);

      const all = loadEvents(); all.push({
        ...evObj,
        start: new Date(evObj.start).toISOString(),
        end:   new Date(evObj.end).toISOString()
      });
      saveEvents(all);
    });

    cal.on('beforeUpdateEvent', ({ event, changes }) => {
      cal.updateEvent(event.id, event.calendarId, changes);
      const all = loadEvents().map(e => {
        if (e.id === event.id) {
          return {
            ...e,
            ...changes,
            start: new Date(changes.start ?? e.start).toISOString(),
            end:   new Date(changes.end   ?? e.end).toISOString()
          };
        }
        return e;
      });
      saveEvents(all);
    });

    cal.on('beforeDeleteEvent', ({ id, calendarId }) => {
      cal.deleteEvent(id, calendarId);
      saveEvents(loadEvents().filter(e => !(e.id === id && e.calendarId === calendarId)));
    });

    // ——— 상단 버튼 ———
    document.getElementById('view-month').onclick = () => cal.changeView('month');
    document.getElementById('view-week').onclick  = () => cal.changeView('week');
    document.getElementById('view-day').onclick   = () => cal.changeView('day');

    // 컴팩트(시간 그리드 줄 간격만 조정)
    let compact = false;
    document.getElementById('compact-toggle').onclick = () => {
      compact = !compact;
      document.getElementById('calendar').style.setProperty('--tui-hour-height', compact ? '28px' : '48px');
      // 내부 클래스를 직접 건드리지 않고 시각적 높이만 축소
      const root = document.querySelector('#calendar');
      root.style.setProperty('--tui-hour-font', compact ? '11px' : '12px');
      root.querySelectorAll('.toastui-calendar-timegrid-time').forEach(el=>{
        el.style.fontSize = compact ? '11px' : '12px';
      });
    };

    // 라이트/다크 전환: body data-theme 토글 + 재렌더
    document.getElementById('theme-toggle').onclick = () => {
      const b = document.body;
      b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      cal.render(); // 사이즈 계산 다시
    };

    // “+ 새 일정” 버튼 → 기본 폼 팝업 열기 (API 제공)
    // openFormPopup은 v2에서 공식 메서드입니다. :contentReference[oaicite:1]{index=1}
    document.getElementById('add-btn').onclick = () => {
      const now = new Date();
      cal.openFormPopup({
        title: '',
        start: now,
        end: new Date(now.getTime() + 60*60*1000),
        isAllday: false,
        calendarId: 'personal'
      });
    };
  </script>
</body>
</html>
