<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¼ì • ìº˜ë¦°ë”</title>

  <!-- TOAST UI Calendar v2 CSS/JS (CDN) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
  <style>
    :root { color-scheme: dark light; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:#0d1a1f; color:#e6eef2;
    }
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:.5rem;
      padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.12);
      background:rgba(13,26,31,.85); backdrop-filter: blur(6px) saturate(120%);
    }
    .left, .right { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    button, .btn{
      appearance:none; border:1px solid #334155; background:#0f172a; color:#e6eef2;
      padding:6px 10px; border-radius:10px; cursor:pointer; text-decoration:none; font-size:14px;
    }
    button:hover, .btn:hover{ background:#0b1628 }
    #status{ font-size:.85rem; opacity:.8; border-radius:999px; padding:2px 8px; border:1px solid #334155 }
    #calendar{ height: calc(100vh - 58px); } /* ìº˜ë¦°ë”ëŠ” ë†’ì´ê°€ ê¼­ í•„ìš” */
  </style>
</head>
<body>
  <header>
    <div class="left">
      <button id="btnBack" title="ë’¤ë¡œ (Esc / Backspace)">âŸµ ë’¤ë¡œ</button>
      <a class="btn" id="btnHome" href="../" title="ë©”ì¸ìœ¼ë¡œ (H)">ğŸ  ë©”ì¸</a>
    </div>
    <div class="right">
      <button id="btnPrev">â—€ï¸ ì´ì „</button>
      <button id="btnToday">ì˜¤ëŠ˜</button>
      <button id="btnNext">ë‹¤ìŒ â–¶ï¸</button>

      <button data-view="month">ì›”</button>
      <button data-view="week">ì£¼</button>
      <button data-view="day">ì¼</button>
      <span id="range" style="margin-left:.5rem; opacity:.85"></span>
      <span id="status">ì €ì¥ë¨</span>
    </div>
  </header>

  <div id="calendar"></div>

  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js" defer></script>
  <script>
    // ì•ˆì „ ë¡œë”: CDNì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
      const boot = () => (window.tui && window.tui.Calendar) ? init() : setTimeout(boot, 30);
      boot();
    });

    function init(){
      const { Calendar } = tui;
      const el = document.getElementById('calendar');
      const STORAGE_KEY = 'toastui_v2_events';
      const statusEl = document.getElementById('status');

      const calendar = new Calendar(el, {
        defaultView: 'month',
        usageStatistics: false,
        timezone: { zones: [{ timezoneName: 'Asia/Seoul', displayLabel: 'Seoul' }] },
        useFormPopup: true,
        useDetailPopup: true,
        calendars: [{ id: 'default', name: 'ë‚´ ì¼ì •', backgroundColor: '#4f46e5', borderColor: '#4f46e5' }],
      });

      // ì €ì¥ëœ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
      let state = [];
      try { state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || []; } catch(e){}
      if (state.length) calendar.createEvents(state);

      const setDirty = (txt='ì €ì¥ë¨') => {
        statusEl.textContent = txt;
        if (txt !== 'ì €ì¥ë¨') setTimeout(() => statusEl.textContent = 'ì €ì¥ë¨', 1000);
      };
      const save = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        setDirty('ì €ì¥ ì¤‘â€¦');
      };
      const upsert = (ev) => {
        const i = state.findIndex(x => x.id === ev.id && x.calendarId === ev.calendarId);
        if (i >= 0) state[i] = { ...state[i], ...ev }; else state.push(ev);
      };
      const remove = (id, calendarId) => {
        state = state.filter(x => !(x.id === id && x.calendarId === calendarId));
      };

      // ì´ë²¤íŠ¸ ìƒì„±/ìˆ˜ì •/ì‚­ì œ(ë“œë˜ê·¸, ë”ë¸”í´ë¦­, íŒì—… ë“±)
      calendar.on('beforeCreateEvent', (ev) => {
        const id = String(Date.now()) + Math.random().toString(36).slice(2,7);
        const newEvent = {
          id,
          calendarId: ev.calendarId || 'default',
          title: ev.title || 'ìƒˆ ì¼ì •',
          start: ev.start, end: ev.end,
          isAllday: !!ev.isAllday,
          location: ev.location || '',
          category: ev.isAllday ? 'allday' : 'time',
        };
        calendar.createEvents([newEvent]);
        upsert(newEvent); save();
      });

      calendar.on('beforeUpdateEvent', ({ event, changes }) => {
        calendar.updateEvent(event.id, event.calendarId, changes);
        upsert({ ...event, ...changes }); save();
      });

      calendar.on('beforeDeleteEvent', ({ id, calendarId }) => {
        calendar.deleteEvent(id, calendarId);
        remove(id, calendarId); save();
      });

      // ë²”ìœ„ ë¼ë²¨ & ë‚´ë¹„ê²Œì´ì…˜
      const rangeEl = document.getElementById('range');
      const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const updateRange = () => {
        const s = calendar.getDateRangeStart(); const e = calendar.getDateRangeEnd();
        rangeEl.textContent = `${fmt(s)} ~ ${fmt(e)}`;
      };
      updateRange();

      document.getElementById('btnPrev').addEventListener('click', () => { calendar.prev(); updateRange(); });
      document.getElementById('btnToday').addEventListener('click', () => { calendar.today(); updateRange(); });
      document.getElementById('btnNext').addEventListener('click', () => { calendar.next(); updateRange(); });

      document.querySelectorAll('button[data-view]').forEach(b=>{
        b.addEventListener('click', () => { calendar.changeView(b.dataset.view); updateRange(); });
      });

      // ë’¤ë¡œ/ë©”ì¸
      const goHome = () => location.href = '../';
      const goBack = () => (history.length > 1) ? history.back() : goHome();
      document.getElementById('btnHome').addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });
      document.getElementById('btnBack').addEventListener('click', goBack);

      // ë‹¨ì¶•í‚¤: H=ë©”ì¸, Esc/Backspace=ë’¤ë¡œ, T=ì˜¤ëŠ˜
      window.addEventListener('keydown', (e) => {
        if (e.key === 'h' || e.key === 'H') { e.preventDefault(); goHome(); }
        else if (e.key === 'Escape' || e.key === 'Backspace') { e.preventDefault(); goBack(); }
        else if (e.key.toLowerCase() === 't') { e.preventDefault(); calendar.today(); updateRange(); }
      }, { passive:false });
    }
  </script>
</body>
</html>
