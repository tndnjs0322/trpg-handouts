<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¼ì • ìº˜ë¦°ë”</title>

  <!-- TOAST UI Calendar v2 -->
  <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
  <style>
    :root { color-scheme: dark light; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:#0d1a1f; color:#e6eef2;
    }
    header{
      position:sticky; top:0; z-index:10;
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; gap:.75rem;
      padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.12);
      background:rgba(13,26,31,.85); backdrop-filter: blur(6px) saturate(120%);
    }
    .left, .center, .right { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .center { justify-content:center; }
    .right { justify-content:flex-end; }
    button, .btn, select{
      appearance:none; border:1px solid #334155; background:#0f172a; color:#e6eef2;
      padding:6px 10px; border-radius:10px; cursor:pointer; text-decoration:none; font-size:14px;
    }
    button:hover, .btn:hover, select:hover{ background:#0b1628 }
    #calendar{ height: calc(100vh - 64px); }

    /* ì¹©(í•„í„°) */
    .chips{ display:flex; gap:.4rem; align-items:center; flex-wrap:wrap }
    .chip{
      display:inline-flex; align-items:center; gap:.45rem; padding:6px 10px; border-radius:999px;
      border:1px solid #334155; background:#0f172a; cursor:pointer; user-select:none;
    }
    .dot{ width:10px; height:10px; border-radius:50% }
    .chip input{ appearance:none; width:0; height:0; position:absolute; pointer-events:none }
    .chip[data-on="true"]{ outline:2px solid rgba(255,255,255,.08); background:#0b1628 }

    /* ìƒíƒœ ë±ƒì§€ */
    #status{ font-size:.85rem; opacity:.85; border-radius:999px; padding:2px 8px; border:1px solid #334155 }
    #selectedTitle{ font-size:.85rem; opacity:.85; max-width:28ch; text-overflow:ellipsis; overflow:hidden; white-space:nowrap }

    /* íˆ´ê·¸ë£¹ */
    .group{ display:flex; gap:.4rem; align-items:center; flex-wrap:wrap }
  </style>
</head>
<body>
  <header>
    <!-- ì¢Œì¸¡: ë’¤ë¡œ/ë©”ì¸ + ë²”ìœ„/ë·° -->
    <div class="left group">
      <button id="btnBack" title="ë’¤ë¡œ (Esc/Backspace)">âŸµ ë’¤ë¡œ</button>
      <a class="btn" id="btnHome" href="../" title="ë©”ì¸ìœ¼ë¡œ (H)">ğŸ  ë©”ì¸</a>

      <button id="btnPrev">â—€ï¸</button>
      <button id="btnToday">ì˜¤ëŠ˜</button>
      <button id="btnNext">â–¶ï¸</button>

      <button data-view="month">ì›”</button>
      <button data-view="week">ì£¼</button>
      <button data-view="day">ì¼</button>
    </div>

    <!-- ê°€ìš´ë°: ì¹´í…Œê³ ë¦¬ í† ê¸€ ì¹© -->
    <div class="center chips" id="chips">
      <!-- JSê°€ ì±„ì›€ -->
    </div>

    <!-- ìš°ì¸¡: ìƒˆ ì¼ì • / ìº˜ë¦°ë” ì„ íƒ / ìƒíƒœ -->
    <div class="right group">
      <select id="newCal">
        <option value="personal">ê°œì¸</option>
        <option value="project">í”„ë¡œì íŠ¸</option>
        <option value="deadline">ë§ˆê°</option>
      </select>
      <button id="btnNew">ï¼‹ ìƒˆ ì¼ì •</button>
      <span id="status">ì €ì¥ë¨</span>
      <span id="selectedTitle" title="ì„ íƒëœ ì¼ì • ì—†ìŒ"></span>
      <button id="btnMove" title="ì„ íƒëœ ì¼ì •ì„ ì™¼ìª½ ì½¤ë³´ì— ì§€ì •ëœ ìº˜ë¦°ë”ë¡œ ì´ë™">ì´ë™</button>
    </div>
  </header>

  <div id="calendar"></div>

  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js" defer></script>
  <script>
    // ===== ë¶€íŠ¸ìŠ¤íŠ¸ë© =====
    window.addEventListener('DOMContentLoaded', () => {
      const boot = () => (window.tui && window.tui.Calendar) ? init() : setTimeout(boot, 25);
      boot();
    });

    function init(){
      const { Calendar } = tui;
      const el = document.getElementById('calendar');
      const STORAGE_KEY = 'toastui_v2_events';
      const statusEl = document.getElementById('status');
      const chipsEl = document.getElementById('chips');
      const newCalSel = document.getElementById('newCal');
      const selectedTitleEl = document.getElementById('selectedTitle');

      // 1) ì¹´í…Œê³ ë¦¬ ì •ì˜(ìƒ‰ìƒ/ì´ë¦„)
      const CAL_DEFS = [
        { id:'personal', name:'ê°œì¸',    bg:'#10b981' }, // ì´ˆë¡
        { id:'project',  name:'í”„ë¡œì íŠ¸', bg:'#3b82f6' }, // íŒŒë‘
        { id:'deadline', name:'ë§ˆê°',    bg:'#ef4444' }, // ë¹¨ê°•
      ];

      // 2) ìº˜ë¦°ë” ì¸ìŠ¤í„´ìŠ¤
      const calendar = new Calendar(el, {
        defaultView: 'month',
        usageStatistics: false,
        timezone: { zones: [{ timezoneName:'Asia/Seoul', displayLabel:'Seoul' }] },
        useFormPopup: true,
        useDetailPopup: true,
        calendars: CAL_DEFS.map(c => ({
          id: c.id, name: c.name,
          backgroundColor: c.bg, borderColor: c.bg
        })),
      });

      // 3) ìƒíƒœ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°(+ì´ì „ 'default' â†’ 'personal' ë§ˆì´ê·¸ë ˆì´ì…˜)
      let state = [];
      try { state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || []; } catch(e){}
      state = state.map(e => e.calendarId === 'default' ? { ...e, calendarId:'personal' } : e);

      const save = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        statusEl.textContent = 'ì €ì¥ ì¤‘â€¦';
        setTimeout(() => statusEl.textContent = 'ì €ì¥ë¨', 700);
      };
      const upsert = (ev) => {
        const i = state.findIndex(x => x.id === ev.id && x.calendarId === ev.calendarId);
        if (i >= 0) state[i] = { ...state[i], ...ev }; else state.push(ev);
      };
      const remove = (id, calendarId) => {
        state = state.filter(x => !(x.id === id && x.calendarId === calendarId));
      };

      // 4) í•„í„°(ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°) & ë Œë” ì œì–´
      const visible = new Set(CAL_DEFS.map(c => c.id)); // ì²˜ìŒì—” ëª¨ë‘ on
      const rendered = new Set(); // "id|calendarId" ì§‘í•©
      const keyOf = (e) => `${e.id}|${e.calendarId}`;

      function rerender(){
        const want = state.filter(e => visible.has(e.calendarId));
        // ì§€ìš¸ ê²ƒ
        for (const k of [...rendered]) {
          if (!want.some(e => keyOf(e) === k)) {
            const [id, calId] = k.split('|');
            calendar.deleteEvent(id, calId);
            rendered.delete(k);
          }
        }
        // ì¶”ê°€í•  ê²ƒ
        for (const e of want) {
          const k = keyOf(e);
          if (!rendered.has(k)) {
            calendar.createEvents([e]);
            rendered.add(k);
          }
        }
      }

      // ì²˜ìŒ ë Œë”
      rerender();

      // 5) ì¹© UI êµ¬ì„±
      function makeChip(def){
        const chip = document.createElement('label');
        chip.className = 'chip'; chip.dataset.on = 'true';
        chip.innerHTML = `
          <span class="dot" style="background:${def.bg}"></span>
          <span>${def.name}</span>
          <input type="checkbox" checked>
        `;
        chip.addEventListener('click', (e) => {
          // ë‚´ë¶€ input í´ë¦­ ì´ë²¤íŠ¸ë¡œ ì¤‘ë³µ ë°˜ì‘ ë°©ì§€
          if (e.target.tagName === 'INPUT') return;
          const on = chip.dataset.on !== 'true';
          chip.dataset.on = on ? 'true' : 'false';
          if (on) visible.add(def.id); else visible.delete(def.id);
          rerender();
        });
        return chip;
      }
      CAL_DEFS.forEach(def => chipsEl.appendChild(makeChip(def)));

      // 6) ìƒˆ ì¼ì • ë²„íŠ¼: ì„ íƒëœ ìº˜ë¦°ë”ë¡œ í¼ íŒì—… ì—´ê¸°
      document.getElementById('btnNew').addEventListener('click', () => {
        const calId = newCalSel.value;
        const now = new Date();
        const end = new Date(now.getTime() + 60*60*1000);
        // í¼ íŒì—…ìœ¼ë¡œ ìƒì„±(ì‚¬ìš©ìê°€ ì €ì¥ ëˆ„ë¥´ë©´ beforeCreateEventê°€ í˜¸ì¶œë¨)
        if (calendar.openFormPopup) {
          calendar.openFormPopup({
            start: now, end,
            isAllday: false,
            calendarId: calId,
            title: ''
          });
        } else {
          // í¼ íŒì—…ì´ ë¶ˆê°€í•œ ê²½ìš° ë¹ ë¥¸ ìƒì„±
          const ev = { id: String(Date.now())+Math.random().toString(36).slice(2,7),
            calendarId: calId, title:'ìƒˆ ì¼ì •', start: now, end, category:'time' };
          calendar.createEvents([ev]); upsert(ev); save(); rerender();
        }
      });

      // 7) ì¼ì • ìƒì„±/ìˆ˜ì •/ì‚­ì œ ì´ë²¤íŠ¸
      calendar.on('beforeCreateEvent', (ev) => {
        const id = String(Date.now()) + Math.random().toString(36).slice(2,7);
        const newEvent = {
          id,
          calendarId: ev.calendarId || newCalSel.value || 'personal',
          title: ev.title || 'ìƒˆ ì¼ì •',
          start: ev.start, end: ev.end,
          isAllday: !!ev.isAllday,
          location: ev.location || '',
          category: ev.isAllday ? 'allday' : 'time',
        };
        upsert(newEvent); save(); rerender();
      });

      calendar.on('beforeUpdateEvent', ({ event, changes }) => {
        // calendarId ë³€ê²½ê¹Œì§€ ë°˜ì˜
        const updated = { ...event, ...changes };
        // state: ê¸°ì¡´ í•­ëª© ì œê±° í›„ upsert (calendarId ë°”ë€” ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
        remove(event.id, event.calendarId);
        upsert(updated); save(); rerender();
      });

      calendar.on('beforeDeleteEvent', ({ id, calendarId }) => {
        remove(id, calendarId); save(); rerender();
      });

      // 8) ì„ íƒ/ì´ë™: ì¼ì • í´ë¦­ â†’ ì œëª© í‘œì‹œ â†’ ì´ë™ ë²„íŠ¼ìœ¼ë¡œ ìº˜ë¦°ë” ë³€ê²½
      let selected = null;
      function showSelected(ev){
        selected = ev;
        selectedTitleEl.textContent = ev ? `ì„ íƒ: ${ev.title||'(ì œëª© ì—†ìŒ)'}` : '';
        selectedTitleEl.title = ev?.title || 'ì„ íƒëœ ì¼ì • ì—†ìŒ';
      }
      // v2 ì´ë²¤íŠ¸ëª…: clickEvent
      calendar.on('clickEvent', ({ event }) => { showSelected(event); });

      document.getElementById('btnMove').addEventListener('click', () => {
        if (!selected) return;
        const target = newCalSel.value;
        if (selected.calendarId === target) return;
        // state ê°±ì‹ 
        remove(selected.id, selected.calendarId);
        const moved = { ...selected, calendarId: target };
        upsert(moved); save(); rerender();
        showSelected(moved);
      });

      // 9) ë²”ìœ„/ë·°/ë’¤ë¡œ/ë©”ì¸
      const updateRange = () => {
        // í•„ìš” ì‹œ ë²”ìœ„ í‘œì‹œë¥¼ ì¶”ê°€í•˜ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì— êµ¬í˜„
      };
      document.getElementById('btnPrev').addEventListener('click', () => { calendar.prev(); updateRange(); });
      document.getElementById('btnToday').addEventListener('click', () => { calendar.today(); updateRange(); });
      document.getElementById('btnNext').addEventListener('click', () => { calendar.next(); updateRange(); });
      document.querySelectorAll('button[data-view]').forEach(b=>{
        b.addEventListener('click', () => { calendar.changeView(b.dataset.view); updateRange(); });
      });

      const goHome = () => location.href = '../';
      const goBack = () => (history.length > 1) ? history.back() : goHome();
      document.getElementById('btnHome').addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });
      document.getElementById('btnBack').addEventListener('click', goBack);

      window.addEventListener('keydown', (e) => {
        if (e.key === 'h' || e.key === 'H') { e.preventDefault(); goHome(); }
        else if (e.key === 'Escape' || e.key === 'Backspace') { e.preventDefault(); goBack(); }
        else if (e.key.toLowerCase?.() === 't') { e.preventDefault(); calendar.today(); }
      }, { passive:false });
    }
  </script>
</body>
</html>
