<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>잃어버린 연대기 - 일정 캘린더</title>

<!-- ★ 버전 고정: TUI Calendar v2.1.3 (UMD) + date/time picker -->
<link rel="stylesheet" href="https://uicdn.toast.com/calendar/2.1.3/toastui-calendar.min.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/4.3.3/tui-date-picker.min.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/2.1.5/tui-time-picker.min.css" />

<style>
  /* 라이트/다크 변수 */
  :root{
    --bg:#0b1217; --panel:#0f161c; --ink:#c7d1d9; --muted:#9fb0bd;
    --line:rgba(255,255,255,.10); --line-strong:rgba(255,255,255,.16);
    --today:#10222e; --select:rgba(89,177,255,.20);
    --header:rgba(13,26,31,.9); --btn:#0e1a1f; --btnh:#0b1628;
  }
  :root[data-theme="light"]{
    --bg:#f6f7f9; --panel:#fff; --ink:#27323a; --muted:#51606c;
    --line:rgba(0,0,0,.08); --line-strong:rgba(0,0,0,.14);
    --today:#eef6ff; --select:rgba(42,123,229,.18);
    --header:rgba(255,255,255,.92); --btn:#fff; --btnh:#f3f4f6;
  }
  html{color-scheme:dark}
  :root[data-theme="light"] html{color-scheme:light}

  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  header{
    position:sticky; top:0; z-index:10;
    display:flex; gap:.5rem; align-items:center; justify-content:space-between; flex-wrap:wrap;
    padding:10px 12px; background:var(--header); border-bottom:1px solid var(--line-strong);
    backdrop-filter:blur(6px) saturate(120%);
  }
  .left,.right{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
  button,.btn{
    appearance:none; border:1px solid var(--line-strong); background:var(--btn); color:var(--ink);
    padding:6px 10px; border-radius:10px; cursor:pointer; font-size:14px; text-decoration:none;
  }
  button:hover,.btn:hover{ background:var(--btnh) }
  #range{ color:var(--muted); font-size:.9rem }

  /* 캘린더 박스 높이 보장 */
  #calendar{
    height:calc(100vh - 64px); min-height:680px;
    background:var(--panel); border:1px solid var(--line-strong); border-radius:14px; margin:12px; overflow:hidden;
  }

  /* 캘린더 내부 라이트/다크 오버라이드 */
  #calendar [class^="toastui-calendar-"], #calendar [class*=" toastui-calendar-"]{ color:var(--ink) }
  #calendar .toastui-calendar-panel, #calendar .toastui-calendar-layout,
  #calendar .toastui-calendar-month, #calendar .toastui-calendar-week{ background:var(--panel) }
  #calendar [class*="dayname"]{ background:var(--panel); color:var(--muted); border-color:var(--line-strong)!important }
  #calendar [class*="grid-line"], #calendar [class*="grid-cell"]{ border-color:var(--line)!important }
  #calendar .toastui-calendar-week-today, #calendar .toastui-calendar-month-week-item--today{ background:var(--today) }
  #calendar .toastui-calendar-grid-selection{ background:var(--select)!important }

  /* 컴팩트 */
  :root[data-compact="1"] #calendar{ font-size:13px }
  :root[data-compact="1"] #calendar .toastui-calendar-allday{ min-height:22px }
  :root[data-compact="1"] #calendar [class*="month"] [class*="grid-cell"]{ height:76px; min-height:76px }
</style>
</head>
<body data-theme="dark" data-compact="1">
  <header>
    <div class="left">
      <button id="btnBack">⟵ 뒤로</button>
      <a class="btn" id="btnHome" href="../">🏠 메인</a>
      <button id="btnPrev">◀︎ 이전</button>
      <button id="btnToday">오늘</button>
      <button id="btnNext">다음 ▶︎</button>
      <button data-view="month">월</button>
      <button data-view="week">주</button>
      <button data-view="day">일</button>
    </div>
    <div class="right">
      <button id="btnDensity">컴팩트 끄기</button>
      <button id="btnTheme">라이트로</button>
      <span id="range"></span>
    </div>
  </header>

  <div id="calendar"></div>

  <!-- ★ UMD만 사용: 모듈(import) 쓰지 말 것! (중복 금지) -->
  <script src="https://uicdn.toast.com/tui.date-picker/4.3.3/tui-date-picker.min.js"></script>
  <script src="https://uicdn.toast.com/tui.time-picker/2.1.5/tui-time-picker.min.js"></script>
  <script src="https://uicdn.toast.com/calendar/2.1.3/toastui-calendar.min.js"></script>

  <script>
    // 전역(UMD) 확인: window.toastui.Calendar
    const CalendarGlobal = window.toastui?.Calendar || window.tui?.Calendar;
    if (!CalendarGlobal) {
      alert('캘린더 라이브러리를 불러오지 못했습니다. 네트워크/차단을 확인하세요.');
    } else {
      boot();
    }

    function boot(){
      const el = document.getElementById('calendar');
      let compact = (document.documentElement.dataset.compact === '1');

      const calendar = new CalendarGlobal(el, {
        defaultView: 'month',
        usageStatistics: false,
        useFormPopup: true,
        useDetailPopup: true,
        calendars: [{ id:'default', name:'내 일정' }],
        month: { isAlways6Week:true, startDayOfWeek:1, narrowWeekend:true, visibleEventCount: compact ? 3 : 5 },
        week:  { workweek:true, narrowWeekend:true, showNowIndicator:true, hourStart: compact ? 9 : 8, hourEnd: compact ? 19 : 21 }
      });

      // 로컬 저장
      const KEY='toastui_v2_events';
      let state=[]; try{ state=JSON.parse(localStorage.getItem(KEY)||'[]')||[] }catch(_){}
      if (state.length) calendar.createEvents(state);
      const save=()=>localStorage.setItem(KEY, JSON.stringify(state));
      const upsert=(ev)=>{ const i=state.findIndex(x=>x.id===ev.id&&x.calendarId===ev.calendarId); if(i>=0)state[i]={...state[i],...ev}; else state.push(ev); save(); };
      const remove=(id,calId)=>{ state=state.filter(x=>!(x.id===id&&x.calendarId===calId)); save(); };

      calendar.on('beforeCreateEvent', ev=>{
        const id=String(Date.now())+Math.random().toString(36).slice(2,7);
        const ne={ id, calendarId:ev.calendarId||'default', title:ev.title||'새 일정', start:ev.start, end:ev.end, isAllday:!!ev.isAllday, category: ev.isAllday?'allday':'time' };
        calendar.createEvents([ne]); upsert(ne);
      });
      calendar.on('beforeUpdateEvent', ({event,changes})=>{ calendar.updateEvent(event.id,event.calendarId,changes); upsert({...event,...changes}); });
      calendar.on('beforeDeleteEvent', ({id,calendarId})=>{ calendar.deleteEvent(id,calendarId); remove(id,calendarId); });

      // 범위 표시 & 내비
      const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const range=()=>{ const s=calendar.getDateRangeStart(),e=calendar.getDateRangeEnd(); document.getElementById('range').textContent=`${fmt(s)} ~ ${fmt(e)}`; };
      range();
      btnPrev.onclick = ()=>{ calendar.prev();  range(); };
      btnToday.onclick= ()=>{ calendar.today(); range(); };
      btnNext.onclick = ()=>{ calendar.next();  range(); };
      document.querySelectorAll('button[data-view]').forEach(b=>b.onclick=()=>{ calendar.changeView(b.dataset.view); range(); });

      // 라이트/다크
      btnTheme.onclick=()=>{
        const next=(document.documentElement.dataset.theme==='light')?'dark':'light';
        document.documentElement.dataset.theme=next;
        calendar.render?.();
        btnTheme.textContent = (next==='light')?'다크로':'라이트로';
      };

      // 컴팩트
      btnDensity.onclick=()=>{
        const on = document.documentElement.dataset.compact !== '1';
        document.documentElement.dataset.compact = on ? '1' : '0';
        calendar.setOptions?.({
          month:{ visibleEventCount: on ? 3 : 5 },
          week:{ hourStart: on ? 9 : 8, hourEnd: on ? 19 : 21 }
        });
        calendar.render?.();
        btnDensity.textContent = on ? '컴팩트 끄기' : '컴팩트 켜기';
      };

      // 뒤로/메인
      btnHome.onclick=(e)=>{ e.preventDefault(); location.href='../'; };
      btnBack.onclick=()=>{ history.length>1 ? history.back() : (location.href='../'); };

      // 안전 렌더
      const safe=()=>{ try{ calendar.render(); }catch(_){} };
      addEventListener('load', safe); new ResizeObserver(safe).observe(el);
    }
  </script>
</body>
</html>
