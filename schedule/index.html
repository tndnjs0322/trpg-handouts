<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>일정 캘린더</title>

  <!-- TOAST UI Calendar v2 CSS/JS (CDN) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
  <style>
    :root { color-scheme: dark light; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:#0d1a1f; color:#e6eef2;
    }
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:.5rem;
      padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.12);
      background:rgba(13,26,31,.85); backdrop-filter: blur(6px) saturate(120%);
    }
    .left, .right { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    button, .btn{
      appearance:none; border:1px solid #334155; background:#0f172a; color:#e6eef2;
      padding:6px 10px; border-radius:10px; cursor:pointer; text-decoration:none; font-size:14px;
    }
    button:hover, .btn:hover{ background:#0b1628 }
    #status{ font-size:.85rem; opacity:.8; border-radius:999px; padding:2px 8px; border:1px solid #334155 }
    #calendar{ height: calc(100vh - 58px); } /* 캘린더는 높이가 꼭 필요 */
  </style>
</head>
<body>
  <header>
    <div class="left">
      <button id="btnBack" title="뒤로 (Esc / Backspace)">⟵ 뒤로</button>
      <a class="btn" id="btnHome" href="../" title="메인으로 (H)">🏠 메인</a>
    </div>
    <div class="right">
      <button id="btnPrev">◀︎ 이전</button>
      <button id="btnToday">오늘</button>
      <button id="btnNext">다음 ▶︎</button>

      <button data-view="month">월</button>
      <button data-view="week">주</button>
      <button data-view="day">일</button>
      <span id="range" style="margin-left:.5rem; opacity:.85"></span>
      <span id="status">저장됨</span>
    </div>
  </header>

  <div id="calendar"></div>

  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js" defer></script>
  <script>
    // 안전 로더: CDN이 로드되었는지 확인 후 초기화
    window.addEventListener('DOMContentLoaded', () => {
      const boot = () => (window.tui && window.tui.Calendar) ? init() : setTimeout(boot, 30);
      boot();
    });

    function init(){
      const { Calendar } = tui;
      const el = document.getElementById('calendar');
      const STORAGE_KEY = 'toastui_v2_events';
      const statusEl = document.getElementById('status');

      const calendar = new Calendar(el, {
        defaultView: 'month',
        usageStatistics: false,
        timezone: { zones: [{ timezoneName: 'Asia/Seoul', displayLabel: 'Seoul' }] },
        useFormPopup: true,
        useDetailPopup: true,
        calendars: [{ id: 'default', name: '내 일정', backgroundColor: '#4f46e5', borderColor: '#4f46e5' }],
      });

      // 저장된 일정 불러오기
      let state = [];
      try { state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || []; } catch(e){}
      if (state.length) calendar.createEvents(state);

      const setDirty = (txt='저장됨') => {
        statusEl.textContent = txt;
        if (txt !== '저장됨') setTimeout(() => statusEl.textContent = '저장됨', 1000);
      };
      const save = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        setDirty('저장 중…');
      };
      const upsert = (ev) => {
        const i = state.findIndex(x => x.id === ev.id && x.calendarId === ev.calendarId);
        if (i >= 0) state[i] = { ...state[i], ...ev }; else state.push(ev);
      };
      const remove = (id, calendarId) => {
        state = state.filter(x => !(x.id === id && x.calendarId === calendarId));
      };

      // 이벤트 생성/수정/삭제(드래그, 더블클릭, 팝업 등)
      calendar.on('beforeCreateEvent', (ev) => {
        const id = String(Date.now()) + Math.random().toString(36).slice(2,7);
        const newEvent = {
          id,
          calendarId: ev.calendarId || 'default',
          title: ev.title || '새 일정',
          start: ev.start, end: ev.end,
          isAllday: !!ev.isAllday,
          location: ev.location || '',
          category: ev.isAllday ? 'allday' : 'time',
        };
        calendar.createEvents([newEvent]);
        upsert(newEvent); save();
      });

      calendar.on('beforeUpdateEvent', ({ event, changes }) => {
        calendar.updateEvent(event.id, event.calendarId, changes);
        upsert({ ...event, ...changes }); save();
      });

      calendar.on('beforeDeleteEvent', ({ id, calendarId }) => {
        calendar.deleteEvent(id, calendarId);
        remove(id, calendarId); save();
      });

      // 범위 라벨 & 내비게이션
      const rangeEl = document.getElementById('range');
      const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const updateRange = () => {
        const s = calendar.getDateRangeStart(); const e = calendar.getDateRangeEnd();
        rangeEl.textContent = `${fmt(s)} ~ ${fmt(e)}`;
      };
      updateRange();

      document.getElementById('btnPrev').addEventListener('click', () => { calendar.prev(); updateRange(); });
      document.getElementById('btnToday').addEventListener('click', () => { calendar.today(); updateRange(); });
      document.getElementById('btnNext').addEventListener('click', () => { calendar.next(); updateRange(); });

      document.querySelectorAll('button[data-view]').forEach(b=>{
        b.addEventListener('click', () => { calendar.changeView(b.dataset.view); updateRange(); });
      });

      // 뒤로/메인
      const goHome = () => location.href = '../';
      const goBack = () => (history.length > 1) ? history.back() : goHome();
      document.getElementById('btnHome').addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });
      document.getElementById('btnBack').addEventListener('click', goBack);

      // 단축키: H=메인, Esc/Backspace=뒤로, T=오늘
      window.addEventListener('keydown', (e) => {
        if (e.key === 'h' || e.key === 'H') { e.preventDefault(); goHome(); }
        else if (e.key === 'Escape' || e.key === 'Backspace') { e.preventDefault(); goBack(); }
        else if (e.key.toLowerCase() === 't') { e.preventDefault(); calendar.today(); updateRange(); }
      }, { passive:false });
    }
  </script>
</body>
</html>
