<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë„¤ë²„ì—”ë”© í¬íˆ´ë£¨ 1í˜¸ì  ì¼ì • ìº˜ë¦°ë”</title>

<!-- FullCalendar -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/locales-all.global.min.js"></script>

<style>
  :root{
    --bg:#0c171b; --card:#0b1220; --line:#20304f; --text:#e6eef2; --muted:#a6b3c2;
    --accent:#58a6ff; --danger:#ff6b6b; --ok:#57d19a;

    /* ìº˜ë¦°ë” í”„ë ˆì„/íŒ¨ë”© */
    --cal-pad-top: 8px;
    --cal-pad-right: 14px;
    --cal-pad-bottom: 14px;
    --cal-pad-left: 12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Arial;
    color:var(--text); background: radial-gradient(1200px 600px at 20% 0%, #0f2530 0%, transparent 60%),
                        radial-gradient(1200px 600px at 100% 20%, #101e2a 0%, transparent 60%),
                        var(--bg);
  }

  .wrap{max-width:min(1680px, 96vw); margin:22px auto; padding:0 12px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  .title{font-weight:700; font-size:18px}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .btn{appearance:none; border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff; border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer}
  .btn:hover{border-color:#38507d}
  .btn-danger{border-color:#5a2a2a; background:#2a1111}
  .btn-danger:hover{border-color:#7d3838}
  .chip{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #334357; background:#0b1526; color:#cfe2ff}

  .grid{display:grid; gap:16px; grid-template-columns:minmax(860px,1.8fr) minmax(420px,1fr)}
  @media (max-width:1200px){ .grid{ grid-template-columns:1fr } }

  .panel{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 18%) , var(--card);
    border:1px solid var(--line); border-radius:16px; overflow:hidden;
    height:calc(100vh - 150px); min-height:620px; box-shadow:0 8px 50px rgba(0,0,0,.25)}
  /* ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ */
  #calendar{
    position: relative;
    height:100%;
    padding: var(--cal-pad-top) var(--cal-pad-right) var(--cal-pad-bottom) var(--cal-pad-left) !important;
  }

  /* ì›”/ì—° ì´ë™ ë°” */
  .navbar{display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--line); background:#0b1220}
  .navbtn{border:1px solid #2a3a58; background:#0c1526; border-radius:8px; color:#cfe2ff; padding:6px 8px; cursor:pointer; font-size:12px}
  .navlabel{min-width:120px; text-align:center; font-weight:700}
  select.year, select.month{background:#0c1526; color:#e6eef2; border:1px solid #2a3a58; border-radius:8px; padding:6px 8px; font-size:12px}

  aside{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px;
    min-height:620px; height:calc(100vh - 150px); overflow:auto; box-shadow:0 8px 50px rgba(0,0,0,.25)}
  #detail.collapsed #card{display:none}
  #detail.collapsed #rail{display:grid}
  #detail:not(.collapsed) #rail{display:none}

  .card{background:#0c1526; border:1px solid #213254; border-radius:14px; padding:12px}
  .card + .card{margin-top:12px}
  .card h3{margin:0 0 8px; font-size:14px; letter-spacing:.2px}
  .muted{color:var(--muted); font-size:13px}

  .list{margin:0; padding:0; list-style:none; display:grid; gap:8px}
  .li{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
    padding:8px; border:1px solid #213254; background:#0b1220; border-radius:12px}
  .li .dot{width:8px; height:8px; border-radius:50%}
  .li .title{font-size:13px; font-weight:600}
  .li .sub{font-size:12px; color:#a6b3c2}
  .li .mini-btn{border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff; border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer}
  .li .mini-btn:hover{border-color:#38507d}

  .evt-img{width:100%; height:160px; object-fit:cover; border-radius:10px; background:#09121f; margin-bottom:8px}
  .evt-time{font-size:12px; opacity:.85; margin:6px 0}
  .progress{height:8px; background:#122036; border-radius:6px; overflow:hidden}
  .bar{height:100%; width:0%; background:var(--accent)}
  .hint{font-size:12px; opacity:.85}
  .row{display:grid; grid-template-columns:1fr; gap:8px}
  @media (min-width:1400px){ .row{ grid-template-columns:1fr 1fr } }
  .row>*{min-width:0}
  input[type="text"], input[type="url"], input[type="datetime-local"], textarea, select{
    width:100%; padding:10px; border:1px solid #2a3a58; border-radius:10px; background:#0c1526; color:#e6eef2; font-size:14px}
  textarea{min-height:100px; resize:vertical}

  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip-cat{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
    border:1px solid #2a3a58; background:#0b1526; color:#cfe2ff; font-size:12px; cursor:pointer}
  .chip-cat .dot{width:8px; height:8px; border-radius:50%}
  .chip-cat.active{outline:2px solid #35507d}

  /* ê³µìš© ëª¨ë‹¬ */
  .qback{position:fixed; inset:0; display:none; align-items:flex-start; justify-content:flex-start; background:transparent; z-index:9999}
  .qpop{position:absolute; width:min(540px, calc(100vw - 24px)); background:#0b1220; border:1px solid #1e2a41; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.45); padding:12px}
  .qrow{display:grid; grid-template-columns:1fr; gap:8px; margin-top:6px}
  .qrow2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .qtitle{width:100%; padding:10px; border:1px solid #2a3a58; border-radius:10px; background:#0c1526; color:#e6eef2; font-size:14px}
  .qsub{font-size:12px; color:#a6b3c2}
  .qactions{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
  .qpop .btn{padding:8px 10px}
  .qtoggle{display:flex; align-items:center; gap:8px}
  .qtoggle input{accent-color:#58a6ff}

  /* ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ì */
  .cat-row{display:grid; grid-template-columns:1fr 120px 110px auto auto auto; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed #233352}
  .cat-row:last-child{border-bottom:none}
  .pill{font-size:12px; padding:8px; background:#0c1526; border:1px solid #2a3a58; border-radius:8px}
  .color-hex{width:110px; padding:8px; border:1px solid #2a3a58; border-radius:8px; background:#0c1526; color:#e6eef2}
  .ico-btn{border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff; border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer}
  .ico-btn:hover{border-color:#38507d}

  /* ê³µíœ´ì¼ ë°°ê²½ */
  .fc .fc-bg-event.holiday{background:rgba(255,107,107,.14)}

  /* â”€â”€ ì„  ì˜ë¦¼ ë°©ì§€: ë‚´ë¶€ í…Œë‘ë¦¬ ì œê±° + ì˜¤ë²„ë ˆì´ í”„ë ˆì„ â”€â”€ */
  #calendar .fc-scrollgrid{
    border: 0 !important;
    border-radius: 12px !important;
    overflow: hidden;
    margin: 0 !important;
    background-clip: padding-box;
  }
  #calendar::after{
    content:"";
    position:absolute;
    left:  var(--cal-pad-left);
    top:   var(--cal-pad-top);
    right: var(--cal-pad-right);
    bottom:var(--cal-pad-bottom);
    border:1px solid var(--line);
    border-radius:12px;
    pointer-events:none;
  }
  .fc-theme-standard td,
  .fc-theme-standard th{ border-color: var(--line) !important; }
  .fc .fc-timegrid-slot,
  .fc .fc-timegrid-axis{ border-color: var(--line) !important; }
  .fc .fc-daygrid-day-frame{ transform: translateZ(0); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">ìº í˜ì¸ ì¼ì • <span id="dirty" class="muted"></span></div>
    <div class="actions">
      <button class="btn" id="btnMonth">ì›”ê°„</button>
      <button class="btn" id="btnWeek">ì£¼ê°„</button>
      <button class="btn" id="btnList">ë¦¬ìŠ¤íŠ¸</button>
      <button class="btn" id="btnToday">ì˜¤ëŠ˜</button>
      <button class="btn" id="btnNew">ìƒˆ ì¼ì •</button>
      <button class="btn btn-danger" id="btnDel">ì„ íƒ ì‚­ì œ</button>
      <button class="btn" id="btnSave">GitHubë¡œ ì €ì¥</button>
      <button class="btn" id="btnBack">ë’¤ë¡œ</button>
    </div>
  </header>

  <div class="grid">
    <div class="panel">
      <!-- ì›”/ì—° ë‚´ë¹„ -->
      <div class="navbar">
        <button class="navbtn" id="navPrevYear">â‰ª</button>
        <button class="navbtn" id="navPrevMonth">â€¹</button>
        <div class="navlabel" id="lblYM">YYYY.MM</div>
        <button class="navbtn" id="navNextMonth">â€º</button>
        <button class="navbtn" id="navNextYear">â‰«</button>
        <div style="margin-left:auto; display:flex; align-items:center; gap:6px">
          <select id="selYear" class="year"></select>
          <select id="selMonth" class="month"></select>
          <button class="navbtn" id="navJump">ì´ë™</button>
        </div>
      </div>
      <div id="calendar"></div>
    </div>

    <aside id="detail" class="collapsed">
      <div id="rail">
        <div class="card">
          <h3>ì˜¤ëŠ˜</h3>
          <div id="todayLine" class="muted"></div>
          <div style="display:flex; gap:8px; margin-top:10px">
            <button class="btn" id="btnQuickToday">ì˜¤ëŠ˜ 20:00ë¡œ</button>
            <span class="chip" id="chipNow"></span>
          </div>
        </div>

        <div class="card">
          <h3>ì¹´í…Œê³ ë¦¬</h3>
          <div id="cats" class="chips"></div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="btn" id="btnCatReset">ì „ì²´ ë³´ê¸°</button>
            <button class="btn" id="btnCatManage">ìƒ‰/ëª©ë¡ ê´€ë¦¬</button>
          </div>
        </div>

        <div class="card">
          <h3>ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</h3>
          <ul id="upcoming" class="list"></ul>
        </div>
        <div class="card">
          <h3>ì´ë‹¬ í†µê³„</h3>
          <div class="muted" id="statsMonth">ì´ë‹¬ ì¼ì • 0ê±´</div>
        </div>
      </div>

      <!-- ìƒì„¸ íŒ¨ë„ -->
      <div id="card" style="display:none">
        <img id="evtImg" class="evt-img" alt="" />
        <div class="row">
          <div>
            <div class="hint">ì œëª©</div>
            <input id="fTitle" type="text" placeholder="ì œëª©" />
          </div>
          <div>
            <div class="hint">ìƒíƒœ</div>
            <select id="fStatus">
              <option value="">(ì„ íƒ)</option>
              <option value="planned">planned</option>
              <option value="ongoing">ongoing</option>
              <option value="done">done</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div>
            <div class="hint">ì¹´í…Œê³ ë¦¬</div>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="fCat" type="text" list="catlist2" placeholder="ì˜ˆ: CoC 7e / ë£°: ì „íˆ¬" />
              <input id="fCatColor" type="color" title="ì¹´í…Œê³ ë¦¬ ìƒ‰" />
            </div>
            <datalist id="catlist2"></datalist>
          </div>
          <div>
            <div class="hint">ì´ë¯¸ì§€ URL</div>
            <input id="fImage" type="url" placeholder="https://..." />
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div>
            <div class="hint">ì‹œì‘</div>
            <input id="fStart" type="datetime-local" />
          </div>
          <div>
            <div class="hint">ì¢…ë£Œ</div>
            <input id="fEnd" type="datetime-local" />
          </div>
        </div>
        <div style="margin-top:6px">
          <div class="hint">ì„¤ëª…</div>
          <textarea id="fDesc" placeholder="ì„¸ë¶€ ë‚´ìš©/ë§í¬/ë©”ëª¨ ë“±"></textarea>
        </div>
        <div class="evt-time" id="evtTime"></div>
        <div class="progress"><div id="evtProg" class="bar"></div></div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button class="btn" id="btnApply">ë³€ê²½ ì ìš©</button>
          <button class="btn btn-danger" id="btnDel2">ì‚­ì œ</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- í€µ í¸ì§‘ íŒì—… -->
<div class="qback" id="qback" aria-hidden="true">
  <div class="qpop" id="qpop" role="dialog" aria-modal="true">
    <input id="qTitle" class="qtitle" type="text" placeholder="ì œëª© ë° ì‹œê°„ ì¶”ê°€" />
    <div class="qrow qtoggle">
      <label><input id="qAllDay" type="checkbox" /> í•˜ë£¨ ì¢…ì¼</label>
      <label><input id="qAddTime" type="checkbox" /> ì‹œê°„ ì¶”ê°€</label>
      <span class="qsub" id="qWhenText"></span>
    </div>
    <div class="qrow">
      <div class="qsub">ì¹´í…Œê³ ë¦¬</div>
      <div style="display:flex; gap:8px; align-items:center">
        <input id="qCat" type="text" list="catlist" placeholder="ì˜ˆ: CoC 7e / ë£°: ë§ˆë²• / ì„¸ì…˜" />
        <input id="qCatColor" type="color" title="ì¹´í…Œê³ ë¦¬ ìƒ‰" />
      </div>
      <datalist id="catlist"></datalist>
    </div>
    <div class="qrow2" id="qDates">
      <div>
        <div class="qsub">ì‹œì‘</div>
        <input id="qStartDate" type="date" />
      </div>
      <div>
        <div class="qsub">ì¢…ë£Œ</div>
        <input id="qEndDate" type="date" />
      </div>
    </div>
    <div class="qrow2" id="qTimes" style="display:none">
      <div>
        <div class="qsub">ì‹œì‘ ì‹œê°„</div>
        <input id="qStartTime" type="time" value="20:00" />
      </div>
      <div>
        <div class="qsub">ì¢…ë£Œ ì‹œê°„</div>
        <input id="qEndTime" type="time" value="22:00" />
      </div>
    </div>
    <div class="qactions">
      <button class="btn" id="qMore">ìì„¸íˆ</button>
      <button class="btn" id="qSave">ì €ì¥</button>
      <button class="btn" id="qCancel">ì·¨ì†Œ</button>
      <button class="btn btn-danger" id="qDelete" style="display:none">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ì íŒì—… -->
<div class="qback" id="catBack" aria-hidden="true">
  <div class="qpop" id="catPop" role="dialog" aria-modal="true" style="width:min(760px, calc(100vw - 24px))">
    <h3 style="margin:0 0 6px">ì¹´í…Œê³ ë¦¬ ìƒ‰/ëª©ë¡ ê´€ë¦¬</h3>
    <div class="qsub">HEX(#RRGGBB) ì§ì ‘ ì…ë ¥ ê°€ëŠ¥. <span id="pickSupport"></span></div>
    <div id="catList" class="qrow" style="max-height:min(60vh,520px); overflow:auto; border:1px solid #1e2a41; border-radius:10px; padding:6px"></div>
    <div class="qrow" style="margin-top:8px">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <input id="newCatName" class="qtitle" type="text" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„" style="max-width:320px" />
        <input id="newCatColor" type="color" value="#58a6ff" />
        <input id="newCatHex" class="color-hex" value="#58A6FF" />
        <button class="ico-btn" id="btnAddCat">ì¶”ê°€</button>
      </div>
    </div>
    <div class="qactions">
      <button class="btn" id="catCancel">ë‹«ê¸°</button>
      <button class="btn" id="catSave">ì¹´í…Œê³ ë¦¬ ì €ì¥(GitHub)</button>
    </div>
  </div>
</div>

<script>
(() => {
  /* ===== ì„¤ì • ===== */
  const OWNER  = 'tndnjs0322';
  const REPO   = 'trpg-handouts';
  const BRANCH = 'main';
  const PATH   = 'data/schedule.json';
  const SRC    = '../data/schedule.json';
  const CAT_PATH = 'data/categories.json';
  const CAT_SRC  = '../data/categories.json';
  const HOLI_SRC = '../data/holidays.json';   // ì˜µì…˜(ì—†ì–´ë„ ë¨)
  const HOLI_CAT = 'ê³µíœ´ì¼';

  /* ===== ìƒíƒœ/UI ===== */
  let calendar, selected = null, dirty = false, editingEvent = null;
  let lastPointer = {x: window.innerWidth/2, y: 120};
  let activeCats = new Set();   // ë¹„ë©´ ì „ì²´
  let catColors = {};           // { name: "#RRGGBB" }
  let holidayEvents = [];       // ê³µíœ´ì¼ source

  /* === íˆìŠ¤í† ë¦¬ ìƒíƒœ ê´€ë¦¬(ìº˜ë¦°ë” ë‚´ë¶€ ë’¤ë¡œ/ì•ìœ¼ë¡œ) === */
  let _fcFirstStateSet = false;     // ì²« ìƒíƒœëŠ” replaceState
  let _isPopNavigating  = false;    // popstateë¡œ datesSet push ì–µì œ
  const ymd = (date) => {
    const d = new Date(date), p = n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  };

  /* ===== ìš”ì†Œ ===== */
  const calEl   = document.getElementById('calendar');
  const dirtyEl = document.getElementById('dirty');
  const btnMonth= document.getElementById('btnMonth');
  const btnWeek = document.getElementById('btnWeek');
  const btnList = document.getElementById('btnList');
  const btnToday= document.getElementById('btnToday');
  const btnNew  = document.getElementById('btnNew');
  const btnDel  = document.getElementById('btnDel');
  const btnSave = document.getElementById('btnSave');
  const btnBack = document.getElementById('btnBack');

  const navPrevYear  = document.getElementById('navPrevYear');
  const navPrevMonth = document.getElementById('navPrevMonth');
  const navNextMonth = document.getElementById('navNextMonth');
  const navNextYear  = document.getElementById('navNextYear');
  const lblYM        = document.getElementById('lblYM');
  const selYear      = document.getElementById('selYear');
  const selMonth     = document.getElementById('selMonth');
  const navJump      = document.getElementById('navJump');

  const detail  = document.getElementById('detail');
  const rail    = document.getElementById('rail');
  const catsEl  = document.getElementById('cats');
  const upcomingEl = document.getElementById('upcoming');
  const todayLine = document.getElementById('todayLine');
  const chipNow = document.getElementById('chipNow');
  const statsMonth = document.getElementById('statsMonth');
  const btnQuickToday = document.getElementById('btnQuickToday');
  const btnCatReset   = document.getElementById('btnCatReset');
  const btnCatManage  = document.getElementById('btnCatManage');

  const imgEl   = document.getElementById('evtImg');
  const fTitle  = document.getElementById('fTitle');
  const fStatus = document.getElementById('fStatus');
  const fStart  = document.getElementById('fStart');
  const fEnd    = document.getElementById('fEnd');
  const fImage  = document.getElementById('fImage');
  const fDesc   = document.getElementById('fDesc');
  const fCat    = document.getElementById('fCat');
  const fCatColor = document.getElementById('fCatColor');
  const evtTime = document.getElementById('evtTime');
  const evtProg = document.getElementById('evtProg');
  const btnApply= document.getElementById('btnApply');
  const btnDel2 = document.getElementById('btnDel2');

  // í€µ íŒì—…
  const qback = document.getElementById('qback');
  const qpop  = document.getElementById('qpop');
  const qTitle= document.getElementById('qTitle');
  const qAllDay=document.getElementById('qAllDay');
  const qAddTime=document.getElementById('qAddTime');
  const qWhenText=document.getElementById('qWhenText');
  const qDates=document.getElementById('qDates');
  const qTimes=document.getElementById('qTimes');
  const qStartDate=document.getElementById('qStartDate');
  const qEndDate=document.getElementById('qEndDate');
  const qStartTime=document.getElementById('qStartTime');
  const qEndTime=document.getElementById('qEndTime');
  const qSave=document.getElementById('qSave');
  const qCancel=document.getElementById('qCancel');
  const qDelete=document.getElementById('qDelete');
  const qMore=document.getElementById('qMore');
  const qCat = document.getElementById('qCat');
  const qCatColor = document.getElementById('qCatColor');
  const catlist = document.getElementById('catlist');
  const catlist2 = document.getElementById('catlist2');

  // ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ì
  const catBack = document.getElementById('catBack');
  const catPop  = document.getElementById('catPop');
  const catList = document.getElementById('catList');
  const catCancel = document.getElementById('catCancel');
  const catSaveBtn= document.getElementById('catSave');
  const newCatName= document.getElementById('newCatName');
  const newCatColor= document.getElementById('newCatColor');
  const newCatHex = document.getElementById('newCatHex');
  const btnAddCat = document.getElementById('btnAddCat');
  const pickSupport = document.getElementById('pickSupport');

  /* ===== ê³µí†µ ===== */
  document.addEventListener('pointerdown', e=>{ lastPointer={x:e.clientX,y:e.clientY}; }, {passive:true});
  function markDirty(v=true){ dirty=v; dirtyEl.textContent = v ? 'Â· ìˆ˜ì •ë¨' : ''; }
  window.addEventListener('beforeunload', e=>{ if(dirty){ e.preventDefault(); e.returnValue=''; }});

  /* ===== ë°ì´í„° ë¡œë“œ ===== */
  Promise.all([
    fetch(SRC, { cache:'no-store' }).then(r=>r.ok?r.json():[]).catch(()=>[]),
    fetch(CAT_SRC, { cache:'no-store' }).then(r=>r.ok?r.json():{}).catch(()=>({})),
    fetch(HOLI_SRC,{ cache:'no-store' }).then(r=>r.ok?r.json():[]).catch(()=>[])
  ]).then(([events, colors, holidays])=>{
    catColors = colors || {};
    holidayEvents = Array.isArray(holidays) ? holidaysToEvents(holidays) : [];
    initCalendar(Array.isArray(events)?events:[]);
  });

  /* ===== ìœ í‹¸ ===== */
  const PALETTE = ['#57d19a','#58a6ff','#b08ad6','#ef7d7d','#f6c951','#6adcb3','#96a6ff','#ffb86c','#ff99cc','#8bd3dd','#a5ffd6','#c792ea','#9cdcfe'];
  function catColor(name){
    if (name && catColors[name]) return catColors[name];
    if(!name) return '#8892a6';
    let h=0; for (let i=0;i<name.length;i++) { h=(h<<5)-h+name.charCodeAt(i); h|=0; }
    return PALETTE[Math.abs(h)%PALETTE.length];
  }
  function normalizeHex(s){ if(!s) return null; let v=s.trim().toUpperCase(); if(!v.startsWith('#')) v='#'+v; return /^#[0-9A-F]{6}$/.test(v)?v:null; }
  const pad=n=>n.toString().padStart(2,'0');
  function toLocalInput(dt){ if(!dt) return ''; const d=new Date(dt); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function toKSTISO(dt){ if(!dt) return null; const d=new Date(dt); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}+09:00`; }
  function fromLocalInput(str){ return str? new Date(str.replace('T',' ') + ':00') : null; }
  function fmtKST(d){ return new Date(d).toLocaleString('ko-KR', { timeZone:'Asia/Seoul' }); }
  function isoDate(d){ const x=new Date(d); return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`; }
  function hhmm(d){ const x=new Date(d); return `${pad(x.getHours())}:${pad(x.getMinutes())}`; }
  function parseDateTime(dstr, tstr){ if(!dstr) return null; const s=tstr||'00:00'; return new Date(`${dstr}T${s}:00`); }
  function parseDateOnly(yyyy_mm_dd){ if(!yyyy_mm_dd) return null; const [y,m,d]=yyyy_mm_dd.split('-').map(Number); return new Date(y, m-1, d); }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function escapeHtml(s){ return s==null?'':s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&gt;','>':'&lt;','"':'&quot;', "'":'&#39;' }[c])); }
  function roundToNextHalfHour(d){ const x=new Date(d); x.setSeconds(0,0); const m=x.getMinutes(); x.setMinutes(m<30?30:60); return x; }
  function isYMD(s){ return typeof s==='string' && /^\d{4}-\d{2}-\d{2}$/.test(s); }

  function holidaysToEvents(list){
    const arr=[];
    for (const h of list){
      const s=parseDateOnly(h.date); const e=parseDateOnly(h.end||h.date);
      if(!s||!e) continue;
      const sStr=isoDate(s), eStr=isoDate(addDays(e,1));
      arr.push({ id:`hb-${sStr}`, title:h.title||HOLI_CAT, start:sStr, end:eStr, allDay:true, display:'background', classNames:['holiday'], editable:false, extendedProps:{category:HOLI_CAT}});
      arr.push({ id:`ht-${sStr}`, title:h.title||HOLI_CAT, start:sStr, end:eStr, allDay:true, editable:false, extendedProps:{category:HOLI_CAT}});
    }
    return arr;
  }

  /* ===== ìº˜ë¦°ë” ì„¸íŒ… ===== */
  function toFCEvt(ev){
    const base={ id: ev.id || `e-${Math.random().toString(36).slice(2,8)}`, title: ev.title||'(ì œëª© ì—†ìŒ)',
      extendedProps:{ image:ev.image||'', desc:ev.desc||'', status:ev.status||'', category:ev.category||'' } };
    if(ev.allDay){
      const s=isYMD(ev.start)?ev.start:isoDate(new Date(ev.start));
      const e=ev.end?(isYMD(ev.end)?ev.end:isoDate(new Date(ev.end))):undefined;
      return { ...base, allDay:true, start:s, end:e };
    }
    return { ...base, allDay:false, start:ev.start, end:ev.end };
  }

  function initCalendar(events){
    calendar = new FullCalendar.Calendar(calEl, {
      locale:'ko', timeZone:'Asia/Seoul', height:'100%', initialView:'dayGridMonth', headerToolbar:false,
      progressiveEventRendering:true, editable:true, selectable:true, selectMirror:true,
      events:[...holidayEvents, ...events.map(toFCEvt)],

      datesSet: (info) => {
        updateYMBar(info);
        // íˆìŠ¤í† ë¦¬ì— ë‚´ë¶€ ìƒíƒœë¥¼ ìŒ“ê¸°(ë·°/ë‚ ì§œ)
        if (_isPopNavigating) { _isPopNavigating = false; return; }
        const st = { view: info.view.type, date: ymd(calendar.getDate()) };
        if (_fcFirstStateSet) history.pushState(st, '', '');
        else { history.replaceState(st, '', ''); _fcFirstStateSet = true; }
      },

      dateClick: (info) => openQuick({ anchor:info.jsEvent, start:parseDateOnly(info.dateStr), end:parseDateOnly(info.dateStr), allDay:true, title:'' }),
      select: (info) => {
        const allDay = info.allDay ?? (calendar.view.type==='dayGridMonth');
        const s = allDay ? parseDateOnly(info.startStr) : info.start;
        const e = allDay ? parseDateOnly(info.endStr)   : info.end;
        openQuick({ anchor:null, start:s, end:allDay?addDays(e,-1):e, allDay, title:'' });
        calendar.unselect();
      },
      eventClick: (info) => {
        if (info.event.extendedProps?.category === 'ê³µíœ´ì¼') return;
        openQuick({ anchor:info.jsEvent, start:info.event.start, end:info.event.end||info.event.start,
          allDay:info.event.allDay, title:info.event.title, event:info.event });
      },
      eventDrop:  () => { markDirty(); updatePreview(); renderRail(); },
      eventResize:() => { markDirty(); updatePreview(); renderRail(); },
      eventsSet:  () => { renderRail(); renderCatUI(); },

      eventDidMount: (info) => {
        const cat = info.event.extendedProps?.category || '';
        const col = catColor(cat);
        const dot = info.el.querySelector('.fc-daygrid-event-dot');
        if (dot){ dot.style.borderColor=col; dot.style.backgroundColor=col; }
        info.el.style.borderLeft = `4px solid ${col}`;
      }
    });
    calendar.render();

    // ì²« ìƒíƒœ ì•ˆì „í•˜ê²Œ ì‹¬ê¸°
    (() => {
      const st = { view: calendar.view.type, date: ymd(calendar.getDate()) };
      history.replaceState(st, '', '');
      _fcFirstStateSet = true;
    })();

    // ë¸Œë¼ìš°ì € ë’¤/ì•ìœ¼ë¡œ ë‚´ë¶€ ìƒíƒœ ë³µì›
    window.addEventListener('popstate', (e) => {
      if (!e.state) return;
      _isPopNavigating = true;
      try {
        const { view, date } = e.state;
        if (view && date)      calendar.changeView(view, new Date(date));
        else if (date)         calendar.gotoDate(new Date(date));
        else if (view)         calendar.changeView(view);
      } finally {
        setTimeout(() => { _isPopNavigating = false; }, 0);
      }
    });

    /* ìƒë‹¨ ë²„íŠ¼ */
    btnMonth.onclick = () => calendar.changeView('dayGridMonth');
    btnWeek.onclick  = () => calendar.changeView('timeGridWeek');
    btnList.onclick  = () => calendar.changeView('listMonth');
    btnToday.onclick = () => calendar.today();

    btnNew.onclick   = () => {
      const s = roundToNextHalfHour(new Date());
      openQuick({ anchor:null, start:s, end:new Date(s.getTime()+2*3600*1000), allDay:false, title:'' });
    };
    btnDel.onclick   = () => { if(selected){ if(confirm('ì„ íƒëœ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?')){ selected.remove(); clearDetail(); markDirty(); renderRail(); renderCatUI(); } } else alert('ì„ íƒëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.'); };
    btnDel2.onclick  = () => btnDel.onclick();
    btnSave.onclick  = saveAllToGitHub;

    // â† ì§„ì§œ ë¸Œë¼ìš°ì € ë’¤ë¡œ (ë‚´ë¶€ íˆìŠ¤í† ë¦¬ ë˜ëŒì•„ê°)
    btnBack.addEventListener('click', (e) => { e.preventDefault(); history.back(); });

    btnQuickToday.onclick = () => {
      const base=new Date(); base.setHours(20,0,0,0);
      openQuick({ anchor:null, start:base, end:new Date(base.getTime()+2*3600*1000), allDay:false, title:'' });
    };
    btnCatReset.onclick = () => { activeCats.clear(); applyCategoryFilter(); updateCatChipActive(); };
    btnCatManage.onclick= () => openCatManager();

    /* ì›”/ì—° ë‚´ë¹„ ê¸°ëŠ¥ */
    navPrevYear.onclick  = () => { const d=calendar.getDate(); calendar.gotoDate(new Date(d.getFullYear()-1, d.getMonth(), 1)); };
    navPrevMonth.onclick = () => calendar.prev();
    navNextMonth.onclick = () => calendar.next();
    navNextYear.onclick  = () => { const d=calendar.getDate(); calendar.gotoDate(new Date(d.getFullYear()+1, d.getMonth(), 1)); };
    navJump.onclick = () => { const y=+selYear.value, m=(+selMonth.value)-1; if(y&&m>=0) calendar.gotoDate(new Date(y,m,1)); };

    // ë“œë¡­ë‹¤ìš´ ì˜µì…˜(ì—°: í˜„ì¬-5 ~ +5)
    const curY = new Date().getFullYear();
    for(let y=curY-5; y<=curY+5; y++){ const opt=document.createElement('option'); opt.value=y; opt.textContent=`${y}ë…„`; selYear.appendChild(opt); }
    for(let m=1; m<=12; m++){ const opt=document.createElement('option'); opt.value=m; opt.textContent=`${m}ì›”`; selMonth.appendChild(opt); }

    updateYMBar(); renderRail(); renderCatUI();
  }

  function updateYMBar(){
    const d = calendar.getDate();
    const pad = n => n.toString().padStart(2,'0');
    lblYM.textContent = `${d.getFullYear()}.${pad(d.getMonth()+1)}`;
    selYear.value = d.getFullYear();
    selMonth.value = (d.getMonth()+1);
  }

  /* ===== í€µ íŒì—… ===== */
  function openQuick({anchor, start, end, allDay, title, event=null}){
    editingEvent = event;

    qTitle.value = title || '';
    qAllDay.checked = !!allDay;
    qAddTime.checked = !allDay;

    const s = new Date(start);
    let   e = new Date(end || start);
    if (event && allDay && event.end) e = addDays(event.end, -1);

    if (allDay){
      qTimes.style.display = 'none';
      qStartDate.value = isoDate(s);
      qEndDate.value   = isoDate(e);
    } else {
      qTimes.style.display = '';
      qStartDate.value = isoDate(s);
      qEndDate.value   = isoDate(e);
      qStartTime.value = hhmm(s);
      qEndTime.value   = hhmm(e);
    }
    const catName = event?.extendedProps?.category || '';
    qCat.value = catName;
    qCatColor.value = normalizeHex(catColor(catName)) || '#58A6FF';
    populateCatDatalists();
    updateWhenText();

    const x = anchor?.clientX ?? lastPointer.x;
    const y = anchor?.clientY ?? lastPointer.y;
    const pad = 12, width = Math.min(540, window.innerWidth - 24);
    const left = Math.max(12, Math.min(x + 10, window.innerWidth - width - pad));
    const top  = Math.max(12, Math.min(y - 10, window.innerHeight - 320));
    qpop.style.left = left + 'px';
    qpop.style.top  = top + 'px';

    qDelete.style.display = editingEvent ? '' : 'none';

    qback.style.display = 'flex';
    qback.setAttribute('aria-hidden','false');
    setTimeout(()=> qTitle.focus(), 0);
  }
  function closeQuick(){ qback.style.display='none'; qback.setAttribute('aria-hidden','true'); }
  qCancel.onclick = closeQuick;
  qback.addEventListener('click', e=>{ if(e.target===qback) closeQuick(); });

  qAllDay.addEventListener('change', ()=>{ qAddTime.checked=!qAllDay.checked; qTimes.style.display=qAddTime.checked?'':'none'; updateWhenText(); });
  qAddTime.addEventListener('change', ()=>{ qAllDay.checked=!qAddTime.checked; qTimes.style.display=qAddTime.checked?'':'none';
    if(qAddTime.checked && !qStartTime.value) qStartTime.value='20:00';
    if(qAddTime.checked && !qEndTime.value) qEndTime.value='22:00'; updateWhenText();
  });
  [qStartDate,qEndDate,qStartTime,qEndTime].forEach(el=> el.addEventListener('input', updateWhenText));

  qCat.addEventListener('input', ()=>{ qCatColor.value = normalizeHex(catColor(qCat.value)) || '#58A6FF'; });
  qCatColor.addEventListener('input', ()=>{
    const nm = (qCat.value||'').trim(); const hx = normalizeHex(qCatColor.value); if(nm && hx){ catColors[nm]=hx; refreshEvents(); renderCatUI(); }
  });

  qSave.addEventListener('click', ()=>{
    const title  = qTitle.value.trim() || '(ì œëª© ì—†ìŒ)';
    const allDay = qAllDay.checked;
    const category = qCat.value.trim();
    const chosen = normalizeHex(qCatColor.value); if(category && chosen) catColors[category]=chosen;

    if (allDay){
      const sDay=parseDateOnly(qStartDate.value); const eDay=parseDateOnly(qEndDate.value||qStartDate.value);
      if(!sDay||!eDay) return alert('ë‚ ì§œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      const startStr=isoDate(sDay), endExStr=isoDate(addDays(eDay,1));
      if (editingEvent){
        editingEvent.setAllDay(true); editingEvent.setStart(startStr,{maintainDuration:false}); editingEvent.setEnd(endExStr);
        editingEvent.setExtendedProp('category', category); markDirty(); selectEvent(editingEvent);
      } else {
        calendar.addEvent({ id:`e-${Date.now().toString(36)}`, title, allDay:true, start:startStr, end:endExStr, extendedProps:{category} });
        markDirty();
      }
    }else{
      const s=parseDateTime(qStartDate.value, qStartTime.value||'20:00');
      const e=parseDateTime(qEndDate.value||qStartDate.value, qEndTime.value||'22:00');
      if(!s||!e) return alert('ë‚ ì§œ/ì‹œê°„ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      if(e<=s)   return alert('ì¢…ë£Œê°€ ì‹œì‘ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ì–´ìš”.');
      if (editingEvent){
        editingEvent.setAllDay(false); editingEvent.setStart(s,{maintainDuration:false}); editingEvent.setEnd(e);
        editingEvent.setExtendedProp('category', category); markDirty(); selectEvent(editingEvent);
      }else{
        calendar.addEvent({ id:`e-${Date.now().toString(36)}`, title, allDay:false, start:s, end:e, extendedProps:{category} });
        markDirty();
      }
    }
    closeQuick(); renderRail(); renderCatUI(); applyCategoryFilter(); refreshEvents();
  });

  qDelete.addEventListener('click', ()=>{
    if(!editingEvent) return;
    if(confirm('ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?')){
      editingEvent.remove();
      if(selected && selected.id===editingEvent.id){ clearDetail(); }
      editingEvent=null; markDirty(); closeQuick(); renderRail(); renderCatUI(); applyCategoryFilter(); refreshEvents();
    }
  });
  qMore.addEventListener('click', ()=>{ if(editingEvent){ selectEvent(editingEvent,{expandDetail:true}); } closeQuick(); });

  function updateWhenText(){
    const allDay=qAllDay.checked; const sd=qStartDate.value, ed=qEndDate.value||sd;
    if(!sd){ qWhenText.textContent=''; return; }
    if(allDay){ qWhenText.textContent=`${sd} ~ ${ed} (í•˜ë£¨ ì¢…ì¼)`; }
    else { const st=qStartTime.value||'20:00', et=qEndTime.value||'22:00'; qWhenText.textContent=`${sd} ${st} ~ ${ed} ${et}`; }
  }

  /* ===== ìƒì„¸ íŒ¨ë„ ===== */
  function selectEvent(ev, opts={}){
    selected=ev; if(opts.expandDetail) detail.classList.remove('collapsed');
    rail.style.display='none'; document.getElementById('card').style.display='';
    fTitle.value=ev.title||''; fStatus.value=ev.extendedProps?.status||'';
    fStart.value=toLocalInput(ev.start); fEnd.value=toLocalInput(ev.end||ev.start);
    fImage.value=ev.extendedProps?.image||''; fDesc.value=ev.extendedProps?.desc||'';
    const catName=ev.extendedProps?.category||''; fCat.value=catName; fCatColor.value = normalizeHex(catColor(catName)) || '#58A6FF';
    populateCatDatalists(); updatePreview();
  }
  function clearDetail(){ selected=null; document.getElementById('card').style.display='none'; rail.style.display='grid'; imgEl.removeAttribute('src'); }

  fCat.addEventListener('input', ()=>{ fCatColor.value = normalizeHex(catColor(fCat.value)) || '#58A6FF'; });
  fCatColor.addEventListener('input', ()=>{ const nm=(fCat.value||'').trim(); const hx=normalizeHex(fCatColor.value); if(nm && hx){ catColors[nm]=hx; refreshEvents(); renderCatUI(); } });

  btnApply.onclick = () => {
    if(!selected) return alert('ì„ íƒëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
    const title=fTitle.value.trim(), start=fromLocalInput(fStart.value), end=fromLocalInput(fEnd.value);
    if(!title||!start||!end) return alert('ì œëª©/ì‹œì‘/ì¢…ë£ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
    if(new Date(start) > new Date(end)) return alert('ì¢…ë£Œê°€ ì‹œì‘ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ì–´ìš”.');
    selected.setProp('title', title); selected.setStart(new Date(start)); selected.setEnd(new Date(end));
    selected.setExtendedProp('image', fImage.value.trim()); selected.setExtendedProp('desc', fDesc.value);
    selected.setExtendedProp('status', fStatus.value); selected.setExtendedProp('category', fCat.value.trim());
    const hx=normalizeHex(fCatColor.value); if(fCat.value.trim() && hx) catColors[fCat.value.trim()]=hx;
    updatePreview(); markDirty();
    alert('ì ìš© ì™„ë£Œ(ì„ì‹œ). ìƒë‹¨ "GitHubë¡œ ì €ì¥"ì„ ëˆŒëŸ¬ ì»¤ë°‹í•˜ì„¸ìš”!');
    renderRail(); renderCatUI(); applyCategoryFilter(); refreshEvents();
  };

  function updatePreview(){
    if(!selected) return;
    const p=selected.extendedProps||{};
    if(p.image){ imgEl.src=p.image; imgEl.style.display=''; } else { imgEl.removeAttribute('src'); imgEl.style.display='none'; }
    evtTime.textContent=[selected.start, selected.end||selected.start].filter(Boolean).map(fmtKST).join(' ~ ');
    if(selected.start && (selected.end||selected.start)){
      const now=new Date(), s=new Date(selected.start), e=new Date(selected.end||selected.start);
      if(now<s){ evtProg.style.width='0%'; } else if(now>e){ evtProg.style.width='100%'; }
      else { evtProg.style.width = Math.min(100, Math.max(0, (now-s)/(e-s)*100)).toFixed(0)+'%'; }
    } else { evtProg.style.width='0%'; }
  }

  /* ===== ì¹´í…Œê³ ë¦¬ ===== */
  function catUnion(){
    const set=new Set(Object.keys(catColors));
    calendar?.getEvents().forEach(ev=>{
      const c=(ev.extendedProps?.category||'').trim();
      if(c) set.add(c); else set.add('ë¯¸ë¶„ë¥˜');
    });
    set.delete(''); // ì•ˆì „
    return [...set].sort((a,b)=>a.localeCompare(b,'ko'));
  }

  function renderCatUI(){
    const cats=catUnion();
    catsEl.innerHTML=cats.map(name=>{
      const real = (name==='ë¯¸ë¶„ë¥˜')?'':name;
      const color=catColor(real);
      const active=activeCats.size && activeCats.has(real);
      return `<button class="chip-cat ${active?'active':''}" data-cat="${escapeHtml(real)}">
        <span class="dot" style="background:${color}"></span>${escapeHtml(name)}
      </button>`;
    }).join('');
    catsEl.querySelectorAll('.chip-cat').forEach(btn=>{
      btn.onclick=()=>{ const cat=btn.dataset.cat||''; if(activeCats.has(cat)) activeCats.delete(cat); else activeCats.add(cat); applyCategoryFilter(); updateCatChipActive(); };
    });
    populateCatDatalists();
  }
  function updateCatChipActive(){
    catsEl.querySelectorAll('.chip-cat').forEach(btn=>{
      const cat=btn.dataset.cat||''; btn.classList.toggle('active', activeCats.size && activeCats.has(cat));
    });
  }
  function applyCategoryFilter(){
    const showAll=activeCats.size===0;
    calendar.getEvents().forEach(ev=>{
      const c=(ev.extendedProps?.category||''); ev.setProp('display', showAll || activeCats.has(c) ? 'auto':'none');
    });
    renderRail();
  }
  function populateCatDatalists(){
    const cats=catUnion().filter(v=>v!=='ë¯¸ë¶„ë¥˜');
    catlist.innerHTML=cats.map(c=>`<option value="${escapeHtml(c)}">`).join('');
    catlist2.innerHTML=cats.map(c=>`<option value="${escapeHtml(c)}">`).join('');
  }

  /* ===== ìš”ì•½ ë ˆì¼ ===== */
  function renderRail(){
    const now=new Date(); chipNow.textContent=now.toLocaleString('ko-KR',{timeZone:'Asia/Seoul',hour:'2-digit',minute:'2-digit'});
    const todayStr=isoDate(now);
    const todays=calendar.getEvents().filter(ev=>{
      if(ev.display==='none') return false;
      if(ev.allDay){
        const s=typeof ev.start==='string'?ev.start:isoDate(ev.start);
        const e=typeof ev.end==='string'?ev.end:isoDate(ev.end||addDays(ev.start,1));
        return s<=todayStr && todayStr<e;
      }else{ return isoDate(ev.start)===todayStr; }
    });
    todayLine.textContent=`${todayStr} Â· ì˜¤ëŠ˜ ì¼ì • ${todays.length}ê±´`;

    const list=getUpcoming(6);
    upcomingEl.innerHTML = list.map(({ev,s,e,span})=>{
      const time = ev.allDay ? 'í•˜ë£¨ ì¢…ì¼' : `${pad(s.getHours())}:${pad(s.getMinutes())} ~ ${pad(e.getHours())}:${pad(e.getMinutes())}`;
      const sub  = `${s.getMonth()+1}ì›” ${s.getDate()}ì¼ Â· ${time}${span>1?` Â· ${span}ì¼`:''}`;
      const cat  = (ev.extendedProps?.category||''); const col=catColor(cat);
      return `<li class="li">
        <span class="dot" style="background:${col}"></span>
        <div><div class="title">${escapeHtml(ev.title||'(ì œëª© ì—†ìŒ)')}</div><div class="sub">${escapeHtml(cat||'ë¯¸ë¶„ë¥˜')} Â· ${sub}</div></div>
        <button class="mini-btn act" data-id="${ev.id}">ì—´ê¸°</button>
      </li>`;
    }).join('') || `<div class="muted">ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    upcomingEl.querySelectorAll('.mini-btn').forEach(btn=>{
      btn.onclick=()=>{ const ev=calendar.getEventById(btn.dataset.id); if(ev){ selectEvent(ev,{expandDetail:true}); calendar.gotoDate(ev.start); } };
    });

    const cur=calendar.getDate(); const mStart=new Date(cur.getFullYear(), cur.getMonth(), 1); const mEnd=new Date(cur.getFullYear(), cur.getMonth()+1, 1);
    const monthCount=calendar.getEvents().filter(ev=>ev.display!=='none' && ev.start>=mStart && ev.start<mEnd).length;
    statsMonth.textContent = `${cur.getMonth()+1}ì›” ì¼ì • ${monthCount}ê±´`;
  }
  function getUpcoming(limit=6){
    const now=new Date();
    return calendar.getEvents()
      .filter(ev=>ev.display!=='none' && ev.extendedProps?.category !== 'ê³µíœ´ì¼')
      .map(ev=>{
        let s = ev.allDay ? (typeof ev.start==='string'?parseDateOnly(ev.start):new Date(ev.start)) : new Date(ev.start);
        let e = ev.allDay ? (typeof ev.end==='string'?parseDateOnly(ev.end):new Date(ev.end||ev.start)) : new Date(ev.end||ev.start);
        if(ev.allDay) e=addDays(e,-1);
        return { ev, s, e, span: Math.max(1, Math.round((e-s)/(24*3600*1000))+1) };
      })
      .filter(o=>o.e>=now).sort((a,b)=>a.s-b.s).slice(0,limit);
  }

  /* ===== ì €ì¥(GitHub) ===== */
  async function saveAllToGitHub(){
    try{
      const token=prompt('GitHub Personal Access Token(ë ˆí¬ Contents:write ê¶Œí•œ):'); if(!token) return;
      const eventsData = calendar.getEvents()
        .filter(ev=>ev.extendedProps?.category !== 'ê³µíœ´ì¼')
        .map(ev=>{
          const category=ev.extendedProps?.category || '';
          if(ev.allDay){
            const sY=isoDate(ev.start); const eY=isoDate(ev.end||addDays(ev.start,1));
            return { id:ev.id, title:ev.title, allDay:true, start:sY, end:eY, image:ev.extendedProps?.image||'', desc:ev.extendedProps?.desc||'', status:ev.extendedProps?.status||'', category };
          }
          return { id:ev.id, title:ev.title, allDay:false, start:toKSTISO(ev.start), end:toKSTISO(ev.end||ev.start),
            image:ev.extendedProps?.image||'', desc:ev.extendedProps?.desc||'', status:ev.extendedProps?.status||'', category };
        });
      await saveFileToGitHub({ owner:OWNER, repo:REPO, branch:BRANCH, path:PATH, contentObj:eventsData, token });
      await saveFileToGitHub({ owner:OWNER, repo:REPO, branch:BRANCH, path:CAT_PATH, contentObj:catColors, token });
      markDirty(false); alert('ì»¤ë°‹ ì™„ë£Œ! (ì¼ì • + ì¹´í…Œê³ ë¦¬ ìƒ‰)');
    }catch(err){ console.error(err); alert('ì €ì¥ ì‹¤íŒ¨: '+err.message); }
  }
  async function saveFileToGitHub({owner,repo,branch,path,contentObj,token}){
    const api='https://api.github.com';
    const getUrl=`${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    let sha; const getRes=await fetch(getUrl,{headers:{'Accept':'application/vnd.github+json'}}); if(getRes.ok){ const meta=await getRes.json(); sha=meta.sha; } else if(getRes.status!==404){ throw new Error('ê¸°ì¡´ íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨('+getRes.status+')'); }
    const json=JSON.stringify(contentObj,null,2); const b64=btoa(unescape(encodeURIComponent(json)));
    const putUrl=`${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const body={message:`chore(schedule): update ${path}`, content:b64, branch, ...(sha?{sha}:{})};
    const putRes=await fetch(putUrl,{method:'PUT', headers:{'Accept':'application/vnd.github+json','Authorization':`token ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(body)});
    if(!putRes.ok){ const t=await putRes.text(); throw new Error('PUT ì‹¤íŒ¨('+putRes.status+'): '+t); }
  }

  /* ===== ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ì ===== */
  function openCatManager(){
    pickSupport.textContent = ('EyeDropper' in window) ? 'ìŠ¤í¬ì´ë“œ ì‚¬ìš© ê°€ëŠ¥(í¬ë¡¬/ì—£ì§€ ë“±)' : 'ìŠ¤í¬ì´ë“œëŠ” ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì§€ì›';
    renderCatManagerRows();
    const x=lastPointer.x, y=lastPointer.y; const pad=12, width=Math.min(760, window.innerWidth-24);
    catPop.style.left=Math.max(12, Math.min(x+10, window.innerWidth-width-pad))+'px';
    catPop.style.top =Math.max(12, Math.min(y-10, window.innerHeight-420))+'px';
    catBack.style.display='flex'; catBack.setAttribute('aria-hidden','false');
    newCatHex.value=newCatColor.value.toUpperCase();
    newCatColor.addEventListener('input', ()=>{ newCatHex.value=newCatColor.value.toUpperCase(); });
    newCatHex.addEventListener('input', ()=>{ const v=normalizeHex(newCatHex.value); if(v) newCatColor.value=v; });
  }
  function closeCatManager(){ catBack.style.display='none'; catBack.setAttribute('aria-hidden','true'); }
  catCancel.onclick=closeCatManager;
  catBack.addEventListener('click', e=>{ if(e.target===catBack) closeCatManager(); });

  function renderCatManagerRows(){
    const cats=catUnion().filter(c=>c!=='ë¯¸ë¶„ë¥˜');
    catList.innerHTML = cats.map(name=>{
      const col=catColor(name).toUpperCase(); const id='c_'+name.replace(/\s+/g,'_');
      return `<div class="cat-row" data-name="${escapeHtml(name)}">
        <input type="text" id="${id}_name" class="pill" value="${escapeHtml(name)}" />
        <input type="color" id="${id}_color" value="${col}">
        <input type="text" id="${id}_hex" class="color-hex" value="${col}">
        <button class="ico-btn" data-act="pick">ìŠ¤í¬ì´ë“œ</button>
        <button class="ico-btn" data-act="apply">ì´ë¦„/ìƒ‰ ë°˜ì˜</button>
        <button class="ico-btn" data-act="delete">ì‚­ì œ</button>
      </div>`;
    }).join('') || `<div class="muted" style="padding:10px">ì¹´í…Œê³ ë¦¬ê°€ ì•„ì§ ì—†ì–´ìš”. ì¼ì •ì„ ë§Œë“¤ë©´ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ì§€ì •í•˜ê±°ë‚˜ ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`;

    catList.querySelectorAll('.cat-row').forEach(row=>{
      const orig=row.dataset.name;
      const nameI=row.querySelector('.pill');
      const colorI=row.querySelector('[type=color]');
      const hexI=row.querySelector('.color-hex');
      const btnPick=row.querySelector('[data-act="pick"]');
      const btnApply=row.querySelector('[data-act="apply"]');
      const btnDel=row.querySelector('[data-act="delete"]');

      colorI.addEventListener('input', ()=>{ hexI.value=colorI.value.toUpperCase(); });
      hexI.addEventListener('input', ()=>{ const v=normalizeHex(hexI.value); if(v) colorI.value=v; });

      btnPick.addEventListener('click', async ()=>{
        if(!('EyeDropper' in window)) return alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŠ¤í¬ì´ë“œë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.');
        try{ const eye=new EyeDropper(); const res=await eye.open(); colorI.value=res.sRGBHex.toUpperCase(); hexI.value=res.sRGBHex.toUpperCase(); }catch(_e){}
      });

      btnApply.addEventListener('click', ()=>{
        const newName=(nameI.value||'').trim(); const hx=normalizeHex(hexI.value);
        if(!newName) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        if(hx) catColors[newName]=hx;
        if(newName!==orig){
          calendar.getEvents().forEach(ev=>{
            if((ev.extendedProps?.category||'')===orig) ev.setExtendedProp('category', newName);
          });
          // ğŸ”¹ í™œì„± í•„í„°ë„ ìƒˆ ì´ë¦„ìœ¼ë¡œ êµì²´
          if (activeCats.has(orig)) { activeCats.delete(orig); activeCats.add(newName); }
          if(catColors[orig] && !catColors[newName]) catColors[newName]=catColors[orig];
          delete catColors[orig];
          row.dataset.name=newName;
          markDirty(true); // ğŸ”¹ ì €ì¥ ì•ˆë‚´
        }
        renderCatUI(); applyCategoryFilter(); refreshEvents(); renderRail();
        alert('ë°˜ì˜ë¨. ìƒë‹¨ "GitHubë¡œ ì €ì¥" ë˜ëŠ” ì•„ë˜ "ì¹´í…Œê³ ë¦¬ ì €ì¥(GitHub)"ìœ¼ë¡œ ì»¤ë°‹í•˜ì„¸ìš”.');
      });

      btnDel.addEventListener('click', ()=>{
        if(!confirm(`"${orig}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ê³ , í•´ë‹¹ ì¼ì •ë“¤ì€ ë¯¸ë¶„ë¥˜ë¡œ ì´ë™í• ê¹Œìš”?`)) return;
        calendar.getEvents().forEach(ev=>{
          if((ev.extendedProps?.category||'')===orig) ev.setExtendedProp('category','');
        });
        delete catColors[orig];
        // ğŸ”¹ í™œì„± í•„í„°ì—ì„œ ì œê±°
        if (activeCats.has(orig)) { activeCats.delete(orig); }
        row.remove();
        markDirty(true); // ğŸ”¹ ì €ì¥ ì•ˆë‚´
        renderCatUI(); applyCategoryFilter(); refreshEvents(); renderRail();
      });
    });

    btnAddCat.onclick=()=>{
      const nm=(newCatName.value||'').trim(); const hx=normalizeHex(newCatHex.value)||'#58A6FF';
      if(!nm) return alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      catColors[nm]=hx.toUpperCase(); newCatName.value='';
      renderCatManagerRows(); renderCatUI(); applyCategoryFilter(); refreshEvents(); renderRail();
    };
  }

  // ğŸ”¸ ì¹´í…Œê³ ë¦¬ ì €ì¥ ë²„íŠ¼: ì¹´í…Œê³ ë¦¬ + ì¼ì • ë™ì‹œ ì €ì¥
  catSaveBtn.onclick = async ()=>{
    try{
      const rows=[...catList.querySelectorAll('.cat-row')];
      const next={};
      rows.forEach(row=>{
        const nm=(row.querySelector('.pill').value||'').trim();
        const hx=normalizeHex(row.querySelector('.color-hex').value);
        if(nm && hx) next[nm]=hx.toUpperCase();
      });
      catColors=next;

      const token=prompt('GitHub Personal Access Token(ë ˆí¬ Contents:write ê¶Œí•œ):'); 
      if(!token) return;

      // 1) ì¹´í…Œê³ ë¦¬ ìƒ‰ ì €ì¥
      await saveFileToGitHub({ owner:OWNER, repo:REPO, branch:BRANCH, path:CAT_PATH, contentObj:catColors, token });

      // 2) ì¼ì •ë„ í•¨ê»˜ ì €ì¥ (í˜„ì¬ ë©”ëª¨ë¦¬ ìƒíƒœ â†’ schedule.json)
      const eventsData = calendar.getEvents()
        .filter(ev=>ev.extendedProps?.category !== 'ê³µíœ´ì¼')
        .map(ev=>{
          const category=ev.extendedProps?.category || '';
          if(ev.allDay){
            const sY=isoDate(ev.start); const eY=isoDate(ev.end||addDays(ev.start,1));
            return { id:ev.id, title:ev.title, allDay:true, start:sY, end:eY, image:ev.extendedProps?.image||'', desc:ev.extendedProps?.desc||'', status:ev.extendedProps?.status||'', category };
          }
          return { id:ev.id, title:ev.title, allDay:false, start:toKSTISO(ev.start), end:toKSTISO(ev.end||ev.start),
            image:ev.extendedProps?.image||'', desc:ev.extendedProps?.desc||'', status:ev.extendedProps?.status||'', category };
        });
      await saveFileToGitHub({ owner:OWNER, repo:REPO, branch:BRANCH, path:PATH, contentObj:eventsData, token });

      markDirty(false);
      alert('ì¹´í…Œê³ ë¦¬ì™€ ì¼ì •ì´ ëª¨ë‘ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      renderCatUI(); applyCategoryFilter(); refreshEvents(); renderRail(); closeCatManager();
    }catch(err){ console.error(err); alert('ì €ì¥ ì‹¤íŒ¨: '+err.message); }
  };

  [fTitle,fStatus,fStart,fEnd,fImage,fDesc,fCat,fCatColor].forEach(el=> el.addEventListener('input', ()=>{ if(selected){ updatePreview(); markDirty(); }}));

  /* ===== ì´ë²¤íŠ¸ë§Œ ê¹”ë” ë¦¬ë Œë”(FC v6 ëŒ€ì‘) ===== */
  function refreshEvents(){
    if (!calendar) return;
    calendar.batchRendering(() => {
      calendar.getEvents().forEach(ev => {
        ev.setExtendedProp('__refresh', (ev.extendedProps?.__refresh || 0) + 1);
      });
    });
  }
})();
</script>
</body>
</html>
