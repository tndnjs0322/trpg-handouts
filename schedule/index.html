<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>캠페인 일정</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/locales-all.global.min.js"></script>

<style>
  :root{
    --bg:#0c171b; --card:#0b1220; --line:#1e2a41; --text:#e6eef2; --muted:#a6b3c2;
    --accent:#58a6ff; --danger:#ff6b6b; --ok:#57d19a;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Arial;
    color:var(--text); background: radial-gradient(1200px 600px at 20% 0%, #0f2530 0%, transparent 60%),
                        radial-gradient(1200px 600px at 100% 20%, #101e2a 0%, transparent 60%),
                        var(--bg);
  }

  /* ===== 상단 ===== */
  .wrap{max-width:min(1680px, 94vw); margin:28px auto; padding:0 16px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
  .title{font-weight:700; font-size:18px}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .btn{appearance:none; border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff; border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer}
  .btn:hover{border-color:#38507d}
  .btn-danger{border-color:#5a2a2a; background:#2a1111}
  .btn-danger:hover{border-color:#7d3838}
  .chip{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #334357; background:#0b1526; color:#cfe2ff}

  /* ===== 레이아웃: 캘린더(왼) + 인포레일/상세(오른) ===== */
  .grid{
    display:grid; gap:18px;
    grid-template-columns: minmax(860px, 1.8fr) minmax(380px, 1fr);
  }
  @media (max-width: 1200px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* 왼쪽 캘린더 패널을 화면높이에 맞게 */
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 18%) , var(--card);
    border:1px solid var(--line); border-radius:16px; overflow:hidden;
    height: calc(100vh - 140px); min-height:620px;
    box-shadow: 0 8px 50px rgba(0,0,0,.25);
  }
  #calendar{ height:100%; padding:8px }

  /* 오른쪽 레일(상세 or 빈 상태의 요약 카드들) */
  aside{
    background:var(--card); border:1px solid var(--line); border-radius:16px;
    padding:14px; min-height:620px; height: calc(100vh - 140px); overflow:auto;
    box-shadow: 0 8px 50px rgba(0,0,0,.25);
  }
  #detail.collapsed #card{ display:none }
  #detail.collapsed #rail{ display:grid }   /* 선택 없음 → 요약 레일 보여주기 */
  #detail:not(.collapsed) #rail{ display:none } /* 상세 열리면 요약 숨김 */

  /* 공통 카드 */
  .card{ background:#0c1526; border:1px solid #20304f; border-radius:14px; padding:12px; }
  .card + .card{ margin-top:12px }
  .card h3{ margin:0 0 8px; font-size:14px; letter-spacing:.2px }
  .muted{color:var(--muted); font-size:13px}

  /* 요약 리스트 */
  .list{margin:0; padding:0; list-style:none; display:grid; gap:8px}
  .li{
    display:grid; grid-template-columns:auto 1fr; align-items:center; gap:10px;
    padding:8px; border:1px solid #213254; background:#0b1220; border-radius:12px;
  }
  .li .dot{width:8px; height:8px; border-radius:50%; background:var(--ok)}
  .li .title{font-size:13px; font-weight:600}
  .li .sub{font-size:12px; color:#a6b3c2}
  .li .act{justify-self:end}
  .li .mini-btn{border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff; border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer}
  .li .mini-btn:hover{border-color:#38507d}

  /* 상세 편집(card) */
  .evt-img{width:100%; height:160px; object-fit:cover; border-radius:10px; background:#09121f; margin-bottom:8px}
  .evt-time{font-size:12px; opacity:.8; margin:6px 0}
  .progress{height:8px; background:#122036; border-radius:6px; overflow:hidden}
  .bar{height:100%; width:0%; background:var(--accent)}
  .hint{font-size:12px; opacity:.8}
  .row{display:grid; grid-template-columns:1fr; gap:8px}
  @media (min-width:1400px){ .row{ grid-template-columns:1fr 1fr; } }
  .row>*{ min-width:0; }
  input[type="text"], input[type="url"], input[type="datetime-local"], textarea, select{
    width:100%; padding:10px; border:1px solid #2a3a58; border-radius:10px; background:#0c1526; color:#e6eef2; font-size:14px;
  }
  textarea{min-height:100px; resize:vertical}

  /* 퀵 편집 팝업 */
  .qpop-back{position:fixed; inset:0; display:none; align-items:flex-start; justify-content:flex-start; background:transparent; z-index:9999}
  .qpop{position:absolute; width:min(420px, calc(100vw - 24px)); background:#0b1220; border:1px solid #1e2a41; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.45); padding:12px}
  .qrow{display:grid; grid-template-columns:1fr; gap:8px; margin-top:6px}
  .qrow2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .qtitle{width:100%; padding:10px; border:1px solid #2a3a58; border-radius:10px; background:#0c1526; color:#e6eef2; font-size:14px}
  .qsub{font-size:12px; color:#a6b3c2}
  .qactions{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
  .qpop .btn{padding:8px 10px}
  .qtoggle{display:flex; align-items:center; gap:8px}
  .qtoggle input{accent-color:#58a6ff}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">캠페인 일정 <span id="dirty" class="muted"></span></div>
    <div class="actions">
      <button class="btn" id="btnMonth">월간</button>
      <button class="btn" id="btnWeek">주간</button>
      <button class="btn" id="btnList">리스트</button>
      <button class="btn" id="btnToday">오늘</button>
      <button class="btn" id="btnNew">새 일정</button>
      <button class="btn btn-danger" id="btnDel">선택 삭제</button>
      <button class="btn" id="btnSave">GitHub로 저장</button>
      <button class="btn" id="btnBack">뒤로</button>
    </div>
  </header>

  <div class="grid">
    <!-- 왼쪽: 캘린더 -->
    <div class="panel"><div id="calendar"></div></div>

    <!-- 오른쪽: 상세 or 요약 레일 -->
    <aside id="detail" class="collapsed">
      <!-- 요약 레일(선택 없을 때) -->
      <div id="rail">
        <div class="card">
          <h3>오늘</h3>
          <div id="todayLine" class="muted"></div>
          <div style="display:flex; gap:8px; margin-top:10px">
            <button class="btn" id="btnQuickToday">오늘 20:00로</button>
            <span class="chip" id="chipNow"></span>
          </div>
        </div>
        <div class="card">
          <h3>다가오는 일정</h3>
          <ul id="upcoming" class="list"></ul>
        </div>
        <div class="card">
          <h3>이달 통계</h3>
          <div class="muted" id="statsMonth">이달 일정 0건</div>
        </div>
      </div>

      <!-- 상세 편집(선택 시) -->
      <div id="card" style="display:none">
        <img id="evtImg" class="evt-img" alt="" />
        <div class="row">
          <div>
            <div class="hint">제목</div>
            <input id="fTitle" type="text" placeholder="제목" />
          </div>
          <div>
            <div class="hint">상태</div>
            <select id="fStatus">
              <option value="">(선택)</option>
              <option value="planned">planned</option>
              <option value="ongoing">ongoing</option>
              <option value="done">done</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div>
            <div class="hint">시작</div>
            <input id="fStart" type="datetime-local" />
          </div>
          <div>
            <div class="hint">종료</div>
            <input id="fEnd" type="datetime-local" />
          </div>
        </div>
        <div style="margin-top:6px">
          <div class="hint">이미지 URL</div>
          <input id="fImage" type="url" placeholder="https://..." />
        </div>
        <div style="margin-top:6px">
          <div class="hint">설명</div>
          <textarea id="fDesc" placeholder="세부 내용/링크/메모 등"></textarea>
        </div>
        <div class="evt-time" id="evtTime"></div>
        <div class="progress"><div id="evtProg" class="bar"></div></div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button class="btn" id="btnApply">변경 적용</button>
          <button class="btn btn-danger" id="btnDel2">삭제</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- 퀵 편집 팝업 -->
<div class="qpop-back" id="qback" aria-hidden="true">
  <div class="qpop" id="qpop" role="dialog" aria-modal="true">
    <input id="qTitle" class="qtitle" type="text" placeholder="제목 및 시간 추가" />
    <div class="qrow qtoggle">
      <label><input id="qAllDay" type="checkbox" /> 하루 종일</label>
      <label><input id="qAddTime" type="checkbox" /> 시간 추가</label>
      <span class="qsub" id="qWhenText"></span>
    </div>
    <div class="qrow2" id="qDates">
      <div>
        <div class="qsub">시작</div>
        <input id="qStartDate" type="date" />
      </div>
      <div>
        <div class="qsub">종료</div>
        <input id="qEndDate" type="date" />
      </div>
    </div>
    <div class="qrow2" id="qTimes" style="display:none">
      <div>
        <div class="qsub">시작 시간</div>
        <input id="qStartTime" type="time" value="20:00" />
      </div>
      <div>
        <div class="qsub">종료 시간</div>
        <input id="qEndTime" type="time" value="22:00" />
      </div>
    </div>
    <div class="qactions">
      <button class="btn" id="qMore">자세히</button>
      <button class="btn btn-danger" id="qDelete" style="display:none">삭제</button>
      <button class="btn" id="qCancel">취소</button>
      <button class="btn" id="qSave">저장</button>
    </div>
  </div>
</div>

<script>
(() => {
  /* ===== 설정 ===== */
  const OWNER  = 'tndnjs0322';
  const REPO   = 'trpg-handouts';
  const BRANCH = 'main';
  const PATH   = 'data/schedule.json';
  const SRC    = '../data/schedule.json';

  /* ===== 상태/UI 참조 ===== */
  let calendar, selected = null, dirty = false, editingEvent = null;
  let lastPointer = {x: window.innerWidth/2, y: 120};

  const calEl   = document.getElementById('calendar');
  const btnMonth= document.getElementById('btnMonth');
  const btnWeek = document.getElementById('btnWeek');
  const btnList = document.getElementById('btnList');
  const btnToday= document.getElementById('btnToday');
  const btnNew  = document.getElementById('btnNew');
  const btnDel  = document.getElementById('btnDel');
  const btnSave = document.getElementById('btnSave');
  const btnBack = document.getElementById('btnBack');
  const dirtyEl = document.getElementById('dirty');

  const detail  = document.getElementById('detail');
  const rail    = document.getElementById('rail');
  const upcomingEl = document.getElementById('upcoming');
  const todayLine = document.getElementById('todayLine');
  const chipNow = document.getElementById('chipNow');
  const statsMonth = document.getElementById('statsMonth');
  const btnQuickToday = document.getElementById('btnQuickToday');

  const imgEl   = document.getElementById('evtImg');
  const fTitle  = document.getElementById('fTitle');
  const fStatus = document.getElementById('fStatus');
  const fStart  = document.getElementById('fStart');
  const fEnd    = document.getElementById('fEnd');
  const fImage  = document.getElementById('fImage');
  const fDesc   = document.getElementById('fDesc');
  const evtTime = document.getElementById('evtTime');
  const evtProg = document.getElementById('evtProg');
  const btnApply= document.getElementById('btnApply');
  const btnDel2 = document.getElementById('btnDel2');

  // 퀵 팝업
  const qback = document.getElementById('qback');
  const qpop  = document.getElementById('qpop');
  const qTitle= document.getElementById('qTitle');
  const qAllDay=document.getElementById('qAllDay');
  const qAddTime=document.getElementById('qAddTime');
  const qWhenText=document.getElementById('qWhenText');
  const qDates=document.getElementById('qDates');
  const qTimes=document.getElementById('qTimes');
  const qStartDate=document.getElementById('qStartDate');
  const qEndDate=document.getElementById('qEndDate');
  const qStartTime=document.getElementById('qStartTime');
  const qEndTime=document.getElementById('qEndTime');
  const qSave=document.getElementById('qSave');
  const qCancel=document.getElementById('qCancel');
  const qDelete=document.getElementById('qDelete');
  const qMore=document.getElementById('qMore');

  document.addEventListener('pointerdown', (e)=>{ lastPointer={x:e.clientX,y:e.clientY}; }, {passive:true});
  function markDirty(v=true){ dirty=v; dirtyEl.textContent = v ? '· 수정됨' : ''; }
  window.addEventListener('beforeunload', (e)=>{ if(dirty){ e.preventDefault(); e.returnValue=''; }});

  /* ===== 데이터 로드 ===== */
  fetch(SRC, { cache: 'no-store' })
    .then(r => r.ok ? r.json() : [])
    .then(arr => initCalendar(Array.isArray(arr) ? arr : []))
    .catch(() => initCalendar([]));

  /* ===== 캘린더 구성 ===== */
  function isYMD(s){ return typeof s==='string' && /^\d{4}-\d{2}-\d{2}$/.test(s); }
  function toFCEvt(ev){
    if (ev.allDay){
      const s = isYMD(ev.start) ? ev.start : isoDate(new Date(ev.start));
      const e = ev.end ? (isYMD(ev.end) ? ev.end : isoDate(new Date(ev.end))) : undefined;
      return { id: ev.id || genId(new Date()), title: ev.title || '(제목 없음)', allDay:true, start:s, end:e,
        extendedProps:{ image:ev.image||'', desc:ev.desc||'', status:ev.status||'' } };
    }
    return { id: ev.id || genId(new Date(ev.start||Date.now())), title: ev.title || '(제목 없음)', allDay:false,
      start:ev.start, end:ev.end, extendedProps:{ image:ev.image||'', desc:ev.desc||'', status:ev.status||'' } };
  }

  function initCalendar(events){
    calendar = new FullCalendar.Calendar(calEl, {
      locale: 'ko', timeZone: 'Asia/Seoul',
      height: '100%', initialView: 'dayGridMonth', headerToolbar: false,
      buttonText: { today: '오늘' }, nowIndicator: false, progressiveEventRendering: true,
      editable: true, selectable: true, selectMirror: true,
      events: events.map(toFCEvt),

      dateClick: (info) => {
        openQuick({ anchor: info.jsEvent, start: parseDateOnly(info.dateStr), end: parseDateOnly(info.dateStr), allDay: true, title: '' });
      },
      select: (info) => {
        const allDay = info.allDay ?? (calendar.view.type==='dayGridMonth');
        const s = allDay ? parseDateOnly(info.startStr) : info.start;
        const e = allDay ? parseDateOnly(info.endStr)   : info.end;
        openQuick({ anchor: null, start: s, end: allDay ? addDays(e,-1) : e, allDay, title:'' });
        calendar.unselect();
      },
      eventClick: (info) => {
        openQuick({
          anchor: info.jsEvent, start: info.event.start, end: info.event.end || info.event.start,
          allDay: info.event.allDay, title: info.event.title, event: info.event
        });
      },
      eventDrop:  () => { markDirty(); updatePreview(); renderRail(); },
      eventResize:() => { markDirty(); updatePreview(); renderRail(); },
      eventsSet:  () => { renderRail(); } // 초기 렌더 및 변경시 요약 갱신
    });
    calendar.render();

    // 상단 버튼
    btnMonth.onclick = () => calendar.changeView('dayGridMonth');
    btnWeek.onclick  = () => calendar.changeView('timeGridWeek');
    btnList.onclick  = () => calendar.changeView('listMonth');
    btnToday.onclick = () => calendar.today();

    btnNew.onclick   = () => {
      const s = roundToNextHalfHour(new Date());
      openQuick({ anchor:null, start:s, end:new Date(s.getTime()+2*3600*1000), allDay:false, title:'' });
    };
    btnDel.onclick   = () => { if(selected) { if(confirm('선택된 일정을 삭제할까요?')) { selected.remove(); clearDetail(); markDirty(); renderRail(); } } else alert('선택된 일정이 없습니다.'); };
    btnDel2.onclick  = () => btnDel.onclick();
    btnSave.onclick  = saveToGitHub;

    btnBack.onclick  = () => history.back();
    if (history.length <= 1 || !document.referrer) btnBack.style.display = 'none';

    // 레일의 "오늘 20:00로" 빠른 추가
    btnQuickToday.onclick = () => {
      const base = new Date(); base.setHours(20,0,0,0);
      openQuick({ anchor:null, start:base, end:new Date(base.getTime()+2*3600*1000), allDay:false, title:'' });
    };
  }

  /* ===== 퀵 팝업 ===== */
  function openQuick({anchor, start, end, allDay, title, event=null}){
    editingEvent = event;

    qTitle.value = title || '';
    qAllDay.checked = !!allDay;
    qAddTime.checked = !allDay;

    const s = new Date(start);
    let   e = new Date(end || start);
    if (event && allDay && event.end) e = addDays(event.end, -1);

    if (allDay){
      qTimes.style.display = 'none';
      qStartDate.value = isoDate(s);
      qEndDate.value   = isoDate(e);
    } else {
      qTimes.style.display = '';
      qStartDate.value = isoDate(s);
      qEndDate.value   = isoDate(e);
      qStartTime.value = hhmm(s);
      qEndTime.value   = hhmm(e);
    }
    updateWhenText();

    const x = anchor?.clientX ?? lastPointer.x;
    const y = anchor?.clientY ?? lastPointer.y;
    const pad = 12, width = Math.min(420, window.innerWidth - 24);
    const left = Math.max(12, Math.min(x + 10, window.innerWidth - width - pad));
    const top  = Math.max(12, Math.min(y - 10, window.innerHeight - 260));
    qpop.style.left = left + 'px';
    qpop.style.top  = top + 'px';

    qDelete.style.display = editingEvent ? '' : 'none';

    qback.style.display = 'flex';
    qback.setAttribute('aria-hidden','false');
    setTimeout(()=> qTitle.focus(), 0);
  }
  function closeQuick(){ qback.style.display = 'none'; qback.setAttribute('aria-hidden','true'); }
  qCancel.onclick = closeQuick;
  qback.addEventListener('click', (e)=>{ if(e.target===qback) closeQuick(); });

  qAllDay.addEventListener('change', ()=>{ qAddTime.checked = !qAllDay.checked; qTimes.style.display = qAddTime.checked ? '' : 'none'; updateWhenText(); });
  qAddTime.addEventListener('change', ()=>{ qAllDay.checked = !qAddTime.checked; qTimes.style.display = qAddTime.checked ? '' : 'none';
    if (qAddTime.checked && !qStartTime.value) qStartTime.value='20:00';
    if (qAddTime.checked && !qEndTime.value) qEndTime.value='22:00'; updateWhenText();
  });
  [qStartDate,qEndDate,qStartTime,qEndTime].forEach(el=> el.addEventListener('input', updateWhenText));

  qSave.addEventListener('click', ()=>{
    const title  = qTitle.value.trim() || '(제목 없음)';
    const allDay = qAllDay.checked;

    if (allDay){
      const sDay = parseDateOnly(qStartDate.value);
      const eDay = parseDateOnly(qEndDate.value || qStartDate.value);
      if(!sDay || !eDay) return alert('날짜를 확인해 주세요.');
      const startStr = isoDate(sDay);
      const endExStr = isoDate(addDays(eDay, 1)); // exclusive

      if (editingEvent){
        editingEvent.setAllDay(true);
        editingEvent.setStart(startStr, { maintainDuration:false });
        editingEvent.setEnd(endExStr);
        markDirty(); selectEvent(editingEvent);
      } else {
        calendar.addEvent({ id: genId(sDay), title, allDay:true, start:startStr, end:endExStr });
        markDirty();
      }
    } else {
      const s = parseDateTime(qStartDate.value, qStartTime.value || '20:00');
      const e = parseDateTime(qEndDate.value || qStartDate.value, qEndTime.value || '22:00');
      if (!s || !e) return alert('날짜/시간을 확인해 주세요.');
      if (e <= s)   return alert('종료가 시작보다 빠를 수 없어요.');

      if (editingEvent){
        editingEvent.setAllDay(false);
        editingEvent.setStart(s, { maintainDuration:false });
        editingEvent.setEnd(e);
        markDirty(); selectEvent(editingEvent);
      } else {
        calendar.addEvent({ id: genId(s), title, allDay:false, start:s, end:e });
        markDirty();
      }
    }
    closeQuick();
    renderRail();
  });

  qDelete.addEventListener('click', ()=>{
    if (!editingEvent) return;
    if (confirm('이 일정을 삭제할까요?')){
      editingEvent.remove();
      if (selected && selected.id===editingEvent.id){ clearDetail(); }
      editingEvent = null;
      markDirty();
      closeQuick();
      renderRail();
    }
  });
  qMore.addEventListener('click', ()=>{ if (editingEvent){ selectEvent(editingEvent, {expandDetail:true}); } closeQuick(); });

  function updateWhenText(){
    const allDay = qAllDay.checked;
    const sd = qStartDate.value, ed = qEndDate.value || sd;
    if (!sd){ qWhenText.textContent=''; return; }
    if (allDay){
      qWhenText.textContent = `${sd} ~ ${ed} (하루 종일)`;
    } else {
      const st = qStartTime.value || '20:00';
      const et = qEndTime.value   || '22:00';
      qWhenText.textContent = `${sd} ${st} ~ ${ed} ${et}`;
    }
  }

  /* ===== 상세 패널 ===== */
  function selectEvent(ev, opts={}){
    selected = ev;
    if (opts.expandDetail) detail.classList.remove('collapsed');

    rail.style.display = 'none';
    const card = document.getElementById('card');
    card.style.display = '';

    fTitle.value  = ev.title || '';
    fStatus.value = ev.extendedProps?.status || '';
    fStart.value  = toLocalInput(ev.start);
    fEnd.value    = toLocalInput(ev.end || ev.start);
    fImage.value  = ev.extendedProps?.image || '';
    fDesc.value   = ev.extendedProps?.desc  || '';
    updatePreview();
  }
  function clearDetail(){
    selected = null;
    document.getElementById('card').style.display = 'none';
    rail.style.display = 'grid';
    imgEl.removeAttribute('src');
  }
  btnApply.onclick = () => {
    if (!selected) return alert('선택된 일정이 없습니다.');
    const title = fTitle.value.trim();
    const start = fromLocalInput(fStart.value);
    const end   = fromLocalInput(fEnd.value);
    if(!title || !start || !end) return alert('제목/시작/종료는 필수입니다.');
    if(new Date(start) > new Date(end)) return alert('종료가 시작보다 빠를 수 없어요.');

    selected.setProp('title', title);
    selected.setStart(new Date(start));
    selected.setEnd(new Date(end));
    selected.setExtendedProp('image', fImage.value.trim());
    selected.setExtendedProp('desc',  fDesc.value);
    selected.setExtendedProp('status',fStatus.value);
    updatePreview();
    markDirty();
    alert('적용 완료(임시). 상단 "GitHub로 저장"을 눌러 커밋하세요!');
    renderRail();
  };

  function updatePreview(){
    if(!selected) return;
    const p = selected.extendedProps || {};
    if (p.image){ imgEl.src = p.image; imgEl.style.display=''; }
    else { imgEl.removeAttribute('src'); imgEl.style.display='none'; }
    evtTime.textContent = [selected.start, selected.end||selected.start].filter(Boolean).map(fmtKST).join(' ~ ');
    if(selected.start && (selected.end||selected.start)){
      const now = new Date(), s=new Date(selected.start), e=new Date(selected.end||selected.start);
      if(now < s){ evtProg.style.width='0%'; }
      else if(now > e){ evtProg.style.width='100%'; }
      else { const pct = Math.min(100, Math.max(0, (now - s)/(e - s)*100)); evtProg.style.width = pct.toFixed(0) + '%'; }
    } else { evtProg.style.width='0%'; }
  }

  /* ===== 요약 레일 렌더 ===== */
  function renderRail(){
    // 오늘 라인
    const now = new Date();
    chipNow.textContent = now.toLocaleString('ko-KR', { timeZone:'Asia/Seoul', hour:'2-digit', minute:'2-digit' });
    const todayStr = isoDate(now);
    const todays = calendar.getEvents().filter(ev => {
      // allDay는 시작~(end-1일)까지 포함
      if (ev.allDay){
        const s = typeof ev.start === 'string' ? ev.start : isoDate(ev.start);
        const e = typeof ev.end   === 'string' ? ev.end   : isoDate(ev.end || addDays(ev.start,1));
        // inclusive range 체크
        return s <= todayStr && todayStr < e;
      } else {
        const d = isoDate(ev.start);
        return d === todayStr;
      }
    });
    todayLine.textContent = `${todayStr} · 오늘 일정 ${todays.length}건`;

    // 다가오는 일정 6개
    const list = getUpcoming(6);
    upcomingEl.innerHTML = list.map(({ev, s, e, span}) => {
      const time = ev.allDay ? '하루 종일' :
        `${pad(s.getHours())}:${pad(s.getMinutes())} ~ ${pad(e.getHours())}:${pad(e.getMinutes())}`;
      const sub = `${s.getMonth()+1}월 ${s.getDate()}일 · ${time}${span>1?` · ${span}일`:''}`;
      return `<li class="li">
        <span class="dot"></span>
        <div>
          <div class="title">${escapeHtml(ev.title||'(제목 없음)')}</div>
          <div class="sub">${sub}</div>
        </div>
        <button class="mini-btn act" data-id="${ev.id}">열기</button>
      </li>`;
    }).join('') || `<div class="muted">예정된 일정이 없습니다.</div>`;

    // 이벤트 연결(열기)
    upcomingEl.querySelectorAll('.mini-btn').forEach(btn=>{
      btn.onclick = () => {
        const ev = calendar.getEventById(btn.dataset.id);
        if (ev){
          selectEvent(ev, {expandDetail:true});
          // 해당 날짜로 이동
          calendar.gotoDate(ev.start);
        }
      };
    });

    // 이달 통계
    const cur = calendar.getDate();
    const mStart = new Date(cur.getFullYear(), cur.getMonth(), 1);
    const mEnd   = new Date(cur.getFullYear(), cur.getMonth()+1, 1);
    const monthCount = calendar.getEvents().filter(ev=> ev.start >= mStart && ev.start < mEnd).length;
    statsMonth.textContent = `${cur.getMonth()+1}월 일정 ${monthCount}건`;
  }

  function getUpcoming(limit=6){
    const now = new Date();
    const evs = calendar.getEvents().map(ev=>{
      let s = ev.allDay
        ? (typeof ev.start === 'string' ? parseDateOnly(ev.start) : new Date(ev.start))
        : new Date(ev.start);
      let e = ev.allDay
        ? (typeof ev.end === 'string' ? parseDateOnly(ev.end) : new Date(ev.end || ev.start))
        : new Date(ev.end || ev.start);
      if (ev.allDay) e = addDays(e, -1); // inclusive
      return { ev, s, e, span: Math.max(1, Math.round((e - s)/(24*3600*1000))+1) };
    }).filter(o => o.e >= now).sort((a,b)=> a.s - b.s).slice(0, limit);
    return evs;
  }

  /* ===== 저장(GitHub Contents API) ===== */
  async function saveToGitHub(){
    try{
      const token = prompt('GitHub Personal Access Token(이 레포 Contents:write 권한):');
      if(!token) return;
      const data = eventsToArray();
      await saveFileToGitHub({ owner:OWNER, repo:REPO, branch:BRANCH, path:PATH, contentObj:data, token });
      markDirty(false);
      alert('커밋 완료! 페이지를 새로고침하면 반영 확인 가능');
    }catch(err){ console.error(err); alert('저장 실패: ' + err.message); }
  }
  function eventsToArray(){
    return calendar.getEvents().map(ev => {
      if (ev.allDay){
        const sY = isoDate(ev.start);
        const eY = isoDate(ev.end || addDays(ev.start,1));
        return { id: ev.id, title: ev.title, allDay: true, start: sY, end: eY,
          image: ev.extendedProps?.image || '', desc: ev.extendedProps?.desc  || '', status: ev.extendedProps?.status || '' };
      }
      return { id: ev.id, title: ev.title, allDay: false,
        start: toKSTISO(ev.start), end: toKSTISO(ev.end || ev.start),
        image: ev.extendedProps?.image || '', desc: ev.extendedProps?.desc  || '', status: ev.extendedProps?.status || '' };
    });
  }
  async function saveFileToGitHub({owner,repo,branch,path,contentObj,token}){
    const api = 'https://api.github.com';
    const getUrl = `${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    let sha;
    const getRes = await fetch(getUrl, { headers: { 'Accept':'application/vnd.github+json' } });
    if (getRes.ok){ const meta = await getRes.json(); sha = meta.sha; }
    else if (getRes.status !== 404){ throw new Error('기존 파일 조회 실패(' + getRes.status + ')'); }
    const json = JSON.stringify(contentObj, null, 2);
    const b64  = base64EncodeUnicode(json);
    const putUrl = `${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const body = { message:`chore(schedule): update ${path}`, content:b64, branch, ...(sha?{sha}:{}) };
    const putRes = await fetch(putUrl, {
      method:'PUT',
      headers:{ 'Accept':'application/vnd.github+json','Authorization':`token ${token}`,'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if (!putRes.ok){ const t = await putRes.text(); throw new Error('PUT 실패(' + putRes.status + '): ' + t); }
  }
  function base64EncodeUnicode(str){ return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(_,p)=>String.fromCharCode('0x'+p))); }

  /* ===== 유틸 ===== */
  function genId(d){ const pad=n=>n.toString().padStart(2,'0'); return `e-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${Math.random().toString(36).slice(2,6)}`; }
  function roundToNextHalfHour(d){ const x = new Date(d); x.setSeconds(0,0); const m=x.getMinutes(); x.setMinutes(m<30?30:60); return x; }
  function toLocalInput(dt){ if(!dt) return ''; const d=new Date(dt); const p=n=>n.toString().padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; }
  function toKSTISO(dt){ if(!dt) return null; const d=new Date(dt); const p=n=>n.toString().padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}+09:00`; }
  function fromLocalInput(str){ if(!str) return null; return new Date(str.replace('T',' ') + ':00'); }
  function fmtKST(d){ return new Date(d).toLocaleString('ko-KR', { timeZone:'Asia/Seoul' }); }
  function isoDate(d){ const x=new Date(d); const p=n=>n.toString().padStart(2,'0'); return `${x.getFullYear()}-${p(x.getMonth()+1)}-${p(x.getDate())}`; }
  function hhmm(d){ const x=new Date(d); const p=n=>n.toString().padStart(2,'0'); return `${p(x.getHours())}:${p(x.getMinutes())}`; }
  function parseDateTime(dstr, tstr){ if(!dstr) return null; const s = tstr || '00:00'; return new Date(`${dstr}T${s}:00`); }
  function parseDateOnly(yyyy_mm_dd){ if(!yyyy_mm_dd) return null; const [y,m,d]=yyyy_mm_dd.split('-').map(Number); return new Date(y, m-1, d); }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  const pad=n=>n.toString().padStart(2,'0');
  function escapeHtml(s){ return s==null?'':s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }

  // 상세 값 변경 → 더티 & 미리보기
  [fTitle,fStatus,fStart,fEnd,fImage,fDesc].forEach(el=>{
    el.addEventListener('input', ()=>{ if(selected){ updatePreview(); markDirty(); }});
  });
})();
</script>
</body>
</html>
