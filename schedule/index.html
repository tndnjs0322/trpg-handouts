<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>일정 캘린더</title>

<link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />

<style>
  /* ── 라이트/다크 공통 변수 ── */
  :root { --bg:#0d1a1f; --panel:#0f1b20; --text:#e6eef2; --muted:#9fb4bf; --border:#1b2a31; --header:rgba(13,26,31,.9); --btn-bg:#0e1a1f; --btn-hover:#0b1628; }
  :root[data-theme="dark"]  { color-scheme: dark; }
  :root[data-theme="light"] { color-scheme: light;
    --bg:#f5f7fb; --panel:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --header:rgba(255,255,255,.92); --btn-bg:#ffffff; --btn-hover:#f3f4f6;
  }

  body{ margin:0; background:var(--bg); color:var(--text);
        font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif; }
  header{
    position:sticky; top:0; z-index:10;
    display:flex; gap:.5rem; align-items:center; justify-content:space-between; flex-wrap:wrap;
    padding:10px 12px; background:var(--header); border-bottom:1px solid var(--border);
    backdrop-filter:blur(6px) saturate(120%);
  }
  .left,.right{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
  button,.btn{
    appearance:none; border:1px solid var(--border); background:var(--btn-bg); color:var(--text);
    border-radius:10px; padding:6px 10px; cursor:pointer; font-size:14px;
  }
  button:hover,.btn:hover{ background:var(--btn-hover) }
  #range{ color:var(--muted); font-size:.9rem }
  #calendar{
    height:calc(100vh - 64px); min-height:680px;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; margin:12px; overflow:hidden;
  }
</style>
</head>
<body>
  <header>
    <div class="left">
      <button id="btnBack" title="뒤로 (Esc/Backspace)">⟵ 뒤로</button>
      <a class="btn" id="btnHome" href="../" title="메인으로 (H)">🏠 메인</a>

      <button id="btnPrev">◀︎ 이전</button>
      <button id="btnToday">오늘</button>
      <button id="btnNext">다음 ▶︎</button>

      <button data-view="month">월</button>
      <button data-view="week">주</button>
      <button data-view="day">일</button>
    </div>
    <div class="right">
      <button id="btnDensity" title="칸/시간 압축 토글">컴팩트</button>
      <button id="btnTheme" title="라이트/다크 전환">☀️ 라이트</button>
      <span id="range"></span>
    </div>
  </header>

  <div id="calendar"></div>

  <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>
  <script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>
  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>

  <script>
    let calendar; // render 안전 호출용
    const THEME_KEY = 'cal_theme';

    document.addEventListener('DOMContentLoaded', () => {
      const boot = () => (window.tui && window.tui.Calendar) ? init() : setTimeout(boot, 30);
      boot();
    });

    function init(){
      const { Calendar } = tui;
      const el = document.getElementById('calendar');
      const STORAGE_KEY = 'toastui_v2_events';
      const rangeEl = document.getElementById('range');
      const btnTheme = document.getElementById('btnTheme');

      // ── 기본: 다크 + 컴팩트 ──
      let compact = true;

      calendar = new Calendar(el, {
        defaultView: 'month',
        usageStatistics: false,
        useFormPopup: true,
        useDetailPopup: true,
        timezone: { zones: [{ timezoneName:'Asia/Seoul', displayLabel:'Seoul' }] },
        calendars: [{ id:'default', name:'내 일정' }],
        month: {
          isAlways6Week: true,
          startDayOfWeek: 1,
          narrowWeekend: true,
          visibleEventCount: compact ? 3 : 5
        },
        week: {
          workweek: true,
          narrowWeekend: true,
          showNowIndicator: true,
          hourStart: compact ? 9 : 8,
          hourEnd: compact ? 19 : 21
        }
      });

      // ── 테마 전환 로직 ──
      const getVar = (v) => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
      function applyCalendarTheme(mode){
        // 캘린더 배경/요일 톤만 최소 조정 (라이트/다크 공통)
        calendar.setTheme({
          common: { backgroundColor: getVar('--panel') },
          month:  { dayName: { color: getVar('--muted') }, gridSelection: { backgroundColor: 'transparent' } },
          week:   { dayName: { color: getVar('--muted') } }
        });
        // 필요 시 재렌더
        try { calendar.render(); } catch(e){}
      }
      function setTheme(mode){
        document.documentElement.setAttribute('data-theme', mode);
        localStorage.setItem(THEME_KEY, mode);
        btnTheme.textContent = (mode === 'dark') ? '☀️ 라이트' : '🌙 다크';
        applyCalendarTheme(mode);
      }
      // 초기 테마: 저장값 → 시스템 → 기본(다크)
      const saved = localStorage.getItem(THEME_KEY);
      const initial = saved || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'dark');
      setTheme(initial);

      btnTheme.addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'dark';
        setTheme(cur === 'dark' ? 'light' : 'dark');
      });

      // ── 저장/복구 ──
      let state = [];
      try { state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || []; } catch(e){}
      if (state.length) calendar.createEvents(state);
      const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      const upsert = (ev) => {
        const i = state.findIndex(x => x.id === ev.id && x.calendarId === x.calendarId);
        if (i >= 0) state[i] = { ...state[i], ...ev }; else state.push(ev);
        save();
      };
      const remove = (id, calendarId) => { state = state.filter(x => !(x.id === id && x.calendarId === calendarId)); save(); };

      calendar.on('beforeCreateEvent', (ev) => {
        const id = String(Date.now()) + Math.random().toString(36).slice(2,7);
        const newEvent = { id, calendarId: ev.calendarId || 'default', title: ev.title || '새 일정',
                           start: ev.start, end: ev.end, isAllday: !!ev.isAllday,
                           location: ev.location || '', category: ev.isAllday ? 'allday' : 'time' };
        calendar.createEvents([newEvent]); upsert(newEvent);
      });
      calendar.on('beforeUpdateEvent', ({ event, changes }) => {
        calendar.updateEvent(event.id, event.calendarId, changes); upsert({ ...event, ...changes });
      });
      calendar.on('beforeDeleteEvent', ({ id, calendarId }) => { calendar.deleteEvent(id, calendarId); remove(id, calendarId); });

      // ── 범위 표시 & 내비 ──
      const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const updateRange = () => { const s = calendar.getDateRangeStart(), e = calendar.getDateRangeEnd(); rangeEl.textContent = `${fmt(s)} ~ ${fmt(e)}`; };
      updateRange();

      document.getElementById('btnPrev').addEventListener('click', () => { calendar.prev(); updateRange(); });
      document.getElementById('btnToday').addEventListener('click', () => { calendar.today(); updateRange(); });
      document.getElementById('btnNext').addEventListener('click', () => { calendar.next(); updateRange(); });
      document.querySelectorAll('button[data-view]').forEach(b=>{
        b.addEventListener('click', () => { calendar.changeView(b.dataset.view); updateRange(); });
      });

      // ── 컴팩트 토글 ──
      document.getElementById('btnDensity').addEventListener('click', () => {
        compact = !compact;
        calendar.setOptions?.({
          month: { visibleEventCount: compact ? 3 : 5 },
          week:  { hourStart: compact ? 9 : 8, hourEnd: compact ? 19 : 21 }
        });
        document.getElementById('btnDensity').textContent = compact ? '컴팩트' : '보통';
      });

      // ── 뒤로/메인 + 키보드 ──
      const goHome = () => location.href = '../';
      const goBack = () => (history.length > 1) ? history.back() : goHome();
      document.getElementById('btnHome').addEventListener('click', (e)=>{ e.preventDefault(); goHome(); });
      document.getElementById('btnBack').addEventListener('click', goBack);
      window.addEventListener('keydown', (e) => {
        const k = e.key.toLowerCase?.() || e.key;
        if (k === 'h') { e.preventDefault(); goHome(); }
        else if (e === 'escape' || k === 'backspace') { e.preventDefault(); goBack(); }
        else if (k === 't') { e.preventDefault(); calendar.today(); updateRange(); }
      }, { passive:false });

      // ── 안전 렌더 ──
      const safeRender = () => { try { calendar.render(); } catch(e){} };
      window.addEventListener('load', safeRender);
      new ResizeObserver(safeRender).observe(el);
    }
  </script>
</body>
</html>
