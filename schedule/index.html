<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Schedule</title>

<!-- 1) Toast UI Calendar CSS (v2.1.3) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.css">

<!-- 2) Popupìš© Date/Time picker CSS (í•„ìˆ˜) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.5/dist/tui-time-picker.min.css">

<style>
  :root{
    /* ë¼ì´íŠ¸ ê¸°ë³¸ê°’ */
    --cal-bg: #ffffff;
    --cal-fg: #0f1720;
    --cal-grid: #e5e7eb;
    --cal-subgrid: #f2f4f7;
    --toolbar-bg: #0f1720;
    --toolbar-fg: #e8f0f3;
  }
  [data-theme="dark"]{
    --cal-bg: #0b1217;
    --cal-fg: #e6eef2;
    --cal-grid: #23323c;
    --cal-subgrid: #16232b;
    --toolbar-bg: #0b1217;
    --toolbar-fg: #dce7ee;
  }
  /* ìƒë‹¨ ë°” */
  .bar{position:sticky;top:0;z-index:5;display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;background:var(--toolbar-bg);color:var(--toolbar-fg);box-shadow:0 1px 0 rgba(255,255,255,.06) inset}
  .bar button{all:unset;cursor:pointer;border:1px solid rgba(255,255,255,.18);padding:.35rem .6rem;border-radius:.75rem}
  .bar button:hover{background:rgba(255,255,255,.08)}
  .sp{flex:1}
  body{margin:0;background:var(--cal-bg);color:var(--cal-fg);font:14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo","Malgun Gothic","ë§‘ì€ ê³ ë”•", sans-serif}

  /* ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ */
  #calendar{height:calc(100vh - 52px);}

  /* â€”â€”â€” ë¼ì´íŠ¸/ë‹¤í¬ê°€ â€œì‹¤ì œ ìº˜ë¦°ë” ë‚´ë¶€â€ê¹Œì§€ ë¨¹ë„ë¡ ìµœì†Œ ì…€/ê·¸ë¦¬ë“œ ë°°ê²½ê³¼ ì„ ë§Œ í™•ì‹¤íˆ ì˜¤ë²„ë¼ì´ë“œ â€”â€”â€” */
  #calendar,
  #calendar .toastui-calendar,
  #calendar .toastui-calendar-layout,
  #calendar .toastui-calendar-panel,
  #calendar .toastui-calendar-month,
  #calendar .toastui-calendar-week,
  #calendar .toastui-calendar-day,
  #calendar .toastui-calendar-timegrid,
  #calendar .toastui-calendar-daygrid,
  #calendar .toastui-calendar-allday,
  #calendar .toastui-calendar-grid {
    background: var(--cal-bg) !important;
    color: var(--cal-fg) !important;
  }
  /* ê²©ìì„ /í…Œë‘ë¦¬ */
  #calendar .toastui-calendar-gridline,
  #calendar .toastui-calendar-grid-cell,
  #calendar .toastui-calendar-dayname,
  #calendar .toastui-calendar-panel>.toastui-calendar-panel:not(.toastui-calendar-panel--resizer) {
    border-color: var(--cal-grid) !important;
  }
  /* ì‹œê°„ ê·¸ë¦¬ë“œì˜ ì˜…ì€ ë³´ì¡°ì„  */
  #calendar .toastui-calendar-timegrid-hourline,
  #calendar .toastui-calendar-timegrid-halfhourline {
    border-color: var(--cal-subgrid) !important;
  }
</style>
</head>
<body data-theme="dark"><!-- ê¸°ë³¸ ë‹¤í¬ -->

  <div class="bar">
    <button onclick="history.back()">â† ë’¤ë¡œ</button>
    <button onclick="location.href='/'">ğŸ  ë©”ì¸</button>
    <button onclick="cal.prev()">â—€ ì´ì „</button>
    <button onclick="cal.today()">ì˜¤ëŠ˜</button>
    <button onclick="cal.next()">ë‹¤ìŒ â–¶</button>
    <div class="sp"></div>
    <button id="view-month">ì›”</button>
    <button id="view-week">ì£¼</button>
    <button id="view-day">ì¼</button>
    <button id="compact-toggle">ì»´íŒ©íŠ¸</button>
    <button id="theme-toggle">ë¼ì´íŠ¸/ë‹¤í¬</button>
    <button id="add-btn">+ ìƒˆ ì¼ì •</button>
  </div>

  <div id="calendar"></div>

  <!-- JS: Calendar ë³¸ì²´ + íŒì—… ì˜ì¡´ì„± -->
  <script src="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-date-picker@4.3.0/dist/tui-date-picker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tui-time-picker@2.1.5/dist/tui-time-picker.min.js"></script>

  <script>
    // UMD ì „ì—­ ì°¾ê¸° (í™˜ê²½ë³„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì°¨ì´ ë°©ì§€)
    const CalendarCtor = (window.toastui && window.toastui.Calendar) || (window.tui && window.tui.Calendar) || window.Calendar;
    if (!CalendarCtor) {
      alert('ìº˜ë¦°ë” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n(ê´‘ê³  ì°¨ë‹¨ê¸°ì—ì„œ jsDelivr/unpkg ì°¨ë‹¨í•´ì œ í•„ìš”)');
    }

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
    const STORE_KEY = '__tui_events__';
    const loadEvents = () => {
      try { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }
      catch { return []; }
    };
    const saveEvents = (events) => localStorage.setItem(STORE_KEY, JSON.stringify(events));

    // ì¹´í…Œê³ ë¦¬(ìº˜ë¦°ë” ê·¸ë£¹)
    const calendars = [
      { id:'personal', name:'ê°œì¸', backgroundColor:'#22c55e', borderColor:'#22c55e' },
      { id:'project',  name:'í”„ë¡œì íŠ¸', backgroundColor:'#3b82f6', borderColor:'#3b82f6' },
      { id:'deadline', name:'ë§ˆê°', backgroundColor:'#ef4444', borderColor:'#ef4444' }
    ];

    // ì¸ìŠ¤í„´ìŠ¤
    const cal = new CalendarCtor('#calendar', {
      defaultView: 'month',
      isReadOnly: false,
      usageStatistics: false,
      calendars,
      // íŒì—… í™œì„±í™” (ê³µì‹ ì˜µì…˜)
      useFormPopup: true,
      useDetailPopup: true,
      // ê·¸ë¦¬ë“œ ì„ íƒ(í´ë¦­/ë”ë¸”í´ë¦­ë¡œ ë²”ìœ„ ì„ íƒ)
      month: { gridSelection: { enableClick: true, enableDbClick: true } },
      week:  { gridSelection: { enableClick: true, enableDbClick: true }, hourStart: 8, hourEnd: 22 },
    });

    // ì´ˆê¸° ë°ì´í„° ì ìš©
    const seed = loadEvents();
    if (seed.length === 0) {
      const today = new Date();
      const iso = (d)=> d.toISOString().slice(0,19);
      seed.push(
        { id: crypto.randomUUID(), calendarId:'personal', title:'ì˜ˆì‹œ ì¼ì •', start: iso(new Date(today.getFullYear(), today.getMonth(), today.getDate(), 10, 0)), end: iso(new Date(today.getFullYear(), today.getMonth(), today.getDate(), 11, 0)), category:'time' }
      );
      saveEvents(seed);
    }
    cal.createEvents(seed);

    // â€”â€”â€” íŒì—… í†µí•´ "ì €ì¥" ì‹œ: ì‹¤ì œ ì´ë²¤íŠ¸ ìƒì„±/ê°±ì‹ /ì‚­ì œ â€”â€”â€”
    cal.on('beforeCreateEvent', (ev) => {
      const evObj = {
        id: crypto.randomUUID(),
        calendarId: ev.calendarId || 'personal',
        title: ev.title || '(ì œëª© ì—†ìŒ)',
        start: ev.start.toDate ? ev.start.toDate() : ev.start,
        end:   ev.end.toDate   ? ev.end.toDate()   : ev.end,
        isAllday: !!ev.isAllday,
        category: ev.isAllday ? 'allday' : 'time'
      };
      cal.createEvents([evObj]);

      const all = loadEvents(); all.push({
        ...evObj,
        start: new Date(evObj.start).toISOString(),
        end:   new Date(evObj.end).toISOString()
      });
      saveEvents(all);
    });

    cal.on('beforeUpdateEvent', ({ event, changes }) => {
      cal.updateEvent(event.id, event.calendarId, changes);
      const all = loadEvents().map(e => {
        if (e.id === event.id) {
          return {
            ...e,
            ...changes,
            start: new Date(changes.start ?? e.start).toISOString(),
            end:   new Date(changes.end   ?? e.end).toISOString()
          };
        }
        return e;
      });
      saveEvents(all);
    });

    cal.on('beforeDeleteEvent', ({ id, calendarId }) => {
      cal.deleteEvent(id, calendarId);
      saveEvents(loadEvents().filter(e => !(e.id === id && e.calendarId === calendarId)));
    });

    // â€”â€”â€” ìƒë‹¨ ë²„íŠ¼ â€”â€”â€”
    document.getElementById('view-month').onclick = () => cal.changeView('month');
    document.getElementById('view-week').onclick  = () => cal.changeView('week');
    document.getElementById('view-day').onclick   = () => cal.changeView('day');

    // ì»´íŒ©íŠ¸(ì‹œê°„ ê·¸ë¦¬ë“œ ì¤„ ê°„ê²©ë§Œ ì¡°ì •)
    let compact = false;
    document.getElementById('compact-toggle').onclick = () => {
      compact = !compact;
      document.getElementById('calendar').style.setProperty('--tui-hour-height', compact ? '28px' : '48px');
      // ë‚´ë¶€ í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ê±´ë“œë¦¬ì§€ ì•Šê³  ì‹œê°ì  ë†’ì´ë§Œ ì¶•ì†Œ
      const root = document.querySelector('#calendar');
      root.style.setProperty('--tui-hour-font', compact ? '11px' : '12px');
      root.querySelectorAll('.toastui-calendar-timegrid-time').forEach(el=>{
        el.style.fontSize = compact ? '11px' : '12px';
      });
    };

    // ë¼ì´íŠ¸/ë‹¤í¬ ì „í™˜: body data-theme í† ê¸€ + ì¬ë Œë”
    document.getElementById('theme-toggle').onclick = () => {
      const b = document.body;
      b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      cal.render(); // ì‚¬ì´ì¦ˆ ê³„ì‚° ë‹¤ì‹œ
    };

    // â€œ+ ìƒˆ ì¼ì •â€ ë²„íŠ¼ â†’ ê¸°ë³¸ í¼ íŒì—… ì—´ê¸° (API ì œê³µ)
    // openFormPopupì€ v2ì—ì„œ ê³µì‹ ë©”ì„œë“œì…ë‹ˆë‹¤. :contentReference[oaicite:1]{index=1}
    document.getElementById('add-btn').onclick = () => {
      const now = new Date();
      cal.openFormPopup({
        title: '',
        start: now,
        end: new Date(now.getTime() + 60*60*1000),
        isAllday: false,
        calendarId: 'personal'
      });
    };
  </script>
</body>
</html>
