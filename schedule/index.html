<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>캠페인 일정</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/locales-all.global.min.js"></script>

<style>
  :root{
    --bg:#0c171b; --card:#0b1220; --line:#20304f; --text:#e6eef2; --muted:#a6b3c2;
    --accent:#58a6ff; --danger:#ff6b6b; --ok:#57d19a;
    --cal-pad-top: 8px; --cal-pad-right: 14px; --cal-pad-bottom: 14px; --cal-pad-left: 12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Arial;
    color:var(--text);
    background: radial-gradient(1200px 600px at 20% 0%, #0f2530 0%, transparent 60%),
               radial-gradient(1200px 600px at 100% 20%, #101e2a 0%, transparent 60%),
               var(--bg);
  }

  .wrap{max-width:min(1680px, 96vw); margin:22px auto; padding:0 12px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  .title{font-weight:700; font-size:18px}
  .actions{display:flex; gap:8px; flex-wrap:wrap}

  /* 버튼/칩 */
  .btn{
    appearance:none; border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff;
    border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer;
    display:inline-flex; align-items:center; line-height:1;
  }
  .btn:hover{border-color:#38507d}
  .btn-danger{border-color:#5a2a2a; background:#2a1111}
  .btn-danger:hover{border-color:#7d3838}

  .chip{
    display:inline-flex; align-items:center; line-height:1;
    font-size:11px; padding:4px 10px; border-radius:999px;
    border:1px solid #334357; background:#0b1526; color:#cfe2ff;
    vertical-align:middle;
  }

  .grid{display:grid; gap:16px; grid-template-columns:minmax(860px,1.8fr) minmax(420px,1fr)}
  @media (max-width:1200px){ .grid{ grid-template-columns:1fr } }

  .panel{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 18%) , var(--card);
    border:1px solid var(--line); border-radius:16px; overflow:hidden;
    height:calc(100vh - 150px); min-height:620px; box-shadow:0 8px 50px rgba(0,0,0,.25)}
  #calendar{
    position: relative;
    height:100%;
    padding: var(--cal-pad-top) var(--cal-pad-right) var(--cal-pad-bottom) var(--cal-pad-left) !important;
  }

  .navbar{display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--line); background:#0b1220}
  .navbtn{border:1px solid #2a3a58; background:#0c1526; border-radius:8px; color:#cfe2ff; padding:6px 8px; cursor:pointer; font-size:12px; display:inline-flex; align-items:center; line-height:1}
  .navlabel{min-width:120px; text-align:center; font-weight:700}
  select.year, select.month{background:#0c1526; color:#e6eef2; border:1px solid #2a3a58; border-radius:8px; padding:6px 8px; font-size:12px}

  aside{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px;
    min-height:620px; height:calc(100vh - 150px); overflow:auto; box-shadow:0 8px 50px rgba(0,0,0,.25)}
  #detail.collapsed #card{display:none}
  #detail.collapsed #rail{display:grid}
  #detail:not(.collapsed) #rail{display:none}

  .card{background:#0c1526; border:1px solid #213254; border-radius:14px; padding:12px}
  .card + .card{margin-top:12px}
  .card h3{margin:0 0 8px; font-size:14px; letter-spacing:.2px}
  .muted{color:var(--muted); font-size:13px}

  .list{margin:0; padding:0; list-style:none; display:grid; gap:8px}
  .li{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
    padding:8px; border:1px solid #213254; background:#0b1220; border-radius:12px}
  .li .dot{width:8px; height:8px; border-radius:50%}
  .li .title{font-size:13px; font-weight:600}
  .li .sub{font-size:12px; color:#a6b3c2}
  .li .mini-btn{border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff; border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer; display:inline-flex; align-items:center; line-height:1}
  .li .mini-btn:hover{border-color:#38507d}

  .evt-img{width:100%; height:160px; object-fit:cover; border-radius:10px; background:#09121f; margin-bottom:8px}
  .evt-time{font-size:12px; opacity:.85; margin:6px 0}
  .progress{height:8px; background:#122036; border-radius:6px; overflow:hidden}
  .bar{height:100%; width:0%; background:var(--accent)}
  .hint{font-size:12px; opacity:.85}
  .row{display:grid; grid-template-columns:1fr; gap:8px}
  @media (min-width:1400px){ .row{ grid-template-columns:1fr 1fr } }
  .row>*{min-width:0}
  input[type="text"], input[type="url"], input[type="datetime-local"], textarea, select{
    width:100%; padding:10px; border:1px solid #2a3a58; border-radius:10px; background:#0c1526; color:#e6eef2; font-size:14px}
  textarea{min-height:100px; resize:vertical}

  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip-cat{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
    border:1px solid #2a3a58; background:#0b1526; color:#cfe2ff; font-size:12px; cursor:pointer; line-height:1}
  .chip-cat .dot{width:8px; height:8px; border-radius:50%}
  .chip-cat.active{outline:2px solid #35507d}

  /* 공용 모달 */
  .qback{position:fixed; inset:0; display:none; align-items:flex-start; justify-content:flex-start; background:transparent; z-index:9999}
  .qpop{position:absolute; width:min(540px, calc(100vw - 24px)); background:#0b1220; border:1px solid #1e2a41; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.45); padding:12px}
  .qrow{display:grid; grid-template-columns:1fr; gap:8px; margin-top:6px}
  .qrow2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .qtitle{width:100%; padding:10px; border:1px solid #2a3a58; border-radius:10px; background:#0c1526; color:#e6eef2; font-size:14px}
  .qsub{font-size:12px; color:#a6b3c2}
  .qactions{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
  .qpop .btn{padding:8px 10px}
  .qtoggle{display:flex; align-items:center; gap:8px}
  .qtoggle input{accent-color:#58a6ff}

  .cat-row{display:grid; grid-template-columns:1fr 120px 110px auto auto auto; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed #233352}
  .cat-row:last-child{border-bottom:none}
  .pill{font-size:12px; padding:8px; background:#0c1526; border:1px solid #2a3a58; border-radius:8px}
  .color-hex{width:110px; padding:8px; border:1px solid #2a3a58; border-radius:8px; background:#0c1526; color:#e6eef2}
  .ico-btn{border:1px solid #2a3a58; background:#111a2f; color:#cfe2ff; border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer; display:inline-flex; align-items:center; line-height:1}
  .ico-btn:hover{border-color:#38507d}

  .fc .fc-bg-event.holiday{background:rgba(255,107,107,.14)}

  /* 선 잘림 방지 */
  #calendar .fc-scrollgrid{ border:0!important; border-radius:12px!important; overflow:hidden; margin:0!important; background-clip:padding-box; }
  #calendar::after{
    content:""; position:absolute;
    left:var(--cal-pad-left); top:var(--cal-pad-top);
    right:var(--cal-pad-right); bottom:var(--cal-pad-bottom);
    border:1px solid var(--line); border-radius:12px; pointer-events:none;
  }
  .fc-theme-standard td,.fc-theme-standard th{ border-color:var(--line)!important }
  .fc .fc-timegrid-slot,.fc .fc-timegrid-axis{ border-color:var(--line)!important }
  .fc .fc-daygrid-day-frame{ transform:translateZ(0) }

  /* ── 오늘 날짜 하이라이트: 셀만 은은하게 (배지 없음) ── */
  .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-frame,
  .fc .fc-daygrid-day.is-today .fc-daygrid-day-frame{
    background: rgba(88,166,255,.08);
    box-shadow: inset 0 0 0 2px #58a6ff66;
  }
  /* (원형 배지 제거) */
  .fc .fc-daygrid-day.is-today .fc-daygrid-day-number{ color:inherit; font-weight:700 }
  .fc .fc-daygrid-day.is-today .fc-daygrid-day-number::before{ content:none }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">캠페인 일정 <span id="dirty" class="muted"></span></div>
    <div class="actions">
      <button class="btn" id="btnMonth">월간</button>
      <button class="btn" id="btnWeek">주간</button>
      <button class="btn" id="btnList">리스트</button>
      <button class="btn" id="btnToday">오늘</button>
      <button class="btn" id="btnNew">새 일정</button>
      <button class="btn btn-danger" id="btnDel">선택 삭제</button>
      <button class="btn" id="btnSave">GitHub로 저장</button>
      <button class="btn" id="btnBack">뒤로</button>
    </div>
  </header>

  <div class="grid">
    <div class="panel">
      <div class="navbar">
        <button class="navbtn" id="navPrevYear">≪</button>
        <button class="navbtn" id="navPrevMonth">‹</button>
        <div class="navlabel" id="lblYM">YYYY.MM</div>
        <button class="navbtn" id="navNextMonth">›</button>
        <button class="navbtn" id="navNextYear">≫</button>
        <div style="margin-left:auto; display:flex; align-items:center; gap:6px">
          <select id="selYear" class="year"></select>
          <select id="selMonth" class="month"></select>
          <button class="navbtn" id="navJump">이동</button>
        </div>
      </div>
      <div id="calendar"></div>
    </div>

    <aside id="detail" class="collapsed">
      <div id="rail">
        <div class="card">
          <h3>오늘</h3>
          <div id="todayLine" class="muted"></div>
          <div style="display:flex; gap:8px; margin-top:10px; align-items:center">
            <button class="btn" id="btnQuickToday">오늘 20:00로</button>
            <span class="chip" id="chipNow"></span>
          </div>
        </div>

        <div class="card">
          <h3>카테고리</h3>
          <div id="cats" class="chips"></div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="btn" id="btnCatReset">전체 보기</button>
            <button class="btn" id="btnCatManage">색/목록 관리</button>
          </div>
        </div>

        <div class="card">
          <h3>다가오는 일정</h3>
          <ul id="upcoming" class="list"></ul>
        </div>
        <div class="card">
          <h3>이달 통계</h3>
          <div class="muted" id="statsMonth">이달 일정 0건</div>
        </div>
      </div>

      <div id="card" style="display:none">
        <img id="evtImg" class="evt-img" alt="" />
        <div class="row">
          <div>
            <div class="hint">제목</div>
            <input id="fTitle" type="text" placeholder="제목" />
          </div>
          <div>
            <div class="hint">상태</div>
            <select id="fStatus">
              <option value="">(선택)</option>
              <option value="planned">planned</option>
              <option value="ongoing">ongoing</option>
              <option value="done">done</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div>
            <div class="hint">카테고리</div>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="fCat" type="text" list="catlist2" placeholder="예: CoC 7e / 룰: 전투 / 세션" />
              <input id="fCatColor" type="color" title="카테고리 색" />
            </div>
            <datalist id="catlist2"></datalist>
          </div>
          <div>
            <div class="hint">이미지 URL</div>
            <input id="fImage" type="url" placeholder="https://..." />
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div>
            <div class="hint">시작</div>
            <input id="fStart" type="datetime-local" />
          </div>
          <div>
            <div class="hint">종료</div>
            <input id="fEnd" type="datetime-local" />
          </div>
        </div>
        <div style="margin-top:6px">
          <div class="hint">설명</div>
          <textarea id="fDesc" placeholder="세부 내용/링크/메모 등"></textarea>
        </div>
        <div class="evt-time" id="evtTime"></div>
        <div class="progress"><div id="evtProg" class="bar"></div></div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button class="btn" id="btnApply">변경 적용</button>
          <button class="btn btn-danger" id="btnDel2">삭제</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- 퀵 편집 팝업 -->
<div class="qback" id="qback" aria-hidden="true">
  <div class="qpop" id="qpop" role="dialog" aria-modal="true">
    <input id="qTitle" class="qtitle" type="text" placeholder="제목 및 시간 추가" />
    <div class="qrow qtoggle">
      <label><input id="qAllDay" type="checkbox" /> 하루 종일</label>
      <label><input id="qAddTime" type="checkbox" /> 시간 추가</label>
      <span class="qsub" id="qWhenText"></span>
    </div>
    <div class="qrow">
      <div class="qsub">카테고리</div>
      <div style="display:flex; gap:8px; align-items:center">
        <input id="qCat" type="text" list="catlist" placeholder="예: CoC 7e / 룰: 마법 / 세션" />
        <input id="qCatColor" type="color" title="카테고리 색" />
      </div>
      <datalist id="catlist"></datalist>
    </div>
    <div class="qrow2" id="qDates">
      <div><div class="qsub">시작</div><input id="qStartDate" type="date" /></div>
      <div><div class="qsub">종료</div><input id="qEndDate" type="date" /></div>
    </div>
    <div class="qrow2" id="qTimes" style="display:none">
      <div><div class="qsub">시작 시간</div><input id="qStartTime" type="time" value="20:00" /></div>
      <div><div class="qsub">종료 시간</div><input id="qEndTime" type="time" value="22:00" /></div>
    </div>
    <div class="qactions">
      <button class="btn" id="qMore">자세히</button>
      <button class="btn" id="qSave">저장</button>
      <button class="btn" id="qCancel">취소</button>
      <button class="btn btn-danger" id="qDelete" style="display:none">삭제</button>
    </div>
  </div>
</div>

<!-- 카테고리 관리자 -->
<div class="qback" id="catBack" aria-hidden="true">
  <div class="qpop" id="catPop" role="dialog" aria-modal="true" style="width:min(760px, calc(100vw - 24px))">
    <h3 style="margin:0 0 6px">카테고리 색/목록 관리</h3>
    <div class="qsub">HEX(#RRGGBB) 직접 입력 가능. <span id="pickSupport"></span></div>
    <div id="catList" class="qrow" style="max-height:min(60vh,520px); overflow:auto; border:1px solid #1e2a41; border-radius:10px; padding:6px"></div>
    <div class="qrow" style="margin-top:8px">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <input id="newCatName" class="qtitle" type="text" placeholder="새 카테고리 이름" style="max-width:320px" />
        <input id="newCatColor" type="color" value="#58a6ff" />
        <input id="newCatHex" class="color-hex" value="#58A6FF" />
        <button class="ico-btn" id="btnAddCat">추가</button>
      </div>
    </div>
    <div class="qactions">
      <button class="btn" id="catCancel">닫기</button>
      <button class="btn" id="catSave">카테고리 저장(GitHub)</button>
    </div>
  </div>
</div>

<script>
(() => {
  const OWNER='tndnjs0322', REPO='trpg-handouts', BRANCH='main';
  const PATH='data/schedule.json', SRC='../data/schedule.json';
  const CAT_PATH='data/categories.json', CAT_SRC='../data/categories.json';
  const HOLI_SRC='../data/holidays.json', HOLI_CAT='공휴일';

  let calendar, selected=null, dirty=false, editingEvent=null;
  let lastPointer={x:innerWidth/2, y:120};
  let activeCats=new Set(), catColors={}, holidayEvents=[];
  let _fcFirstStateSet=false, _isPopNavigating=false;

  const ymd=d=>{const x=new Date(d),p=n=>String(n).padStart(2,'0');return `${x.getFullYear()}-${p(x.getMonth()+1)}-${p(x.getDate())}`};

  /* el */
  const calEl=document.getElementById('calendar');
  const dirtyEl=document.getElementById('dirty');
  const btnMonth=document.getElementById('btnMonth');
  const btnWeek=document.getElementById('btnWeek');
  const btnList=document.getElementById('btnList');
  const btnToday=document.getElementById('btnToday');
  const btnNew=document.getElementById('btnNew');
  const btnDel=document.getElementById('btnDel');
  const btnSave=document.getElementById('btnSave');
  const btnBack=document.getElementById('btnBack');

  const navPrevYear=document.getElementById('navPrevYear');
  const navPrevMonth=document.getElementById('navPrevMonth');
  const navNextMonth=document.getElementById('navNextMonth');
  const navNextYear=document.getElementById('navNextYear');
  const lblYM=document.getElementById('lblYM');
  const selYear=document.getElementById('selYear');
  const selMonth=document.getElementById('selMonth');
  const navJump=document.getElementById('navJump');

  const detail=document.getElementById('detail');
  const rail=document.getElementById('rail');
  const catsEl=document.getElementById('cats');
  const upcomingEl=document.getElementById('upcoming');
  const todayLine=document.getElementById('todayLine');
  const chipNow=document.getElementById('chipNow');
  const statsMonth=document.getElementById('statsMonth');
  const btnQuickToday=document.getElementById('btnQuickToday');
  const btnCatReset=document.getElementById('btnCatReset');
  const btnCatManage=document.getElementById('btnCatManage');

  const imgEl=document.getElementById('evtImg');
  const fTitle=document.getElementById('fTitle');
  const fStatus=document.getElementById('fStatus');
  const fStart=document.getElementById('fStart');
  const fEnd=document.getElementById('fEnd');
  const fImage=document.getElementById('fImage');
  const fDesc=document.getElementById('fDesc');
  const fCat=document.getElementById('fCat');
  const fCatColor=document.getElementById('fCatColor');
  const evtTime=document.getElementById('evtTime');
  const evtProg=document.getElementById('evtProg');
  const btnApply=document.getElementById('btnApply');
  const btnDel2=document.getElementById('btnDel2');

  const qback=document.getElementById('qback');
  const qpop=document.getElementById('qpop');
  const qTitle=document.getElementById('qTitle');
  const qAllDay=document.getElementById('qAllDay');
  const qAddTime=document.getElementById('qAddTime');
  const qWhenText=document.getElementById('qWhenText');
  const qDates=document.getElementById('qDates');
  const qTimes=document.getElementById('qTimes');
  const qStartDate=document.getElementById('qStartDate');
  const qEndDate=document.getElementById('qEndDate');
  const qStartTime=document.getElementById('qStartTime');
  const qEndTime=document.getElementById('qEndTime');
  const qSave=document.getElementById('qSave');
  const qCancel=document.getElementById('qCancel');
  const qDelete=document.getElementById('qDelete');
  const qMore=document.getElementById('qMore');
  const qCat=document.getElementById('qCat');
  const qCatColor=document.getElementById('qCatColor');
  const catlist=document.getElementById('catlist');
  const catlist2=document.getElementById('catlist2');

  const catBack=document.getElementById('catBack');
  const catPop=document.getElementById('catPop');
  const catList=document.getElementById('catList');
  const catCancel=document.getElementById('catCancel');
  const catSaveBtn=document.getElementById('catSave');
  const newCatName=document.getElementById('newCatName');
  const newCatColor=document.getElementById('newCatColor');
  const newCatHex=document.getElementById('newCatHex');
  const btnAddCat=document.getElementById('btnAddCat');
  const pickSupport=document.getElementById('pickSupport');

  document.addEventListener('pointerdown',e=>{lastPointer={x:e.clientX,y:e.clientY}},{passive:true});
  function markDirty(v=true){ dirty=v; dirtyEl.textContent=v?'· 수정됨':'' }
  window.addEventListener('beforeunload',e=>{ if(dirty){ e.preventDefault(); e.returnValue=''; }});

  Promise.all([
    fetch(SRC,{cache:'no-store'}).then(r=>r.ok?r.json():[]).catch(()=>[]),
    fetch(CAT_SRC,{cache:'no-store'}).then(r=>r.ok?r.json():{}).catch(()=>({})),
    fetch(HOLI_SRC,{cache:'no-store'}).then(r=>r.ok?r.json():[]).catch(()=>[])
  ]).then(([events,colors,holidays])=>{
    catColors=colors||{}; holidayEvents=Array.isArray(holidays)?holidaysToEvents(holidays):[];
    initCalendar(Array.isArray(events)?events:[]);
  });

  const PALETTE=['#57d19a','#58a6ff','#b08ad6','#ef7d7d','#f6c951','#6adcb3','#96a6ff','#ffb86c','#ff99cc','#8bd3dd','#a5ffd6','#c792ea','#9cdcfe'];
  function catColor(name){ if(name&&catColors[name]) return catColors[name];
    if(!name) return '#8892a6'; let h=0; for(const ch of name){h=(h<<5)-h+ch.charCodeAt(0);h|=0} return PALETTE[Math.abs(h)%PALETTE.length] }
  function normalizeHex(s){ if(!s) return null; let v=s.trim().toUpperCase(); if(!v.startsWith('#')) v='#'+v; return /^#[0-9A-F]{6}$/.test(v)?v:null }
  const pad=n=>String(n).padStart(2,'0');
  function toLocalInput(dt){ if(!dt) return ''; const d=new Date(dt); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}` }
  function toKSTISO(dt){ if(!dt) return null; const d=new Date(dt); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}+09:00` }
  function fromLocalInput(str){ return str? new Date(str.replace('T',' ')+':00'):null }
  function fmtKST(d){ return new Date(d).toLocaleString('ko-KR',{timeZone:'Asia/Seoul'}) }
  function isoDate(d){ const x=new Date(d); return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}` }
  function hhmm(d){ const x=new Date(d); return `${pad(x.getHours())}:${pad(x.getMinutes())}` }
  function parseDateTime(d,t){ if(!d) return null; const s=t||'00:00'; return new Date(`${d}T${s}:00`) }
  function parseDateOnly(s){ if(!s) return null; const [y,m,dd]=s.split('-').map(Number); return new Date(y,m-1,dd) }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x }
  function escapeHtml(s){ return s==null?'':s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&gt;','>':'&lt;','"':'&quot;', "'":'&#39;' }[c])) }
  function roundToNextHalfHour(d){ const x=new Date(d); x.setSeconds(0,0); const m=x.getMinutes(); x.setMinutes(m<30?30:60); return x }
  function isYMD(s){ return typeof s==='string' && /^\d{4}-\d{2}-\d{2}$/.test(s) }

  function holidaysToEvents(list){
    const arr=[]; for(const h of list){
      const s=parseDateOnly(h.date), e=parseDateOnly(h.end||h.date); if(!s||!e) continue;
      const sStr=isoDate(s), eStr=isoDate(addDays(e,1));
      arr.push({id:`hb-${sStr}`, title:h.title||HOLI_CAT, start:sStr, end:eStr, allDay:true, display:'background', classNames:['holiday'], editable:false, extendedProps:{category:HOLI_CAT}});
      arr.push({id:`ht-${sStr}`, title:h.title||HOLI_CAT, start:sStr, end:eStr, allDay:true, editable:false, extendedProps:{category:HOLI_CAT}});
    } return arr;
  }

  function toFCEvt(ev){
    const base={ id:ev.id||`e-${Math.random().toString(36).slice(2,8)}`, title:ev.title||'(제목 없음)',
      extendedProps:{ image:ev.image||'', desc:ev.desc||'', status:ev.status||'', category:ev.category||'' } };
    if(ev.allDay){
      const s=isYMD(ev.start)?ev.start:isoDate(new Date(ev.start));
      const e=ev.end?(isYMD(ev.end)?ev.end:isoDate(new Date(ev.end))):undefined;
      return {...base, allDay:true, start:s, end:e};
    }
    return {...base, allDay:false, start:ev.start, end:ev.end};
  }

  function initCalendar(events){
    calendar=new FullCalendar.Calendar(calEl,{
      locale:'ko', timeZone:'Asia/Seoul', height:'100%',
      now: () => new Date(),
      initialView:'dayGridMonth', headerToolbar:false,
      progressiveEventRendering:true, editable:true, selectable:true, selectMirror:true,
      events:[...holidayEvents, ...events.map(toFCEvt)],
      datesSet:(info)=>{
        updateYMBar(info);
        applyTodayHighlight();
        if(_isPopNavigating){ _isPopNavigating=false; return; }
        const st={view:info.view.type, date:ymd(calendar.getDate())};
        if(_fcFirstStateSet) history.pushState(st,'',''); else { history.replaceState(st,'',''); _fcFirstStateSet=true; }
      },
      dateClick:(info)=>openQuick({anchor:info.jsEvent,start:parseDateOnly(info.dateStr),end:parseDateOnly(info.dateStr),allDay:true,title:''}),
      select:(info)=>{
        const allDay=info.allDay ?? (calendar.view.type==='dayGridMonth');
        const s=allDay?parseDateOnly(info.startStr):info.start;
        const e=allDay?parseDateOnly(info.endStr):info.end;
        openQuick({anchor:null,start:s,end:allDay?addDays(e,-1):e,allDay,title:''});
        calendar.unselect();
      },
      eventClick:(info)=>{
        if(info.event.extendedProps?.category===HOLI_CAT) return;
        openQuick({anchor:info.jsEvent,start:info.event.start,end:info.event.end||info.event.start,allDay:info.event.allDay,title:info.event.title,event:info.event});
      },
      eventDrop:()=>{markDirty();updatePreview();renderRail();},
      eventResize:()=>{markDirty();updatePreview();renderRail();},
      eventsSet:()=>{renderRail();renderCatUI();},
      eventDidMount:(info)=>{
        const cat=info.event.extendedProps?.category||''; const col=catColor(cat);
        const dot=info.el.querySelector('.fc-daygrid-event-dot');
        if(dot){ dot.style.borderColor=col; dot.style.backgroundColor=col; }
        info.el.style.borderLeft=`4px solid ${col}`;
      }
    });
    calendar.render();
    applyTodayHighlight();

    history.replaceState({view:calendar.view.type, date:ymd(calendar.getDate())}, '', ''); _fcFirstStateSet=true;
    window.addEventListener('popstate',e=>{
      if(!e.state) return; _isPopNavigating=true;
      try{
        const {view,date}=e.state;
        if(view&&date) calendar.changeView(view,new Date(date));
        else if(date) calendar.gotoDate(new Date(date));
        else if(view) calendar.changeView(view);
      }finally{ setTimeout(()=>{_isPopNavigating=false; applyTodayHighlight();},0); }
    });

    btnMonth.onclick=()=>{ calendar.changeView('dayGridMonth'); setTimeout(applyTodayHighlight,0); };
    btnWeek.onclick =()=>{ calendar.changeView('timeGridWeek'); };
    btnList.onclick =()=>{ calendar.changeView('listMonth'); };
    btnToday.onclick=()=>{ calendar.today(); setTimeout(applyTodayHighlight,0); };
    btnNew.onclick  =()=>{const s=roundToNextHalfHour(new Date()); openQuick({anchor:null,start:s,end:new Date(s.getTime()+2*3600*1000),allDay:false,title:''});};
    btnDel.onclick  =()=>{ if(selected){ if(confirm('선택된 일정을 삭제할까요?')){ selected.remove(); clearDetail(); markDirty(); renderRail(); renderCatUI(); } } else alert('선택된 일정이 없습니다.'); };
    btnDel2.onclick =()=>btnDel.onclick();
    btnSave.onclick =saveAllToGitHub;
    btnBack.addEventListener('click',e=>{e.preventDefault(); history.back();});

    btnQuickToday.onclick=()=>{ const base=new Date(); base.setHours(20,0,0,0);
      openQuick({anchor:null,start:base,end:new Date(base.getTime()+2*3600*1000),allDay:false,title:''}); };
    btnCatReset.onclick =()=>{activeCats.clear();applyCategoryFilter();updateCatChipActive();};
    btnCatManage.onclick=()=>openCatManager();

    navPrevYear.onclick =()=>{const d=calendar.getDate(); calendar.gotoDate(new Date(d.getFullYear()-1,d.getMonth(),1));};
    navPrevMonth.onclick=()=>calendar.prev();
    navNextMonth.onclick=()=>calendar.next();
    navNextYear.onclick =()=>{const d=calendar.getDate(); calendar.gotoDate(new Date(d.getFullYear()+1,d.getMonth(),1));};
    navJump.onclick     =()=>{const y=+selYear.value, m=(+selMonth.value)-1; if(y&&m>=0) calendar.gotoDate(new Date(y,m,1)); };

    const curY=new Date().getFullYear();
    for(let y=curY-5;y<=curY+5;y++){ const o=document.createElement('option'); o.value=y; o.textContent=`${y}년`; selYear.appendChild(o); }
    for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=m; o.textContent=`${m}월`; selMonth.appendChild(o); }

    updateYMBar(); renderRail(); renderCatUI();
  }

  function updateYMBar(){
    const d=calendar.getDate(), p=n=>String(n).padStart(2,'0');
    lblYM.textContent=`${d.getFullYear()}.${p(d.getMonth()+1)}`;
    selYear.value=d.getFullYear(); selMonth.value=(d.getMonth()+1);
  }

  /* 오늘 셀 하이라이트 클래스 부여 */
  function applyTodayHighlight(){
    const today=new Date();
    const y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
    const key=`${y}-${m}-${d}`;
    calEl.querySelectorAll('.fc-daygrid-day.is-today').forEach(el=>el.classList.remove('is-today'));
    const el=calEl.querySelector(`.fc-daygrid-day[data-date="${key}"]`);
    if(el) el.classList.add('is-today');
  }

  /* Quick 팝업 등 이하 동일… (기능은 기존과 동일) */

  /* --- 이하 스크립트는 이전 메시지와 동일하니 생략 없이 그대로 붙여둠 --- */
  /* Quick */
  function openQuick({anchor,start,end,allDay,title,event=null}){
    editingEvent=event;
    qTitle.value=title||'';
    qAllDay.checked=!!allDay; qAddTime.checked=!allDay;
    const s=new Date(start); let e=new Date(end||start); if(event&&allDay&&event.end) e=addDays(event.end,-1);
    if(allDay){ qTimes.style.display='none'; qStartDate.value=isoDate(s); qEndDate.value=isoDate(e); }
    else{ qTimes.style.display=''; qStartDate.value=isoDate(s); qEndDate.value=isoDate(e); qStartTime.value=hhmm(s); qEndTime.value=hhmm(e); }
    const catName=event?.extendedProps?.category||''; qCat.value=catName; qCatColor.value=normalizeHex(catColor(catName))||'#58A6FF';
    populateCatDatalists(); updateWhenText();
    const x=anchor?.clientX??lastPointer.x, y=anchor?.clientY??lastPointer.y, pad=12, width=Math.min(540,innerWidth-24);
    qpop.style.left=Math.max(12,Math.min(x+10,innerWidth-width-pad))+'px';
    qpop.style.top =Math.max(12,Math.min(y-10,innerHeight-320))+'px';
    qDelete.style.display=editingEvent?'':'none';
    qback.style.display='flex'; qback.setAttribute('aria-hidden','false'); setTimeout(()=>qTitle.focus(),0);
  }
  function closeQuick(){ qback.style.display='none'; qback.setAttribute('aria-hidden','true'); }
  qCancel.onclick=closeQuick; qback.addEventListener('click',e=>{ if(e.target===qback) closeQuick(); });
  qAllDay.addEventListener('change',()=>{ qAddTime.checked=!qAllDay.checked; qTimes.style.display=qAddTime.checked?'':''; updateWhenText(); });
  qAddTime.addEventListener('change',()=>{ qAllDay.checked=!qAddTime.checked; qTimes.style.display=qAddTime.checked?'':''; if(qAddTime.checked&&!qStartTime.value) qStartTime.value='20:00'; if(qAddTime.checked&&!qEndTime.value) qEndTime.value='22:00'; updateWhenText(); });
  [qStartDate,qEndDate,qStartTime,qEndTime].forEach(el=>el.addEventListener('input',updateWhenText));
  qCat.addEventListener('input',()=>{ qCatColor.value=normalizeHex(catColor(qCat.value))||'#58A6FF'; });
  qCatColor.addEventListener('input',()=>{ const nm=(qCat.value||'').trim(); const hx=normalizeHex(qCatColor.value); if(nm&&hx){ catColors[nm]=hx; refreshEvents(); renderCatUI(); }});
  qSave.addEventListener('click',()=>{
    const title=qTitle.value.trim()||'(제목 없음)'; const allDay=qAllDay.checked; const category=qCat.value.trim();
    const chosen=normalizeHex(qCatColor.value); if(category&&chosen) catColors[category]=chosen;
    if(allDay){
      const sDay=parseDateOnly(qStartDate.value); const eDay=parseDateOnly(qEndDate.value||qStartDate.value); if(!sDay||!eDay) return alert('날짜를 확인해 주세요.');
      const startStr=isoDate(sDay), endExStr=isoDate(addDays(eDay,1));
      if(editingEvent){ editingEvent.setAllDay(true); editingEvent.setStart(startStr,{maintainDuration:false}); editingEvent.setEnd(endExStr); editingEvent.setExtendedProp('category',category); markDirty(); selectEvent(editingEvent); }
      else{ calendar.addEvent({id:`e-${Date.now().toString(36)}`, title, allDay:true, start:startStr, end:endExStr, extendedProps:{category}}); markDirty(); }
    }else{
      const s=parseDateTime(qStartDate.value,qStartTime.value||'20:00'); const e=parseDateTime(qEndDate.value||qStartDate.value,qEndTime.value||'22:00');
      if(!s||!e) return alert('날짜/시간을 확인해 주세요.'); if(e<=s) return alert('종료가 시작보다 빠를 수 없어요.');
      if(editingEvent){ editingEvent.setAllDay(false); editingEvent.setStart(s,{maintainDuration:false}); editingEvent.setEnd(e); editingEvent.setExtendedProp('category',category); markDirty(); selectEvent(editingEvent); }
      else{ calendar.addEvent({id:`e-${Date.now().toString(36)}`, title, allDay:false, start:s, end:e, extendedProps:{category}}); markDirty(); }
    }
    closeQuick(); renderRail(); renderCatUI(); applyCategoryFilter(); refreshEvents();
  });
  qDelete.addEventListener('click',()=>{ if(!editingEvent) return; if(confirm('이 일정을 삭제할까요?')){ editingEvent.remove(); if(selected&&selected.id===editingEvent.id){ clearDetail(); } editingEvent=null; markDirty(); closeQuick(); renderRail(); renderCatUI(); applyCategoryFilter(); refreshEvents(); }});
  qMore.addEventListener('click',()=>{ if(editingEvent){ selectEvent(editingEvent,{expandDetail:true}); } closeQuick(); });
  function updateWhenText(){ const allDay=qAllDay.checked, sd=qStartDate.value, ed=qEndDate.value||sd; if(!sd){qWhenText.textContent=''; return;}
    if(allDay) qWhenText.textContent=`${sd} ~ ${ed} (하루 종일)`; else { const st=qStartTime.value||'20:00', et=qEndTime.value||'22:00'; qWhenText.textContent=`${sd} ${st} ~ ${ed} ${et}`; } }

  /* Detail */
  function selectEvent(ev,opts={}){ selected=ev; if(opts.expandDetail) detail.classList.remove('collapsed'); rail.style.display='none'; document.getElementById('card').style.display='';
    fTitle.value=ev.title||''; fStatus.value=ev.extendedProps?.status||''; fStart.value=toLocalInput(ev.start); fEnd.value=toLocalInput(ev.end||ev.start);
    fImage.value=ev.extendedProps?.image||''; fDesc.value=ev.extendedProps?.desc||''; const catName=ev.extendedProps?.category||''; fCat.value=catName; fCatColor.value=normalizeHex(catColor(catName))||'#58A6FF'; populateCatDatalists(); updatePreview(); }
  function clearDetail(){ selected=null; document.getElementById('card').style.display='none'; rail.style.display='grid'; imgEl.removeAttribute('src'); }
  fCat.addEventListener('input',()=>{ fCatColor.value=normalizeHex(catColor(fCat.value))||'#58A6FF'; });
  fCatColor.addEventListener('input',()=>{ const nm=(fCat.value||'').trim(); const hx=normalizeHex(fCatColor.value); if(nm&&hx){ catColors[nm]=hx; refreshEvents(); renderCatUI(); }});
  btnApply.onclick=()=>{ if(!selected) return alert('선택된 일정이 없습니다.');
    const title=fTitle.value.trim(), start=fromLocalInput(fStart.value), end=fromLocalInput(fEnd.value);
    if(!title||!start||!end) return alert('제목/시작/종료는 필수입니다.'); if(new Date(start)>new Date(end)) return alert('종료가 시작보다 빠를 수 없어요.');
    selected.setProp('title',title); selected.setStart(new Date(start)); selected.setEnd(new Date(end));
    selected.setExtendedProp('image',fImage.value.trim()); selected.setExtendedProp('desc',fDesc.value); selected.setExtendedProp('status',fStatus.value); selected.setExtendedProp('category',fCat.value.trim());
    const hx=normalizeHex(fCatColor.value); if(fCat.value.trim()&&hx) catColors[fCat.value.trim()]=hx;
    updatePreview(); markDirty(); alert('적용 완료(임시). 상단 "GitHub로 저장"을 눌러 커밋하세요!'); renderRail(); renderCatUI(); applyCategoryFilter(); refreshEvents(); };
  function updatePreview(){ if(!selected) return; const p=selected.extendedProps||{}; if(p.image){ imgEl.src=p.image; imgEl.style.display=''; } else { imgEl.removeAttribute('src'); imgEl.style.display='none'; } evtTime.textContent=[selected.start,selected.end||selected.start].filter(Boolean).map(fmtKST).join(' ~ ');
    if(selected.start&&(selected.end||selected.start)){ const now=new Date(), s=new Date(selected.start), e=new Date(selected.end||selected.start);
      if(now<s) evtProg.style.width='0%'; else if(now>e) evtProg.style.width='100%'; else evtProg.style.width=Math.min(100,Math.max(0,(now-s)/(e-s)*100)).toFixed(0)+'%'; } else evtProg.style.width='0%'; }

  /* Categories */
  function catUnion(){ const set=new Set(Object.keys(catColors)); calendar?.getEvents().forEach(ev=>{ const c=(ev.extendedProps?.category||'').trim(); if(c)set.add(c); else set.add('미분류'); }); set.delete(''); return [...set].sort((a,b)=>a.localeCompare(b,'ko')); }
  function renderCatUI(){ const cats=catUnion(); catsEl.innerHTML=cats.map(name=>{ const real=(name==='미분류')?'':name; const color=catColor(real); const active=activeCats.size&&activeCats.has(real);
      return `<button class="chip-cat ${active?'active':''}" data-cat="${escapeHtml(real)}"><span class="dot" style="background:${color}"></span>${escapeHtml(name)}</button>`; }).join('');
    catsEl.querySelectorAll('.chip-cat').forEach(btn=>{ btn.onclick=()=>{ const cat=btn.dataset.cat||''; if(activeCats.has(cat)) activeCats.delete(cat); else activeCats.add(cat); applyCategoryFilter(); updateCatChipActive(); }; });
    populateCatDatalists();
  }
  function updateCatChipActive(){ catsEl.querySelectorAll('.chip-cat').forEach(btn=>{ const cat=btn.dataset.cat||''; btn.classList.toggle('active',activeCats.size&&activeCats.has(cat)); }); }
  function applyCategoryFilter(){ const showAll=activeCats.size===0; calendar.getEvents().forEach(ev=>{ const c=(ev.extendedProps?.category||''); ev.setProp('display', showAll||activeCats.has(c)?'auto':'none'); }); renderRail(); }
  function populateCatDatalists(){ const cats=catUnion().filter(v=>v!=='미분류'); catlist.innerHTML=cats.map(c=>`<option value="${escapeHtml(c)}">`).join(''); catlist2.innerHTML=cats.map(c=>`<option value="${escapeHtml(c)}">`).join(''); }

  /* Rail */
  function renderRail(){
    const now=new Date(); chipNow.textContent=now.toLocaleString('ko-KR',{timeZone:'Asia/Seoul',hour:'2-digit',minute:'2-digit'});
    const todayStr=isoDate(now);
    const todays=calendar.getEvents().filter(ev=>{
      if(ev.display==='none') return false;
      if(ev.allDay){ const s=typeof ev.start==='string'?ev.start:isoDate(ev.start); const e=typeof ev.end==='string'?ev.end:isoDate(ev.end||addDays(ev.start,1)); return s<=todayStr && todayStr<e; }
      else return isoDate(ev.start)===todayStr;
    });
    todayLine.textContent=`${todayStr} · 오늘 일정 ${todays.length}건`;

    const list=getUpcoming(6);
    upcomingEl.innerHTML=list.map(({ev,s,e,span})=>{
      const time=ev.allDay?'하루 종일':`${pad(s.getHours())}:${pad(s.getMinutes())} ~ ${pad(e.getHours())}:${pad(e.getMinutes())}`;
      const sub=`${s.getMonth()+1}월 ${s.getDate()}일 · ${time}${span>1?` · ${span}일`:''}`;
      const cat=(ev.extendedProps?.category||''); const col=catColor(cat);
      return `<li class="li"><span class="dot" style="background:${col}"></span><div><div class="title">${escapeHtml(ev.title||'(제목 없음)')}</div><div class="sub">${escapeHtml(cat||'미분류')} · ${sub}</div></div><button class="mini-btn act" data-id="${ev.id}">열기</button></li>`;
    }).join('') || `<div class="muted">예정된 일정이 없습니다.</div>`;
    upcomingEl.querySelectorAll('.mini-btn').forEach(btn=>{ btn.onclick=()=>{ const ev=calendar.getEventById(btn.dataset.id); if(ev){ selectEvent(ev,{expandDetail:true}); calendar.gotoDate(ev.start); } }; });

    const cur=calendar.getDate(); const mStart=new Date(cur.getFullYear(),cur.getMonth(),1); const mEnd=new Date(cur.getFullYear(),cur.getMonth()+1,1);
    const monthCount=calendar.getEvents().filter(ev=>ev.display!=='none' && ev.start>=mStart && ev.start<mEnd).length;
    statsMonth.textContent=`${cur.getMonth()+1}월 일정 ${monthCount}건`;
  }
  function getUpcoming(limit=6){
    const now=new Date();
    return calendar.getEvents()
      .filter(ev=>ev.display!=='none' && ev.extendedProps?.category!==HOLI_CAT)
      .map(ev=>{
        let s=ev.allDay?(typeof ev.start==='string'?parseDateOnly(ev.start):new Date(ev.start)):new Date(ev.start);
        let e=ev.allDay?(typeof ev.end==='string'?parseDateOnly(ev.end):new Date(ev.end||ev.start)):new Date(ev.end||ev.start);
        if(ev.allDay) e=addDays(e,-1);
        return {ev,s,e,span:Math.max(1,Math.round((e-s)/(24*3600*1000))+1)};
      })
      .filter(o=>o.e>=now).sort((a,b)=>a.s-b.s).slice(0,limit);
  }

  /* 저장 (409 자동 재시도 포함) */
  async function saveAllToGitHub(){
    try{
      const token=prompt('GitHub Personal Access Token(레포 Contents:write 권한):'); if(!token) return;
      const eventsData=calendar.getEvents()
        .filter(ev=>ev.extendedProps?.category!==HOLI_CAT)
        .map(ev=>{
          const category=ev.extendedProps?.category||'';
          if(ev.allDay){
            const sY=isoDate(ev.start), eY=isoDate(ev.end||addDays(ev.start,1));
            return {id:ev.id,title:ev.title,allDay:true,start:sY,end:eY,image:ev.extendedProps?.image||'',desc:ev.extendedProps?.desc||'',status:ev.extendedProps?.status||'',category};
          }
          return {id:ev.id,title:ev.title,allDay:false,start:toKSTISO(ev.start),end:toKSTISO(ev.end||ev.start),image:ev.extendedProps?.image||'',desc:ev.extendedProps?.desc||'',status:ev.extendedProps?.status||'',category};
        });
      await saveFileToGitHub({owner:OWNER,repo:REPO,branch:BRANCH,path:PATH,contentObj:eventsData,token});
      await saveFileToGitHub({owner:OWNER,repo:REPO,branch:BRANCH,path:CAT_PATH,contentObj:catColors,token});
      markDirty(false); alert('커밋 완료! (일정 + 카테고리 색)');
    }catch(err){ console.error(err); alert('저장 실패: '+err.message); }
  }

  async function saveFileToGitHub({owner,repo,branch,path,contentObj,token}){
    const api='https://api.github.com';
    const headers={'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`,'X-GitHub-Api-Version':'2022-11-28','Content-Type':'application/json'};
    const json=JSON.stringify(contentObj,null,2);
    const content = (()=>{ const bytes=new TextEncoder().encode(json); let bin=''; bytes.forEach(b=>bin+=String.fromCharCode(b)); return btoa(bin); })();
    const getUrl=`${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const putUrl=`${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;

    async function getMeta(){ const r=await fetch(getUrl,{headers}); if(r.status===404) return null; if(!r.ok) throw new Error('메타 조회 실패: '+r.status+' '+await r.text()); return await r.json(); }
    let meta=await getMeta(); let body={message:`chore(schedule): update ${path}`,content,branch}; if(meta?.sha) body.sha=meta.sha;
    let res=await fetch(putUrl,{method:'PUT',headers,body:JSON.stringify(body)});
    if(res.status===409){ meta=await getMeta(); body.sha=meta?.sha; res=await fetch(putUrl,{method:'PUT',headers,body:JSON.stringify(body)}); }
    if(!res.ok){ const t=await res.text(); throw new Error(`PUT 실패(${res.status}): ${t}`); }
  }

  /* 카테고리 관리자 */
  function openCatManager(){
    pickSupport.textContent=('EyeDropper' in window)?'스포이드 사용 가능(크롬/엣지 등)':'스포이드는 일부 브라우저에서만 지원';
    renderCatManagerRows();
    const x=lastPointer.x, y=lastPointer.y, pad=12, width=Math.min(760,innerWidth-24);
    catPop.style.left=Math.max(12,Math.min(x+10,innerWidth-width-pad))+'px';
    catPop.style.top =Math.max(12,Math.min(y-10,innerHeight-420))+'px';
    newCatHex.value=newCatColor.value.toUpperCase();
    newCatColor.addEventListener('input',()=>{ newCatHex.value=newCatColor.value.toUpperCase(); });
    newCatHex.addEventListener('input',()=>{ const v=normalizeHex(newCatHex.value); if(v) newCatColor.value=v; });
    catBack.style.display='flex'; catBack.setAttribute('aria-hidden','false');
  }
  function closeCatManager(){ catBack.style.display='none'; catBack.setAttribute('aria-hidden','true'); }
  catCancel.onclick=closeCatManager; catBack.addEventListener('click',e=>{ if(e.target===catBack) closeCatManager(); });

  function renderCatManagerRows(){
    const cats=catUnion().filter(c=>c!=='미분류');
    catList.innerHTML=cats.map(name=>{
      const col=catColor(name).toUpperCase(); const id='c_'+name.replace(/\s+/g,'_');
      return `<div class="cat-row" data-name="${escapeHtml(name)}">
        <input type="text" id="${id}_name" class="pill" value="${escapeHtml(name)}" />
        <input type="color" id="${id}_color" value="${col}">
        <input type="text" id="${id}_hex" class="color-hex" value="${col}">
        <button class="ico-btn" data-act="pick">스포이드</button>
        <button class="ico-btn" data-act="apply">이름/색 반영</button>
        <button class="ico-btn" data-act="delete">삭제</button>
      </div>`;
    }).join('') || `<div class="muted" style="padding:10px">카테고리가 아직 없어요. 일정을 만들면서 카테고리를 지정하거나 아래에서 추가하세요.</div>`;

    catList.querySelectorAll('.cat-row').forEach(row=>{
      const orig=row.dataset.name;
      const nameI=row.querySelector('.pill');
      const colorI=row.querySelector('[type=color]');
      const hexI=row.querySelector('.color-hex');
      const btnPick=row.querySelector('[data-act="pick"]');
      const btnApply=row.querySelector('[data-act="apply"]');
      const btnDel=row.querySelector('[data-act="delete"]');

      colorI.addEventListener('input',()=>{ hexI.value=colorI.value.toUpperCase(); });
      hexI.addEventListener('input',()=>{ const v=normalizeHex(hexI.value); if(v) colorI.value=v; });

      btnPick.addEventListener('click',async()=>{ if(!('EyeDropper' in window)) return alert('이 브라우저는 스포이드를 지원하지 않아요.'); try{ const eye=new EyeDropper(); const r=await eye.open(); const hex=r.sRGBHex.toUpperCase(); colorI.value=hex; hexI.value=hex; }catch(_){} });

      btnApply.addEventListener('click',()=>{
        const newName=(nameI.value||'').trim(); const hx=normalizeHex(hexI.value); if(!newName) return alert('이름을 입력하세요.');
        if(hx) catColors[newName]=hx;
        if(newName!==orig){
          calendar.getEvents().forEach(ev=>{ if((ev.extendedProps?.category||'')===orig) ev.setExtendedProp('category',newName); });
          if(activeCats.has(orig)){ activeCats.delete(orig); activeCats.add(newName); }
          if(catColors[orig]&&!catColors[newName]) catColors[newName]=catColors[orig];
          delete catColors[orig]; row.dataset.name=newName; markDirty(true);
        }
        renderCatUI(); applyCategoryFilter(); refreshEvents(); renderRail();
        alert('반영됨. 상단 "GitHub로 저장" 또는 아래 "카테고리 저장(GitHub)"으로 커밋하세요.');
      });

      btnDel.addEventListener('click',()=>{
        if(!confirm(`"${orig}" 카테고리를 삭제하고, 해당 일정들은 미분류로 이동할까요?`)) return;
        calendar.getEvents().forEach(ev=>{ if((ev.extendedProps?.category||'')===orig) ev.setExtendedProp('category',''); });
        delete catColors[orig]; if(activeCats.has(orig)) activeCats.delete(orig); row.remove(); markDirty(true);
        renderCatUI(); applyCategoryFilter(); refreshEvents(); renderRail();
      });
    });

    btnAddCat.onclick=()=>{ const nm=(newCatName.value||'').trim(); const hx=normalizeHex(newCatHex.value)||'#58A6FF'; if(!nm) return alert('카테고리 이름을 입력해 주세요.');
      catColors[nm]=hx.toUpperCase(); newCatName.value=''; renderCatManagerRows(); renderCatUI(); applyCategoryFilter(); refreshEvents(); renderRail(); };
  }

  [fTitle,fStatus,fStart,fEnd,fImage,fDesc,fCat,fCatColor].forEach(el=>el.addEventListener('input',()=>{ if(selected){ updatePreview(); markDirty(); }}));
  function refreshEvents(){ if(!calendar) return; calendar.batchRendering(()=>{ calendar.getEvents().forEach(ev=>{ ev.setExtendedProp('__refresh',(ev.extendedProps?.__refresh||0)+1); }); }); }
})();
</script>
</body>
</html>
