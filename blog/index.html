<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>보관된 도서</title>

<!-- Markdown & code highlight -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
:root{
  --bg:#0d141b; --ink:#e7edf3; --muted:#a8b3bf; --line:#1e2732; --panel:#10171e;
  --min-card:192px;
  --book-w:210px;      /* 책 폭 */
  --book-h:300px;      /* 책 높이 */
  --book-radius:14px;  /* 모서리 */
  --spine-w:44px;      /* 책등 폭 */
  --depth:16px;        /* 그림자 깊이 */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:15px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}
main{max-width:1120px;margin:28px auto;padding:0 16px}
header.page{display:flex;gap:8px;align-items:center;margin-bottom:16px}
.btn{border:1px solid var(--line);background:#0b1117;color:var(--ink);padding:8px 10px;border-radius:10px;text-decoration:none}
.hidden{display:none}

/* ===== 목록(카테고리→그리드) ===== */
#viewList .group{margin:24px 0}
#viewList .group>.ghead{
  display:inline-block;margin:0 0 8px;font:700 16px/1.2 system-ui;
  color:#ffd166;letter-spacing:.02em;background:rgba(255,209,102,.08);
  border:1px solid rgba(255,209,102,.25);padding:6px 10px;border-radius:8px;
}
#viewList .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(var(--min-card),1fr))}

/* ===== 카드 앵커 ===== */
a.book{display:block;text-decoration:none;color:inherit;-webkit-tap-highlight-color:transparent}

/* ===== 3D 책 ===== */
.book3d{
  --cover:url("/assets/covers/_placeholder.jpg");
  position:relative;width:var(--book-w);height:var(--book-h);margin:auto;
  perspective:1200px; transform-style:preserve-3d;
  filter:saturate(1);
}
.book3d .layer{
  position:absolute; inset:0; width:100%; height:100%;
  transform-origin:left center; transform-style:preserve-3d;
  border-radius:var(--book-radius); transition:transform .55s ease, box-shadow .35s ease, filter .35s ease;
  will-change:transform, box-shadow;
}
/* 공통 그림자/테두리 */
.book3d .layer::before{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 8px var(--depth) rgba(0,0,0,.35), 0 2px 12px rgba(0,0,0,.35);
}

/* 뒤표지 */
.book3d .back{
  background:
    linear-gradient(0deg,rgba(255,255,255,.04),transparent),
    radial-gradient(140% 100% at 110% 10%,rgba(255,255,255,.06),transparent 50%),
    #1a2330;
  border-left:1px solid rgba(255,255,255,.08);
  transform:rotateY(0deg);
}

/* 종이 페이지(양면 느낌을 위해 톤 다르게) */
.book3d .page{ background:#fff; }
.book3d .p1{ background:#fdfdfd }
.book3d .p2{ background:#fafafa }
.book3d .p3{ background:#f7f7f7 }
.book3d .p4{ background:#f5f5f5 }
.book3d .p5{ background:#f2f2f2 }
.book3d .p6{ background:#efefef }
/* 종이 질감 */
.book3d .page::after{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background:
    linear-gradient(90deg,rgba(0,0,0,.08),transparent 20%, transparent 80%, rgba(0,0,0,.08)),
    repeating-linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,.03) 1px, transparent 1px, transparent 26px);
  mix-blend-mode:multiply; opacity:.25;
}

/* 앞표지(이미지) */
.book3d .front{
  background:
    linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,0) 38%),
    var(--cover) center/cover no-repeat;
  border-left:1px solid rgba(255,255,255,.12);
  transform:rotateY(0deg);
}

/* 책등 */
.book3d .spine{
  position:absolute; top:0; left:0; bottom:0; width:var(--spine-w); z-index:9;
  border-top-left-radius:var(--book-radius); border-bottom-left-radius:var(--book-radius);
  background:
    linear-gradient(90deg, rgba(0,0,0,.55), rgba(255,255,255,.14) 45%, rgba(0,0,0,.45)),
    color-mix(in oklab, #6f849d 70%, black 30%);
  box-shadow: inset -1px 0 rgba(255,255,255,.18), inset 10px 0 22px rgba(0,0,0,.35);
  display:flex; align-items:center; justify-content:center;
}
.spine .t{
  writing-mode:vertical-rl; text-orientation:mixed;
  max-height:86%; padding:10px 0; color:#f6f9fc; font-weight:800; letter-spacing:.06em; line-height:1.05; font-size:13px;
  text-shadow:0 .5px 0 rgba(0,0,0,.55); overflow:hidden;
}

/* 리본 */
.book3d .ribbon{
  position:absolute; top:10px; right:12px; width:18px; height:34px; z-index:10;
  background:linear-gradient(0deg,#ff7d7d,#e63545); clip-path:polygon(0 0,100% 0,100% 70%,50% 100%,0 70%);
  filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));
}
.book3d .ribbon::after{
  content:""; position:absolute; inset:0; background:linear-gradient(180deg,transparent,rgba(255,255,255,.45) 55%,transparent 60%); mix-blend-mode:screen; opacity:.8;
}

/* 하단 캡션(글라스 라벨) */
.book3d .label{
  position:absolute; left:calc(var(--spine-w) + 10px); right:12px; bottom:12px; z-index:10;
  padding:10px 12px; border-radius:12px;
  background:linear-gradient(180deg,rgba(12,16,20,.72),rgba(12,16,20,.46)); backdrop-filter:blur(6px) saturate(1.12);
  border:1px solid rgba(255,255,255,.10); box-shadow:0 2px 10px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
  color:#fff; font-weight:800; font-size:14px; line-height:1.2; letter-spacing:.01em;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  transform:translateY(0); transition:transform .25s ease, box-shadow .25s ease;
}
a.book:is(:hover,:focus-visible) .book3d .label{ transform:translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08) }

/* ====== 펼침 애니 (hover/focus/open 클래스 공통) ====== */
a.book:is(:hover,:focus-visible) .book3d,
.book3d.open{ filter:saturate(1.05) }
a.book:is(:hover,:focus-visible) .book3d .front,
.book3d.open .front{ transform:rotateY(-160deg) translateZ(0.01px) }
a.book:is(:hover,:focus-visible) .book3d .p1,
.book3d.open .p1{ transform:rotateY(-150deg) }
a.book:is(:hover,:focus-visible) .book3d .p2,
.book3d.open .p2{ transform:rotateY(-30deg) }
a.book:is(:hover,:focus-visible) .book3d .p3,
.book3d.open .p3{ transform:rotateY(-140deg) }
a.book:is(:hover,:focus-visible) .book3d .p4,
.book3d.open .p4{ transform:rotateY(-40deg) }
a.book:is(:hover,:focus-visible) .book3d .p5,
.book3d.open .p5{ transform:rotateY(-130deg) }
a.book:is(:hover,:focus-visible) .book3d .p6,
.book3d.open .p6{ transform:rotateY(-50deg) }
a.book:is(:hover,:focus-visible) .book3d .back,
.book3d.open .back{ transform:rotateY(-20deg) }

/* ===== 본문(글 보기) ===== */
#viewPost.post{padding:0;border:none;background:none;margin-top:8px}
#viewPost .paper{
  position:relative; padding:26px 22px;
  background:
    radial-gradient(150% 100% at 0% 0%, rgba(0,0,0,.26), transparent 40%),
    radial-gradient(150% 100% at 100% 0%, rgba(0,0,0,.22), transparent 42%),
    repeating-linear-gradient(0deg, rgba(0,0,0,.04), rgba(0,0,0,.04) 1px, transparent 1px, transparent 26px),
    linear-gradient(0deg,#0f141a,#0f161c);
  border-radius:12px; border:1px solid var(--line);
  box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 14px 30px rgba(0,0,0,.45);
}
#pTitle{margin:0 0 6px; font-size:22px}
#pMeta{color:var(--muted); margin-bottom:14px}
#pBody{line-height:1.75; font-size:16px}
#pBody h1,#pBody h2,#pBody h3{margin-top:1.6em}
#pBody img{display:block; margin:12px auto; border-radius:10px; max-width:100%}
#pBody blockquote{margin:14px 0; padding:10px 12px; border-left:4px solid #ffd16633; background:#ffd1660f; color:#ffd166; border-radius:8px}
#pBody a{color:#8ecbff}
</style>
</head>

<body>
<main>
  <header class="page">
    <a class="btn" href="../">← 홈</a>
    <button id="backBtn" class="btn" type="button" aria-label="뒤로 가기">뒤로</button>
    <h1 id="title" style="margin:0 0 0 8px;font-size:18px">분류 전체보기</h1>
  </header>

  <div id="viewList" aria-label="책 목록"></div>

  <section id="viewPost" class="post hidden" aria-label="글 본문">
    <h2 id="pTitle"></h2>
    <div id="pMeta" class="meta"></div>
    <article id="pBody"></article>
  </section>
</main>

<script>
/* ===== 경로/데이터 ===== */
const BASE = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, '/');
const DATA_URL  = BASE + 'data/posts.json';
const POSTS_DIR = BASE + 'posts/';
const $=s=>document.querySelector(s);
const d=x=>x?new Date(x).toISOString().slice(0,10):'';
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ===== 커버 자동 탐색: jpg → png → webp (루트 → BASE) ===== */
function coverCandidates(slug, cover){
  if (cover) return [cover, `/assets/covers/_placeholder.jpg`, `${BASE}assets/covers/_placeholder.jpg`];
  return [
    `/assets/covers/${slug}.jpg`, `${BASE}assets/covers/${slug}.jpg`,
    `/assets/covers/${slug}.png`, `${BASE}assets/covers/${slug}.png`,
    `/assets/covers/${slug}.webp`, `${BASE}assets/covers/${slug}.webp`,
    `/assets/covers/_placeholder.jpg`, `${BASE}assets/covers/_placeholder.jpg`,
  ];
}
window._coverNext = function(ev){
  const img = ev.target;
  try{
    const list = JSON.parse(img.dataset.cands||'[]');
    if (list.length){
      const next = list.shift();
      img.dataset.cands = JSON.stringify(list);
      img.src = next;
      return;
    }
  }catch(_){}
};
window._coverSet = function(ev){
  const img = ev.target;
  const url = img.currentSrc || img.src;
  const holder = img.closest('.book3d');
  if (holder) holder.style.setProperty('--cover', `url("${url}")`);
};

/* ===== 카드 HTML ===== */
function bookCardHTML(p){
  const slug = p.slug;
  const cands = coverCandidates(slug, p.cover);
  return `
    <a class="book" href="#/post/${encodeURIComponent(slug)}" aria-label="${esc(p.title)}">
      <div class="book3d" style="--cover: url('${esc(cands[0])}')">
        <!-- 숨은 프리로더(성공하면 --cover 갱신, 실패하면 후보 순환) -->
        <img src="${esc(cands[0])}" data-cands='${esc(JSON.stringify(cands.slice(1)))}'
             onerror="window._coverNext && window._coverNext(event)"
             onload="window._coverSet && window._coverSet(event)" alt="" style="display:none">
        <div class="spine"><span class="t">${esc(p.shortTitle || p.title)}</span></div>
        <div class="back layer"></div>
        <div class="page layer p6"></div>
        <div class="page layer p5"></div>
        <div class="page layer p4"></div>
        <div class="page layer p3"></div>
        <div class="page layer p2"></div>
        <div class="page layer p1"></div>
        <div class="front layer"></div>
        <div class="ribbon" aria-hidden="true"></div>
        <div class="label">${esc(p.title)}</div>
      </div>
    </a>`;
}
function groupHTML(cat, list){
  return `
    <section class="group">
      <h2 class="ghead">${esc(cat)}</h2>
      <div class="grid">
        ${list.map(bookCardHTML).join('')}
      </div>
    </section>`;
}

/* ===== 렌더링 ===== */
let ALL=[];
function renderIndex(){
  $('#title').textContent='분류 전체보기';
  $('#viewPost').classList.add('hidden');
  const byCat={};
  ALL.forEach(p => (byCat[p.category||'기타'] ||= []).push(p));
  const html = Object.entries(byCat)
    .sort(([a],[b])=>a.localeCompare(b,'ko'))
    .map(([cat, list]) => groupHTML(cat, list.sort((a,b)=>new Date(b.date)-new Date(a.date))))
    .join('');
  $('#viewList').innerHTML = html;
  // 터치(모바일)에서는 탭 시 3D 미리보기 토글(한번 더 탭하면 글로 이동)
  document.querySelectorAll('.book3d').forEach(b=>{
    let tapped = false;
    b.addEventListener('touchend', (e)=>{
      if (!tapped){ b.classList.toggle('open'); tapped=true; setTimeout(()=>tapped=false, 900); e.preventDefault(); }
    }, {passive:false});
  });
}

async function renderPost(slug){
  $('#viewPost').classList.remove('hidden');
  const m = ALL.find(p=>p.slug===slug) || {title:slug};
  $('#title').textContent = m.category || '';
  $('#pTitle').textContent = m.title || slug;
  $('#pMeta').textContent = [m.category, d(m.date)].filter(Boolean).join(' · ');
  $('#pBody').innerHTML = '불러오는 중…';

  const url = POSTS_DIR + encodeURIComponent(slug) + '.md';
  try{
    const r = await fetch(url,{cache:'no-cache'});
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    const md = await r.text();
    const body = md.replace(/^---[\s\S]*?---\s*/, '');
    $('#pBody').innerHTML = marked.parse(body,{mangle:false,headerIds:true});
    $('#pBody').querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
    document.title = m.title + ' - 보관된 도서';
    if (!document.querySelector('#viewPost .paper')) {
      const wrap = document.createElement('div'); wrap.className = 'paper';
      const art = $('#pBody'); art.parentNode.insertBefore(wrap, art); wrap.appendChild(art);
    }
  }catch(e){
    console.error(e);
    $('#pBody').innerHTML = `<p class="m">게시글을 찾을 수 없습니다.<br><small>경로: ${url}</small></p>`;
  }
}

/* ===== 라우팅/네비 ===== */
function route(){
  const mPost=location.hash.match(/^#\/post\/(.+)$/);
  if(mPost){ renderPost(decodeURIComponent(mPost[1])); return; }
  renderIndex();
}
$('#backBtn').addEventListener('click', () => {
  if (document.referrer && new URL(document.referrer).origin === location.origin) history.back();
  else location.assign('../');
});

/* ===== 부팅 ===== */
(async () => {
  try{
    const r=await fetch(DATA_URL,{cache:'no-cache'});
    const j=await r.json();
    ALL=(j.posts||[]).map(p=>({...p,category:p.category||'기타'}));
  }catch(e){ console.error('posts.json 로드 실패',e); ALL=[]; }
  route(); addEventListener('hashchange',route);
})();
</script>
</body>
</html>
