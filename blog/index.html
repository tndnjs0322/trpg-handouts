<!-- index.html (하나의 파일) -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Jabas - Library</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic" rel="stylesheet" type="text/css">
  <!-- jQuery / Markdown / Highlight -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

  <style>
  /*-----------------------------------------------------------------------------*/
  /* BASIC LAYOUT + 도서관 ‘책장’ 배경                                           */
  /*-----------------------------------------------------------------------------*/
  :root{
    /* 동적 배경(커버 평균색 → JS가 갱신) */
    --bg:#0f1820; --bg-dark:#0a1117; --bg-light:#172532;
    /* 리본 (hover/선택에만 표시) */
    --ribbon-color:#e63746; --ribbon-w:20px; --ribbon-l:85%;
  }
  body {
      width: 960px;
      margin: 0 auto;
      font-family: 'PT Sans','pt sans',sans-serif;
      color:#0b1218;
      position:relative;
  }
  .bg{
    position:fixed; inset:0; z-index:0; pointer-events:none;
    background:
      radial-gradient(120% 90% at 50% 100%, rgba(0,0,0,.18), transparent 55%),
      linear-gradient(120deg, var(--bg-dark) 0%, var(--bg) 45%, var(--bg-light) 100%);
  }
  .bg-shelves{
    position:absolute; inset:0;
    --shelf-h:120px; --shelf-gap:40px; --shelf-thick:8px;
    background:
      repeating-linear-gradient(to bottom,
        rgba(0,0,0,.35) 0 calc(var(--shelf-thick)/2),
        rgba(255,255,255,.06) calc(var(--shelf-thick)/2) var(--shelf-thick),
        transparent var(--shelf-thick) calc(var(--shelf-h) + var(--shelf-gap))
      );
    opacity:.45;
  }
  .bg-spines{
    position:absolute; inset:-10% -10%;
    background:
      repeating-linear-gradient(90deg,
        color-mix(in oklab, var(--bg-light) 80%, black 20%) 0 9px,
        color-mix(in oklab, var(--bg) 75%, white 10%) 9px 24px,
        color-mix(in oklab, var(--bg-dark) 88%, white 6%) 24px 36px),
      repeating-linear-gradient(90deg,
        color-mix(in oklab, var(--bg) 80%, white 8%) 0 12px,
        color-mix(in oklab, var(--bg-dark) 80%, black 10%) 12px 26px,
        color-mix(in oklab, var(--bg-light) 80%, black 12%) 26px 44px);
    filter: blur(12px) saturate(.9);
    opacity:.38;
    -webkit-mask:
      repeating-linear-gradient(to bottom,
        transparent 0, transparent 40px,
        #000 40px calc(40px + 120px));
            mask:
      repeating-linear-gradient(to bottom,
        transparent 0, transparent 40px,
        #000 40px calc(40px + 120px));
  }

  /* 탑바(홈/뒤로/검색) */
  .topbar{
    position:sticky; top:0; z-index:5;
    display:flex; align-items:center; gap:8px;
    padding:8px 0; background:rgba(255,255,255,.55); backdrop-filter:blur(6px);
    border-bottom:1px solid rgba(0,0,0,.08); margin-bottom:6px;
  }
  .btn{
    appearance:none; border:1px solid rgba(0,0,0,.15);
    background:#0b1117; color:#fff; padding:6px 10px; border-radius:10px; font-weight:700; cursor:pointer;
  }
  .search{ margin-left:auto }
  .search input{ padding:7px 10px; border-radius:10px; border:1px solid rgba(0,0,0,.15); min-width:260px }

  .content { position: relative; top: 0; left: 0; z-index: 1; }

  /*-----------------------------------------------------------------------------*/
  /* LIBRARY LIST (카테고리=책)                                                  */
  /*-----------------------------------------------------------------------------*/
  ul.library {
      margin: 0;
      padding: 0 0 10px 0;
      list-style-type: none;
      overflow: hidden;
  }
  li.book {
      position: relative; top: 0; left: 0;
      margin: 0;
      padding: 10px;
      float: left;
      width: 140px; height: 224px;
      cursor: pointer;
  }
  li.book.selected{ z-index: 4;}
  .book:hover { background-color: #E5E5E5; }
  .book:active { background-color: #D9D9D9; }
  .book.selected:hover, li.book.selected:active { background-color: transparent;}

  /* 책 커버 */
  .book .cover {
      cursor: pointer;
      width: 140px; height:224px;
      box-shadow: 3px 3px 5px rgba(0,0,0,.3);
      filter: progid:DXImageTransform.Microsoft.Blur(PixelRadius=3,MakeShadow=true,ShadowOpacity=0.30);
      zoom: 1;
      position:relative; /* 리본 기준 */
  }
  .book .cover img {
      background-color: #e5e5e5;
      width: 140px; height: 224px;
      border-width: 0px;
      border-style: solid; border-color: #FFFFFF;
  }
  /* 리본: hover/선택 시에만 */
  .book .cover::after{
    content:"";
    position:absolute; top:-2px; right:10px;
    width: var(--ribbon-w); height: var(--ribbon-l);
    background:
      linear-gradient(0deg, rgba(255,255,255,.18), rgba(255,255,255,0) 18%),
      var(--ribbon-color);
    clip-path: polygon(0 0,100% 0,100% calc(100% - 18px),50% 100%,0 calc(100% - 18px));
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.45));
    border-radius: 4px 4px 0 0;
    pointer-events:none;
    opacity:0; transform: translateY(-6px);
    transition: opacity .25s ease, transform .25s ease;
  }
  .book:hover .cover::after,.book.selected .cover::after,.book:focus-within .cover::after{ opacity:1; transform: translateY(0); }

  /* 애니메이션 시작 위치(원본 유지) */
  .book.selected .cover { position: absolute; top: 10px; }
  .book.selected.left-side.first .cover, .book.selected.right-side .cover { left: 10px; right: auto;}
  .book.selected.right-side.last .cover , .book.selected.left-side .cover { left: auto; right: 10px;}

  /* 요약 + 미니 글목록 */
  li.book .summary {
      display: none;
      cursor: default;
      position: absolute; top: 10px;
      z-index: 4;
      padding: 10px;
      width: 450px; height: 0px;
      overflow: hidden;
      background:#E5E5E5;
  }
  .summary h1, .summary h2, .summary p { cursor: text;}
  .summary h1 { font-size: 28px; line-height: 34px; margin: 0 0 4px 0; padding: 0; }
  .summary h2 { font-weight: normal; font-style: italic; font-size: 20px; margin: 0 0 10px 0; padding: 0 0 10px 0; border-bottom: 2px dotted #999; }
  .summary p { font-size: 16px; line-height: 22px; margin: 0; padding: 0; }
  .summary .mini{ font-size:14px; margin:10px 0 0; padding:0; list-style:none }
  .summary .mini li{ margin:0 0 6px }
  .summary .mini a{ color:#0b6cff; text-decoration:underline }

  /* summary 위치(원본 유지) */
  .left-side .summary { left: 160px; border-right: 10px solid #D9D9D9; }
  .left-side.first .summary { left: 320px; }
  .right-side .summary { left: -480px; border-left: 10px solid #D9D9D9; }
  .right-side.last .summary { left: -640px; }

  /* 페이지 오버레이(원본 유지) */
  .overlay-page {
      display: none;
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #FFFFFF;
      opacity: .7;
      filter: alpha(opacity = 70);
      z-index: 2;
  }
  .overlay-summary {
      display: none;
      position: absolute; top: 0; left: 0; height: 0px; width: 480px;
      background-color: #E5E5E5;
      opacity: .9;
      filter: alpha(opacity = 90);
      z-index: 3;
  }

  /* 카테고리 화면 + 게시글 화면 */
  #catView{ margin-top:12px; display:none }
  #catTitle{ font-size:22px; margin:0 0 10px }
  .postlist{ list-style:none; margin:0; padding:0 }
  .postlist li{ padding:10px 8px; border:1px solid rgba(0,0,0,.08); border-radius:10px; margin-bottom:8px; background:#fff }
  .postlist li a{ font-weight:700; color:#0b1218; text-decoration:none }
  .postlist small{ color:#6b7785 }

  #postView{ display:none }
  #postView .paper{
    position:relative; padding:22px 20px; margin-top:12px;
    background:
      radial-gradient(150% 100% at 0% 0%, rgba(0,0,0,.06), transparent 40%),
      radial-gradient(150% 100% at 100% 0%, rgba(0,0,0,.05), transparent 42%),
      repeating-linear-gradient(0deg, rgba(0,0,0,.035), rgba(0,0,0,.035) 1px, transparent 1px, transparent 26px),
      linear-gradient(0deg,#ffffff,#f6f8fb);
    border-radius:12px; border:1px solid rgba(0,0,0,.1);
    box-shadow:0 1px 0 rgba(255,255,255,.55) inset, 0 14px 30px rgba(0,0,0,.15);
  }
  #pTitle{ margin:0 0 6px; font-size:24px }
  #pMeta{ color:#5c6b7a; margin-bottom:14px }
  #pBody{ line-height:1.75; font-size:16px; color:#18202a }
  #pBody h1,#pBody h2,#pBody h3{ margin-top:1.6em }
  #pBody img{ display:block; margin:12px auto; border-radius:10px; max-width:100% }
  #pBody blockquote{ margin:14px 0; padding:10px 12px; border-left:4px solid #ffd16666; background:#ffd16622; color:#745600; border-radius:8px }
  #pBody a{ color:#0b6cff; text-decoration:underline }
  </style>
</head>

<body>
  <!-- 도서관 배경 -->
  <div class="bg" aria-hidden="true">
    <div class="bg-shelves"></div>
    <div class="bg-spines"></div>
  </div>

  <!-- 상단 내비 -->
  <div class="topbar">
    <a class="btn" href="#/">← 홈</a>
    <button class="btn" type="button" id="backBtn">뒤로</button>
    <div class="search"><input id="q" type="search" placeholder="검색 (카테고리/제목/태그)" /></div>
  </div>

  <!-- 메인 콘텐츠 -->
  <div class="content">
    <!-- 홈: 카테고리=책 카드(원본 구조 유지) -->
    <ul class="library"></ul>
    <div class="overlay-page"></div>
    <div class="overlay-summary"></div>

    <!-- 카테고리 내부 글 목록 -->
    <section id="catView">
      <h2 id="catTitle"></h2>
      <ul id="postList" class="postlist"></ul>
    </section>

    <!-- 게시글 보기 (Markdown) -->
    <section id="postView">
      <div class="paper">
        <h2 id="pTitle"></h2>
        <div id="pMeta" class="meta"></div>
        <article id="pBody"></article>
      </div>
    </section>
  </div>

  <script>
  /* ============================ 설정/상태 ============================ */
  var animationSpeed = 750;
  var library = [];    // = 카테고리(책) 목록
  var POSTS = [];      // = 포스트 목록
  var CATS = {};       // catName -> { name, posts:[], (옵션)title, abstract, cover, ribbon }

  // BASE 경로 (서브폴더에서도 동작)
  var BASE = (function(){
    var path = location.pathname;
    return /\/$/.test(path) ? path : path.replace(/[^/]+$/, '/');
  })();

  $(function(){
    boot();           // posts.json 로드 → 카테고리/책 렌더
    bindGlobal();     // 내비/검색/라우팅
  });

  /* ============================ 부팅: posts.json 로드 ============================ */
  function boot(){
    $.getJSON(BASE + 'data/posts.json')
      .done(function(j){
        POSTS = (j.posts || []);
        var catMeta = {};
        (j.categories || []).forEach(function(c){ catMeta[c.name]=c; });

        // 카테고리 그룹핑
        CATS = {};
        POSTS.forEach(function(p){
          var cat = p.category || '기타';
          (CATS[cat] ||= { name:cat, posts:[] });
          CATS[cat].posts.push(p);
        });

        // 카테고리를 "책"으로 만들기
        library = [];
        Object.keys(CATS).sort().forEach(function(cat){
          var meta = $.extend({
            title: cat, author:'', abstract:'이 카테고리의 글들을 확인하세요.', cover:null, ribbon:null
          }, catMeta[cat] || {});

          // 카테고리 커버 자동 감지(후보 체인)
          var cand = coverCandidates(slugify(cat), meta.cover);
          if (!meta.cover) {
            var newest = CATS[cat].posts.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date)})[0];
            if (newest && newest.cover) cand.unshift(newest.cover);
          }
          var book = new Book(cand[0] || placeholderCover(), meta.title, meta.author, meta.abstract);
          book._coverCands = cand; // onerror 폴백
          book._cat = cat;
          book._ribbon = meta.ribbon;
          library.push(book);
        });

        renderLibrary();       // 홈 렌더
        attachAnimations();    // 원본 애니메이션
        // 첫 커버 색으로 배경 세팅
        var $first = $('.library .book:first img'); if ($first.length) setBgFromImg($first[0]);
      })
      .fail(function(){
        // 최소 샘플
        POSTS = [
          { slug:'hello', title:'블로그 시작', date:'2025-09-01', category:'공지' },
          { slug:'guide', title:'사용자 가이드', date:'2025-09-05', category:'공지' }
        ];
        CATS = { '공지':{name:'공지',posts:POSTS} };
        library = [ new Book(placeholderCover(),'공지','','공지사항을 확인하세요.') ];
        renderLibrary(); attachAnimations();
      });
  }

  /* ============================ 내비/검색/라우팅 ============================ */
  function bindGlobal(){
    $('#backBtn').on('click', function(){
      if (history.length > 1) history.back(); else location.hash = '#/';
    });
    // 검색
    $('#q').on('input', function(){
      if (/^#\/cat\//.test(location.hash)) renderCategory(decodeURIComponent(location.hash.replace(/^#\/cat\//,'')));
      else filterLibrary();
    });
    // 라우팅
    $(window).on('hashchange', route);
    route();
  }
  function route(){
    var h = location.hash || '#/';
    if (/^#\/post\//.test(h)){
      renderPost(decodeURIComponent(h.replace(/^#\/post\//,'')));
    } else if (/^#\/cat\//.test(h)){
      renderCategory(decodeURIComponent(h.replace(/^#\/cat\//,'')));
    } else {
      // 홈
      $('#postView,#catView').hide();
      $('.library,.overlay-page,.overlay-summary').show();
      var $sel = $('.book.selected'); if ($sel.length) deselectAnimation($sel);
      filterLibrary();
    }
  }

  /* ============================ 홈: 라이브러리 렌더 ============================ */
  function renderLibrary(){
    var $lib = $('.library').empty();
    var classlist = ['left-side first','left-side','left-side','right-side','right-side','right-side last'];

    library.forEach(function(book){
      var html  = '<li class="book ' + classlist[0] + '" data-cat="'+ esc(book._cat) +'">';
          html += '  <div class="cover">';
          html += '    <img src="' + esc(firstCover(book)) + '" alt="'+ esc(book.title) +'"';
          html += '         data-cands=\''+ esc(JSON.stringify(book._coverCands||[])) +'\'';
          html += '         onerror="imgFallbackChain(this)" />';
          html += '  </div>';
          html += '  <div class="summary">';
          html += '    <h1>' + esc(book.title) + '</h1>';
          if (book.author) html += '    <h2>by ' + esc(book.author) + '</h2>';
          html += '    <p>' + esc(book.abstract) + '</p>';

          // 미니 글목록(최신 5)
          var cat = book._cat;
          var list = (CATS[cat]?.posts||[]).slice().sort(function(a,b){return new Date(b.date)-new Date(a.date)}).slice(0,5);
          if (list.length){
            html += '<ul class="mini">';
            list.forEach(function(p){
              html += '<li><a href="#/post/'+ encodeURIComponent(p.slug) +'">'+ esc(p.title) +'</a> <small>· '+ esc(dateOnly(p.date)) +'</small></li>';
            });
            html += '</ul>';
          }
          html += '    <p style="margin-top:10px"><a href="#/cat/'+ encodeURIComponent(cat) +'">이 카테고리 전체 보기 →</a></p>';
          html += '  </div>';
          html += '</li>';
      $lib.append(html);

      var cn = classlist.shift(); classlist.push(cn);
    });

    // hover 시 배경 동기화
    $('.library .book').on('mouseenter', function(){
      var img = $(this).find('img')[0];
      if (img) setBgFromImg(img);
    });
  }

  /* ============================ 카테고리 화면 ============================ */
  function renderCategory(cat){
    var node = CATS[cat];
    if (!node){ location.hash = '#/'; return; }

    $('.library,.overlay-page,.overlay-summary').hide();
    $('#postView').hide(); $('#catView').show();
    $('#catTitle').text('카테고리: ' + cat);

    var q = ($('#q').val()||'').trim().toLowerCase();
    var posts = node.posts.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date)});
    if (q){
      posts = posts.filter(function(p){
        var hay = [p.title, p.category, (p.tags||[]).join(',')].join(' ').toLowerCase();
        return hay.indexOf(q) > -1;
      });
    }
    var html = posts.map(function(p){
      return '<li><a href="#/post/'+ encodeURIComponent(p.slug) +'">'+ esc(p.title) +'</a> <small>· '+ esc(dateOnly(p.date)) +'</small></li>';
    }).join('') || '<li><small>검색 결과 없음</small></li>';
    $('#postList').html(html);

    // 배경: 카테고리 표지 기준
    var bookEl = $('.library .book[data-cat="'+ cssEscape(cat) +'"] img')[0];
    if (bookEl) setBgFromImg(bookEl);
  }

  /* ============================ 게시글 보기 ============================ */
  function renderPost(slug){
    $('#catView').hide(); $('#postView').show();
    $('#pBody').html('로딩 중…'); $('#pTitle').text(''); $('#pMeta').text('');

    var post = POSTS.find(function(p){ return p.slug===slug; });
    if (!post){ $('#pBody').html('<p>게시글을 찾을 수 없습니다.</p>'); return; }

    $('#pTitle').text(post.title);
    $('#pMeta').text([post.category, dateOnly(post.date)].filter(Boolean).join(' · '));

    // 배경: 포스트 커버가 있으면 사용
    var imgURL = (coverCandidates(post.slug, post.cover)[0]);
    if (imgURL) setBgFromImgUrl(imgURL);

    var url = BASE + 'posts/' + encodeURIComponent(slug) + '.md';
    $.ajax({ url:url, cache:false, dataType:'text' })
      .done(function(md){
        var body = md.replace(/^---[\s\S]*?---\s*/, ''); // frontmatter 제거
        var html = marked.parse(body, { mangle:false, headerIds:true });
        $('#pBody').html(html);
        $('#pBody pre code').each(function(){ hljs.highlightElement(this); });
      })
      .fail(function(){
        $('#pBody').html('<p>게시글을 불러올 수 없습니다.<br><small>경로: '+ esc(url) +'</small></p>');
      });
  }

  /* ============================ 원본 애니메이션 로직 유지 ============================ */
  function attachAnimations() {
    // 책 클릭 → 선택(펼침)
    $('.library').off('click').on('click','.book',function(e){
      if (!$(this).hasClass('selected')) selectAnimation($(this));
    });
    // 커버 클릭 → 선택 상태면 닫기, 아니면 카테고리로 이동
    $('.library').on('click','.book .cover',function(e){
      var $book = $(this).closest('.book');
      if ($book.hasClass('selected')) { deselectAnimation($book); e.stopPropagation(); }
      else { var cat = $book.data('cat'); if (cat) location.hash = '#/cat/' + encodeURIComponent(cat); e.stopPropagation(); }
    });
  }
  function selectAnimation(obj) {
      obj.addClass('selected');
      var selImg = obj.find('.cover img')[0]; if (selImg) setBgFromImg(selImg);

      var cover = obj.find('.cover'), image = obj.find('.cover img');
      var libraryEl = $('.library'), summaryBG = $('.overlay-summary'), summary = obj.find('.summary');

      cover.animate({ width:'300px', height:'468px' }, { duration: animationSpeed });
      image.animate({ width:'280px', height:'448px', borderWidth:'10px' },{ duration: animationSpeed });
      if (isBtmRow()){ libraryEl.css('paddingBottom','234px'); }
      positionTop();

      $('.overlay-page').show();
      var px = overlayVertPos(); summaryBG.css('left',px);

      var ht = $('.content').height();
      var pos = $('.book.selected').position() || {top:0};
      var start = pos.top + 30;
      var speed = Math.round((animationSpeed/ht) * 450);

      summaryBG.show().animate({ height: ht + 'px' },{
        duration: animationSpeed, easing:'linear',
        step: function(now,fx){
          if (now > start && fx.prop === "height"){
            if(!summary.is(':animated') && summary.height() < 450){
              summary.show().animate({ height:'450px' },{ duration: speed, easing:'linear' });
            }
          }
        }
      });
  }
  function deselectAnimation(obj) {
      var cover = obj.find('.cover'), image = obj.find('.cover img');
      var libraryEl = $('.library'), summaryBG = $('.overlay-summary'), summary = obj.find('.summary');

      summary.stop();
      cover.stop().animate({ width:'140px', height:'224px' },{ duration:animationSpeed });
      image.stop().animate({ width:'140px', height:'224px', borderWidth:'0px' },{ duration: animationSpeed, complete:function(){ obj.removeClass('selected'); }});
      libraryEl.stop().animate({ paddingBottom:'10px' },{ duration: animationSpeed });

      var ht = summaryBG.height();
      var pos = $('.book.selected').position() || {top:0};
      var start = pos.top + 480;
      var speed = Math.round((animationSpeed/ht) * Math.max(1, summary.height()));
      summaryBG.stop().animate({ height:'0px' },{
        duration: animationSpeed, easing:'linear',
        step: function(now,fx){
          if (now < start && fx.prop === "height"){
            if(!summary.is(':animated') && summary.height() > 0){
              summary.animate({ height:'0px' },{ duration: speed, easing:'linear', complete:function(){ summary.hide(); } });
            }
          }
        },
        complete: function(){
          $('.overlay-page').hide();
          summary.hide(); summaryBG.hide();
        }
      });
  }
  function isBtmRow() {
      var pos = $('.book.selected').position(); var libHgt = $('.content').height();
      if (!pos) return false; return (libHgt - pos.top === 254);
  }
  function positionTop() { 
     var offset = $('.book.selected').offset(); var bTop = offset ? offset.top : 0;
     $('html, body').animate({ scrollTop: bTop }, animationSpeed);
  }
  function overlayVertPos() {
      var pos = $('.book.selected').position() || {left:0};
      switch(pos.left) {
          case 0:   return '320px';
          case 160: return '320px';
          case 320: return '480px';
          case 480: return '0px';
          case 640: return '160px';
          case 800: return '160px';
          default:  return '0px';
      }
  }

  /* ============================ 검색 (홈) ============================ */
  function filterLibrary(){
    var q = ($('#q').val()||'').trim().toLowerCase();
    if (!q){ $('.library .book').show(); return; }
    $('.library .book').each(function(){
      var cat = $(this).data('cat') || '';
      var title = $(this).find('.summary h1').text() || '';
      var hay = (cat+' '+title).toLowerCase();
      $(this).toggle(hay.indexOf(q) > -1);
    });
  }

  /* ============================ 경로/커버/색 유틸 ============================ */
  function coverCandidates(slug, cover){
    var out = [];
    var noSlash = function(s){ return (s||'').replace(/^\//,''); };
    var add = function(u){ if (u && out.indexOf(u)<0) out.push(u); };

    if (cover){ add(cover); add(BASE + noSlash(cover)); }
    ['jpg','png','webp'].forEach(function(ext){
      add(BASE + 'assets/covers/' + slug + '.' + ext);
      add('/assets/covers/' + slug + '.' + ext);
    });
    add(placeholderCover());
    return out;
  }
  function placeholderCover(){ return BASE + 'assets/covers/_placeholder.jpg'; }
  function firstCover(book){ return (book._coverCands && book._coverCands[0]) || book.cover || placeholderCover(); }
  function imgFallbackChain(el){
    var list = []; try{ list = JSON.parse(el.getAttribute('data-cands') || '[]'); }catch(e){}
    var cur = el.getAttribute('src'); var idx = list.indexOf(cur); var next = list[idx+1];
    el.src = next || placeholderCover();
  }

  function setBgFromImg(imgEl){
    averageColor(imgEl.currentSrc || imgEl.src).then(function(rgb){ if (rgb) applyBg(rgb); });
  }
  function setBgFromImgUrl(url){
    averageColor(url).then(function(rgb){ if (rgb) applyBg(rgb); });
  }
  function applyBg(rgb){
    var hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
    var root = document.documentElement.style;
    root.setProperty('--bg', 'hsl('+hsl.h+' '+hsl.s+'% '+hsl.l+'%)');
    root.setProperty('--bg-dark', 'hsl('+hsl.h+' '+hsl.s+'% '+Math.max(0, hsl.l-12)+'%)');
    root.setProperty('--bg-light','hsl('+hsl.h+' '+Math.max(10, hsl.s-8)+'% '+Math.min(100, hsl.l+10)+'%)');
  }
  function averageColor(url){
    return new Promise(function(resolve){
      try{
        var img = new Image(); img.crossOrigin='anonymous'; img.src=url;
        img.onload = function(){
          try{
            var c = document.createElement('canvas'), w=16,h=16; c.width=w; c.height=h;
            var ctx = c.getContext('2d',{willReadFrequently:true}); ctx.drawImage(img,0,0,w,h);
            var d = ctx.getImageData(0,0,w,h).data, r=0,g=0,b=0, n=w*h;
            for (var i=0;i<d.length;i+=4){ r+=d[i]; g+=d[i+1]; b+=d[i+2]; }
            resolve({ r:Math.round(r/n), g:Math.round(g/n), b:Math.round(b/n) });
          }catch(e){ resolve(null); }
        };
        img.onerror = function(){ resolve(null); };
      }catch(e){ resolve(null); }
    });
  }
  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    var max=Math.max(r,g,b), min=Math.min(r,g,b), h,s,l=(max+min)/2;
    if(max===min){ h=s=0; }
    else{
      var d=max-min; s=l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){ case r:h=(g-b)/d+(g<b?6:0); break; case g:h=(b-r)/d+2; break; case b:h=(r-g)/d+4; }
      h/=6;
    }
    return {h:Math.round(h*360), s:Math.round(s*100), l:Math.round(l*100)};
  }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])}); }
  function dateOnly(x){ return x ? new Date(x).toISOString().slice(0,10) : ''; }
  function slugify(s){ return String(s||'').toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9-_]/g,''); }
  function cssEscape(s){ return s.replace(/"/g,'\\"'); }

  /* 원본 Book 시그니처 유지(호환) */
  function Book(cover,title,author,abstract){ this.cover=cover; this.title=title; this.author=author; this.abstract=abstract; library.push(this); }
  </script>
</body>
</html>
