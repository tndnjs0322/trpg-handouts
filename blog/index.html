<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë³´ê´€ëœ ë„ì„œëª©ë¡</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='90'>ğŸ“œ</text></svg>">

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://cdn.jsdelivr.net/gh/orion-orion/orion-assets@main/Pretendard-Orion.css" rel="stylesheet" />

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
/* ===== ì „ì—­ ë³€ìˆ˜ & ê¸°ë³¸ ìŠ¤íƒ€ì¼ ===== */
:root {
  --bg: #0d141b;
  --panel: #10171e;
  --line: #1e2732;
  --text: #e7edf3;
  --muted: #a8b3bf;
  --accent: #2c5282;
  --highlight-text: #b3c5e8;
  --transition-speed: 0.2s;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font: 15px/1.6 "Pretendard", system-ui, -apple-system, Segoe UI, Roboto, Arial;
  transition: background var(--transition-speed) ease;
}

main {
  max-width: 1040px;
  margin: 28px auto;
  padding: 0 16px;
  min-height: calc(100vh - 56px);
}

main > header {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
  position: relative;
}

a.btn, button.btn {
  border: 1px solid var(--line);
  background: #0b1117;
  color: var(--text);
  padding: 8px 10px;
  border-radius: 10px;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
a.btn:hover, button.btn:hover {
  background: #151e2a;
  color: var(--highlight-text);
  transform: translateY(-1px);
}

.hidden { display: none !important; }

.list { display: grid; gap: 12px; }
.item {
  display: block;
  padding: 14px;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: var(--panel);
  color: var(--text);
  text-decoration: none;
  transition: all 0.2s ease-in-out;
}
.item:hover {
  background: #151e2a;
  border-color: var(--accent);
  transform: translateY(-1px);
}
.item .m { color: var(--muted); font-size: 12px; margin-top: 4px; }

/* ===== Jabas Library (ë„ì„œê´€ í…Œë§ˆ ì ìš©) ===== */
.libwrap {
  position: relative;
  box-shadow: 0 0 50px 10px rgba(0, 0, 0, 0.2) inset;
  padding: 20px;
  background: rgba(16, 23, 30, 0.4);
  border-radius: 14px;
}
.libwrap ul.library {
  margin: 0;
  padding: 0;
  list-style: none;
  overflow: hidden;
  width: 100%;
}
.libwrap li.book {
  position: relative;
  top: 0;
  left: 0;
  margin: 0;
  padding: 10px;
  float: left;
  width: 140px;
  height: 224px;
  cursor: pointer;
  background: transparent;
  transition: background-color 0.2s ease, transform 0.2s ease;
}
.libwrap .book:hover { background-color: rgba(255, 255, 255, 0.05); }
.libwrap .book.selected { z-index: 4; }
.libwrap .book.selected:hover, .libwrap li.book.selected:active { background-color: transparent; }

/* ì±… í‘œì§€ */
.libwrap .book .cover {
  position: relative;
  cursor: pointer;
  width: 140px;
  height: 224px;
  box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.5);
  transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
}
.libwrap .book.selected .cover {
  transform: scale(2.14);
}
.libwrap .book.selected .cover img {
  border: 10px solid transparent;
  transition: transform var(--transition-speed) ease, border-width var(--transition-speed) ease;
}
.libwrap .book .cover img {
  background: var(--panel);
  width: 100%;
  height: 100%;
  border: 0 solid transparent;
  transition: all var(--transition-speed) ease-in-out;
  filter: saturate(1.1) brightness(0.9);
}
.libwrap .book:hover .cover img {
  filter: saturate(1.3) brightness(1.1);
}

.libwrap .book.selected .cover { position: absolute; top: 10px; }

/* ìš”ì•½ íŒ¨ë„ */
.libwrap li.book .summary {
  display: none;
  cursor: default;
  position: absolute;
  top: 10px;
  z-index: 5; /* íŒ¨ë„ì„ ë” ìœ„ë¡œ */
  padding: 20px;
  width: 450px;
  height: 0;
  overflow: hidden;
  background: rgba(14, 20, 28, 0.9);
  color: var(--text);
  border-radius: 8px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(10px);
  transition: height 0.2s ease, left 0.2s ease, right 0.2s ease;
}
.libwrap .summary h1 {
  font-size: 26px;
  line-height: 32px;
  margin: 0 0 4px;
  color: var(--highlight-text);
  text-shadow: 0 0 10px var(--accent);
}
.libwrap .summary h2 {
  font-weight: 400;
  font-style: italic;
  font-size: 20px;
  margin: 0 0 12px;
  padding: 0 0 12px;
  border-bottom: 2px dotted rgba(255, 255, 255, 0.1);
}
.libwrap .summary p {
  font-size: 16px;
  line-height: 22px;
  margin: 0;
}
.libwrap .summary .mini { list-style: none; margin: 10px 0 0; padding: 0; }
.libwrap .summary .mini li { margin: 0 0 6px; }
.libwrap .summary .mini a {
  color: var(--accent);
  text-decoration: none;
  transition: color 0.2s ease;
}
.libwrap .summary .mini a:hover { text-decoration: underline; }

/* ì±… ìœ„ì¹˜ & ìš”ì•½ íŒ¨ë„ ìœ„ì¹˜ ë™ì  ì œì–´ */
.libwrap .book.summary-left .cover {
  right: 10px; left: auto;
}
.libwrap .book.summary-left .summary {
  left: -480px;
  border-left: 10px solid rgba(255, 255, 255, 0.1);
}

.libwrap .book.summary-right .cover {
  left: 10px; right: auto;
}
.libwrap .book.summary-right .summary {
  left: 160px;
  border-right: 10px solid rgba(255, 255, 255, 0.1);
}

.libwrap .book.selected.summary-right .summary {
  left: 160px;
}
.libwrap .book.selected.summary-left .summary {
  left: -480px;
}

/* ì˜¤ë²„ë ˆì´ */
.libwrap .overlay-page {
  display: none;
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 2;
  cursor: pointer;
  transition: opacity 0.5s ease;
}
.libwrap .overlay-summary {
  display: none;
  position: absolute;
  top: 0;
  left: 0;
  height: 0;
  width: 480px;
  background: transparent;
  z-index: 3;
}

.clearfix::after { content: ""; display: block; clear: both; }

/* ===== 'í¼ì³ì§„ ì±…' UI: Post Page ìŠ¤íƒ€ì¼ ===== */
.post {
  display: flex;
  position: relative;
  width: 100%;
  max-width: 1000px;
  margin: 0 auto;
  border-radius: 12px;
  background: #141b24;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  border: 1px solid var(--line);
  overflow: hidden;
  transform: perspective(2000px) rotateY(0deg);
  transform-origin: center center;
  transition: transform 0.8s ease-in-out;
}
.post-page {
  position: relative;
  width: 50%;
  padding: 30px;
  box-sizing: border-box;
  overflow-y: auto;
}
.post-page.left-page {
  border-right: 1px solid var(--line);
}
.post-page.left-page::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 15px;
  height: 100%;
  background: linear-gradient(to right, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 100%);
  pointer-events: none;
}
.post-page.right-page {
  border-left: 1px solid var(--line);
}
.post-page.right-page::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 15px;
  height: 100%;
  background: linear-gradient(to left, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 100%);
  pointer-events: none;
}
.post .meta { font-size: 14px; color: var(--muted); margin-bottom: 20px; }
.post h2 { font-size: 24px; margin-top: 0; }
.post h3 { font-size: 20px; }
.post h4 { font-size: 18px; }
.post h1, .post h2, .post h3, .post h4 { color: var(--highlight-text); }
.post p { text-align: justify; }

/* ì½”ë“œ ë¸”ë¡, ì¸ìš© ë“± */
pre {
  background: #0b1117;
  border: 1px solid var(--line);
  padding: 12px;
  border-radius: 10px;
  overflow: auto;
}

/* ===== ì§„ë‹¨ ì¹´ë“œ ===== */
.empty {
  margin: 24px 0;
  padding: 16px;
  border: 1px solid var(--line);
  background: var(--panel);
  border-radius: 12px;
}
.empty h3 { margin: 0 0 8px; font-size: 16px; }
.empty code {
  background: #0b1117;
  border: 1px solid var(--line);
  padding: 2px 6px;
  border-radius: 6px;
}
.empty ul { margin: 10px 0 0 18px; }

/* ===== Whisper Debug v2 ===== */
.dbg-pill {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.16);
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
  backdrop-filter: blur(12px) saturate(1.15);
  -webkit-backdrop-filter: blur(12px) saturate(1.15);
  color: #dfe7ef;
  cursor: pointer;
  opacity: 0.85;
  transition: transform 0.18s ease, opacity 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
  margin-left: auto;
}
.dbg-pill:hover {
  transform: translateY(-1px);
  opacity: 1;
  border-color: rgba(255, 255, 255, 0.22);
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.28), inset 0 1px 0 rgba(255, 255, 255, 0.08);
}
.dbg-pill svg { width: 16px; height: 16px; opacity: 0.95; }
.dbg-pill .txt { font-size: 12px; letter-spacing: 0.01em; opacity: 0.9; }
.dbg-pill.badge::after {
  content: "";
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #ff6b6b;
  box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.22);
  margin-left: 2px;
  animation: dbg-ping 1.1s ease-out 1;
}
@keyframes dbg-ping {
  0% { transform: scale(0.8); opacity: 0; }
  25% { opacity: 1; }
  100% { transform: scale(2.2); opacity: 0; }
}

#dbgDrawer {
  position: fixed;
  z-index: 100;
  display: none;
  min-width: 360px;
  width: min(720px, 92vw);
  max-height: 62vh;
  overflow: auto;
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: rgba(14, 20, 28, 0.68);
  backdrop-filter: blur(14px) saturate(1.1);
  -webkit-backdrop-filter: blur(14px) saturate(1.1);
  box-shadow: 0 18px 50px rgba(0, 0, 0, 0.45);
}
#dbgDrawer.open { display: block; }
#dbgDrawer header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}
#dbgDrawer header h4 {
  margin: 0;
  font-size: 12px;
  opacity: 0.85;
  letter-spacing: 0.02em;
  text-transform: uppercase;
}
#dbgDrawer .sp { flex: 1; }
#dbgDrawer header button {
  padding: 6px 8px;
  font-size: 12px;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid #2a3a46;
  background: #0f1821;
  color: #cfe1f0;
}
#dbgDrawer pre {
  margin: 0;
  padding: 10px 12px;
  background: transparent;
  font: 12px/1.45 ui-monospace, SFMono-Regular, Consolas, monospace;
  white-space: pre-wrap;
}
</style>
</head>
<body>
<main>
  <header>
    <a class="btn" id="homeBtn" href="../" data-home="">â† í™ˆ</a>
    <button id="backBtn" class="btn" type="button" aria-label="ë’¤ë¡œ ê°€ê¸°">ë’¤ë¡œ</button>
    <h1 id="title" style="margin:0 0 0 8px;font-size:18px">ë¶„ë¥˜ ì „ì²´ë³´ê¸°</h1>
  </header>

  <section id="viewCats" class="libwrap">
    <ul class="library clearfix"></ul>
    <div class="overlay-page" title="í´ë¦­í•˜ë©´ ë‹«ê¸°"></div>
    <div class="overlay-summary"></div>
    <div id="diag" class="empty hidden"></div>
  </section>

  <div id="viewList" class="list hidden" aria-label="ê¸€ ëª©ë¡"></div>

  <section id="viewPost" class="post hidden">
    <div class="post-page left-page">
      <h2 id="pTitle"></h2>
      <div id="pMeta" class="meta"></div>
      <article id="pBody"></article>
    </div>
    <div class="post-page right-page">
      <div id="pRightBody" class="post-content"></div>
    </div>
  </section>
</main>

<section id="dbgDrawer">
  <header>
    <h4>ë””ë²„ê·¸</h4>
    <span class="sp"></span>
    <button id="wCopy">ë³µì‚¬</button>
    <button id="wClear">ì§€ì›€</button>
    <button id="wHealth">í—¬ìŠ¤</button>
  </header>
  <pre id="wLog"></pre>
</section>

<script>
/* ===== ì „ì—­ ë³€ìˆ˜ ë° ìœ í‹¸ í•¨ìˆ˜ ===== */
const qs = (s) => document.querySelector(s);
const BASE = (function() { const p = location.pathname; return /\/$/.test(p) ? p : p.replace(/[^/]+$/, '/'); })();
const DATA_URL = BASE + 'data/posts.json';
const POSTS_DIR = BASE + 'posts/';
const animSpeed = 200;

let ALL = [], CATS = {}, library = [], LAST_ERR = '';

const d = (x) => x ? new Date(x).toISOString().slice(0, 10) : '';
const esc = (s) => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

async function ffetch(url, opt = {}, tag = 'fetch') {
  try {
    const r = await fetch(url, opt);
    dbg('INFO', `HTTP ${r.status}`, url);
    if (!r.ok) throw new Error(`${tag} HTTP ${r.status}`);
    return r;
  } catch (err) {
    dbg('WARN', `${tag} ì‹¤íŒ¨`, (err && err.message) || String(err));
    LAST_ERR = (err && err.message) || String(err);
    throw err;
  }
}

function placeholderCover() {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='280' height='448' style='background:%231a202c;border:2px solid %233d4a5b;border-radius:6px;'>
    <rect width='100%' height='100%' fill='%231a202c' style='filter:contrast(0.9) brightness(0.95);'/>
    <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Pretendard, system-ui' font-size='18' fill='%238e9ab2'>No Cover</text>
    <text x='50%' y='65%' dominant-baseline='middle' text-anchor='middle' font-family='Pretendard, system-ui' font-size='10' fill='%238e9ab2'>ë§ˆë²•ì„œ í‘œì§€ ì—†ìŒ</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function coverCandidates(nameOrSlug, cover) {
  const out = [];
  const add = (u) => { if (u && !out.includes(u)) out.push(u); };
  const noSlash = (s) => (s || '').replace(/^\//, '');

  if (cover) { add(cover); add(BASE + noSlash(cover)); }

  const raw = String(nameOrSlug || '').trim();
  const dashed = raw.replace(/\s+/g, '-').replace(/[\/\\?#%:*|"<>]/g, '-');
  const undersc = raw.replace(/\s+/g, '_').replace(/[\/\\?#%:*|"<>]/g, '_');
  const bases = [raw, dashed, undersc];
  const roots = [BASE + 'assets/covers/', '/assets/covers/'];
  const exts = ['jpg', 'png', 'webp', 'jpeg'];
  const suffixes = ['','-cover','-ì»¤ë²„','_cover','_ì»¤ë²„',' í‘œì§€','-í‘œì§€','_í‘œì§€'];

  for (const root of roots) {
    for (const base of bases) {
      for (const suf of suffixes) {
        for (const ext of exts) {
          add(root + base + suf + '.' + ext);
        }
      }
    }
  }

  add(placeholderCover());
  return out;
}

function Book(cover, title, author, abstract) {
  this.cover = cover;
  this.title = title;
  this.author = author;
  this.abstract = abstract;
  library.push(this);
}

function buildLibraryFromPosts() {
  CATS = {};
  ALL.forEach(p => {
    const c = p.category || 'ê¸°íƒ€';
    (CATS[c] ||= { name: c, posts: [] }).posts.push(p);
  });
  library.length = 0;
  Object.keys(CATS).sort((a, b) => a.localeCompare(b, 'ko')).forEach(cat => {
    const posts = CATS[cat].posts;
    const newest = posts.slice().sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    const cand = coverCandidates(cat, newest?.cover);
    const bk = new Book(cand[0] || placeholderCover(), cat, '', posts.length + 'ê°œì˜ ê¸€');
    bk._cat = cat;
    bk._coverCands = cand;
  });
}

function showDiag(title, lines = []) {
  const box = qs('#diag');
  box.classList.remove('hidden');
  box.innerHTML = `<h3>${esc(title)}</h3>
  <div style="font-size:13px;opacity:.9">BASE: <code>${esc(BASE)}</code><br>DATA_URL: <code>${esc(DATA_URL)}</code><br>ì£¼ì†Œ: <code>${esc(location.pathname)}</code></div>
  ${lines.length ? `<ul>${lines.map(s => `<li>${esc(s)}`).join('')}</ul>` : ''}
  ${LAST_ERR ? `<div style="margin-top:8px;color:#ffb3b3">ì˜¤ë¥˜: ${esc(LAST_ERR)}</div>` : ''}`;
}

function renderCats() {
  qs('#title').textContent = 'ë¶„ë¥˜ ì „ì²´ë³´ê¸°';
  qs('#viewCats').classList.remove('hidden');
  qs('#viewList').classList.add('hidden');
  qs('#viewPost').classList.add('hidden');

  const $lib = document.querySelector('#viewCats ul.library');
  $lib.innerHTML = '';

  library.forEach((bk, i) => {
    const summaryPosition = (i === 0) ? 'summary-right' : 'summary-left';
    let html = `<li class="book ${summaryPosition}" data-cat="${esc(bk._cat)}">`;
    html += `<div class="cover"><img src="${esc(placeholderCover())}" data-cands='${esc(JSON.stringify(bk._coverCands || []))}' alt="${esc(bk.title)}"/></div>`;
    html += `<div class="summary"></div></li>`;
    $lib.insertAdjacentHTML('beforeend', html);
  });

  document.querySelectorAll('#viewCats li.book').forEach(li => {
    const cat = li.dataset.cat;
    const list = (CATS[cat]?.posts || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 8);
    const s = li.querySelector('.summary');
    let html = `<h1>${esc(cat)}</h1><h2>ìµœê·¼ ê¸€</h2><ul class="mini">`;
    list.forEach(p => html += `<li><a href="#/post/${encodeURIComponent(p.slug)}">${esc(p.title)}</a> <small>Â· ${esc(d(p.date))}</small></li>`);
    html += `</ul><p style="margin-top:8px"><a href="#/category/${encodeURIComponent(cat)}">ì´ ì¹´í…Œê³ ë¦¬ ì „ì²´ ë³´ê¸° â†’</a></p>`;
    s.innerHTML = html;
  });

  if (library.length === 0) {
    const tips = [];
    if (location.protocol === 'file:') tips.push('ë¡œì»¬ íŒŒì¼(file://)ì—ì„œëŠ” fetchê°€ ë§‰í˜€ìš”. ì„ì‹œ ì„œë²„: python -m http.server');
    tips.push('posts.json ê²½ë¡œ í™•ì¸ â†’ ' + DATA_URL);
    tips.push('í´ë” êµ¬ì¡°: /blog/index.html, /blog/data/posts.json, /blog/posts/*.md');
    showDiag('ë¶ˆëŸ¬ì˜¬ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.', tips);
  }

  initLazyCovers();
}

function renderList(cat) {
  qs('#title').textContent = cat;
  qs('#viewCats').classList.add('hidden');
  qs('#viewList').classList.remove('hidden');
  qs('#viewPost').classList.add('hidden');

  const list = ALL.filter(p => (p.category || 'ê¸°íƒ€') === cat).sort((a, b) => new Date(b.date) - new Date(a.date));
  qs('#viewList').innerHTML = list.length
    ? list.map(p => `<a class="item" href="#/post/${encodeURIComponent(p.slug)}"><div class="t">${esc(p.title)}</div><div class="m">${d(p.date)} Â· ${esc(p.summary || '')}</div></a>`).join('')
    : '<p class="m">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
}

async function renderPost(slug) {
  qs('#viewCats').classList.add('hidden');
  qs('#viewList').classList.add('hidden');
  qs('#viewPost').classList.remove('hidden');

  const m = ALL.find(p => p.slug === slug) || { title: slug };
  qs('#title').textContent = m.category || 'ê²Œì‹œê¸€';
  qs('#pTitle').textContent = m.title;
  qs('#pMeta').textContent = [m.category, d(m.date)].filter(Boolean).join(' Â· ');
  qs('#pBody').innerHTML = '<p class="m">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>';
  qs('#pRightBody').innerHTML = '';

  try {
    const url = POSTS_DIR + encodeURIComponent(slug) + '.md';
    const r = await ffetch(url, { cache: 'no-cache' }, 'post-md:' + slug);
    const md = await r.text();
    const body = md.replace(/^---[\s\S]*?---\s*/, '');
    const html = marked.parse(body, { mangle: false, headerIds: true });

    const content = $(`<div>${html}</div>`);
    if (content.text().length > 1000) {
      const parts = splitContent(content);
      qs('#pBody').innerHTML = parts.left;
      qs('#pRightBody').innerHTML = parts.right;
    } else {
      qs('#pBody').innerHTML = html;
      qs('#pRightBody').innerHTML = '';
    }
    
    qs('#pBody').querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
    qs('#pRightBody').querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));

    document.title = m.title + ' - ë¸”ë¡œê·¸';
  } catch (e) {
    LAST_ERR = (e && e.message) ? e.message : String(e || '');
    qs('#pBody').innerHTML = '<p class="m">ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    qs('#pRightBody').innerHTML = '';
  }
}

function splitContent(content) {
    const elements = content.children();
    let leftHtml = '';
    let rightHtml = '';
    let isLeft = true;
    let totalLength = content.text().length;
    let currentLength = 0;
    
    elements.each((i, el) => {
        const elLength = $(el).text().length;
        if (currentLength + elLength < totalLength / 2 || isLeft) {
            leftHtml += el.outerHTML;
            currentLength += elLength;
        } else {
            if (isLeft) {
                isLeft = false;
                leftHtml += el.outerHTML;
            } else {
                rightHtml += el.outerHTML;
            }
        }
    });

    return { left: leftHtml, right: rightHtml };
}

function route() {
  try {
    const mPost = location.hash.match(/^#\/post\/(.+)$/);
    const mCat = location.hash.match(/^#\/category\/(.+)$/);
    if (mPost) return renderPost(decodeURIComponent(mPost[1]));
    if (mCat) return renderList(decodeURIComponent(mCat[1]));
    return renderCats();
  } catch (err) {
    dbg('ERROR', 'route ì‹¤íŒ¨', String(err));
  }
}
window.addEventListener('hashchange', route);

/* ===== Lazy cover with IntersectionObserver ===== */
function initLazyCovers() {
  const getCands = (img) => {
    try {
      const arr = JSON.parse(img.getAttribute('data-cands') || '[]');
      return [...new Set(arr)];
    } catch { return []; }
  };
  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (!e.isIntersecting) return;
      const img = e.target;
      if (img.dataset._started) return;
      img.dataset._started = '1';

      const cands = getCands(img);
      let i = -1;
      const advance = () => {
        i += 1;
        if (i < cands.length) {
          const u = cands[i];
          dbg('INFO', 'img try', u);
          img.src = u;
          return;
        }
        img.onerror = img.onload = null;
        img.src = placeholderCover();
        dbg('WARN', 'img í›„ë³´ ì „ë¶€ ì‹¤íŒ¨ - placeholder');
      };

      img.onload = () => { dbg('INFO', 'img ok', img.currentSrc || img.src); img.onerror = img.onload = null; };
      img.onerror = () => { dbg('WARN', 'img fail', img.src); setTimeout(advance, 50); };

      advance();
      io.unobserve(img);
    });
  }, { rootMargin: '200px' });

  document.querySelectorAll('#viewCats .library img[data-cands]').forEach(img => io.observe(img));
}

/* ===== Jabas ì• ë‹ˆë©”ì´ì…˜ (ìˆ˜ì •) ===== */
function attachAnimations() {
  const $lib = $('.libwrap .library');
  const $overlayPage = $('.libwrap .overlay-page');

  function isBottomRow($sel) {
    const tops = $('.libwrap li.book').map((i, el) => $(el).position().top).get();
    if (tops.length === 0) return false;
    const maxTop = Math.max.apply(null, tops);
    return Math.abs($sel.position().top - maxTop) < 1;
  }
  function positionTop($sel) { $('html, body').animate({ scrollTop: $sel.offset().top - 20 }, animSpeed); }

  function selectAnimation($li) {
    if ($li.hasClass('animating') || $li.hasClass('selected')) return;
    dbg('INFO', 'select', $li.data('cat'));
    $li.addClass('animating selected');

    const $summary = $li.find('.summary');

    $li.addClass('zoomed');
    $li.find('.cover img').css('border-width', '10px');
    
    $overlayPage.fadeIn(animSpeed);
    $summary.css({ 'height': '450px' }).show();
    
    if (isBottomRow($li)) {
      $lib.css('paddingBottom', '234px');
    }
    positionTop($li);

    setTimeout(() => {
      $li.removeClass('animating');
    }, animSpeed);
  }

  function deselectAnimation($li) {
    if (!$li.length) return;
    if ($li.hasClass('animating')) return;
    dbg('INFO', 'deselect', $li.data('cat'));
    $li.addClass('animating');

    const $summary = $li.find('.summary');

    $li.removeClass('zoomed');
    $li.find('.cover img').css('border-width', '0px');
    
    $summary.css({ 'height': '0' });
    $overlayPage.fadeOut(animSpeed);
    $lib.stop().animate({ paddingBottom: '10px' }, { duration: animSpeed });

    setTimeout(() => {
      $li.removeClass('selected animating');
      $summary.hide();
    }, animSpeed);
  }

  $('.libwrap').on('click', 'li.book', function() {
    const $current = $('.libwrap li.book.selected');
    const $me = $(this);
    if ($me.is($current)) {
      deselectAnimation($current);
    } else {
      if ($current.length) {
        deselectAnimation($current);
        setTimeout(() => selectAnimation($me), animSpeed);
      } else {
        selectAnimation($me);
      }
    }
  });

  $('.libwrap .overlay-page').on('click', () => deselectAnimation($('.libwrap li.book.selected')));
  $(document).on('keydown', (e) => { if (e.key === 'Escape') deselectAnimation($('.libwrap li.book.selected')); });
}

/* ===== Whisper Debug v2 ===== */
(function glassDebuggerStealth() {
  const CFG = {
    force: /(?:\?|&)debug=1\b/.test(location.search) || localStorage.getItem('__blog_debug__') === '1',
    showOn: ['ERROR', 'WARN'],
    autoOpenOn: ['ERROR'],
    buffer: 300
  };
  const header = document.querySelector('main > header');
  if (!header) return;

  const pill = document.createElement('button');
  pill.className = 'dbg-pill';
  pill.type = 'button';
  pill.title = 'Alt+D (ë””ë²„ê·¸)';
  pill.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
      fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M8 2v3M16 2v3"/><path d="M12 4v2"/>
      <rect x="7" y="6" width="10" height="14" rx="5"/>
      <path d="M5 10h14M19 14h1M4 14h1"/>
    </svg>
    <span class="txt">Debug</span>`;
  pill.style.display = CFG.force ? 'inline-flex' : 'none';
  header.appendChild(pill);

  const drawer = document.getElementById('dbgDrawer');
  const out = drawer.querySelector('#wLog');
  const buf = [];

  function placeDrawer() {
    const r = header.getBoundingClientRect();
    drawer.style.top = (r.bottom + 8) + 'px';
    drawer.style.right = Math.max(16, (innerWidth - r.right) + 16) + 'px';
  }
  function openDrawer(open) {
    drawer.classList.toggle('open', !!open);
    if (open) {
      placeDrawer();
      out.textContent = buf.join('\n');
      out.scrollTop = out.scrollHeight;
    }
  }
  addEventListener('resize', placeDrawer);
  addEventListener('scroll', placeDrawer, { passive: true });

  pill.addEventListener('click', () => openDrawer(!drawer.classList.contains('open')));
  drawer.querySelector('#wCopy').addEventListener('click', () => navigator.clipboard.writeText(out.textContent || buf.join('\n')));
  drawer.querySelector('#wClear').addEventListener('click', () => { buf.length = 0; out.textContent = ''; });
  drawer.querySelector('#wHealth').addEventListener('click', () => { if (typeof runHealthCheck === 'function') runHealthCheck(); });

  addEventListener('keydown', (e) => {
    if (e.altKey && (e.key === 'd' || e.key === 'D')) {
      if (!CFG.force && pill.style.display === 'none') {
        localStorage.setItem('__blog_debug__', '1');
        location.replace(location.href);
        return;
      }
      openDrawer(!drawer.classList.contains('open'));
    }
  });

  const line = (t, m, x) => `[${new Date().toLocaleTimeString()}] ${t.padEnd(7)} â”‚ ${m}${x ? ` â”‚ ${x}` : ''}`;
  const write = (s) => {
    buf.push(s);
    if (buf.length > CFG.buffer) buf.shift();
    if (CFG.force || drawer.classList.contains('open')) {
      out.textContent = buf.join('\n');
      out.scrollTop = out.scrollHeight;
    }
  };
  const ensurePillVisible = () => { if (pill.style.display === 'none') pill.style.display = 'inline-flex'; };
  const pulse = () => { pill.classList.remove('badge'); void pill.offsetWidth; pill.classList.add('badge'); };

  const orig = window.dbg;
  window.dbg = function(type, msg, extra) {
    (type === 'ERROR' ? console.error : console.log)('[Blog]', type, msg, extra || '');
    const s = line(type, msg, extra);
    write(s);
    if (CFG.force || CFG.showOn.includes(type)) {
      ensurePillVisible();
      if (CFG.showOn.includes(type)) pulse();
    }
    if (CFG.autoOpenOn.includes(type) && !drawer.classList.contains('open')) openDrawer(true);
    if (typeof orig === 'function') {
      try { orig(type, msg, extra); } catch {}
    }
  };
})();

/* ===== í—¬ìŠ¤ì²´í¬ ===== */
async function runHealthCheck() {
  dbg('INFO', 'â€” í—¬ìŠ¤ì²´í¬ ì‹œì‘ â€”');
  try {
    const r = await ffetch(DATA_URL, { cache: 'no-store' }, 'posts.json');
    const j = await r.json();
    dbg('INFO', `posts.json ok, posts=${(j.posts || []).length}`);
    if ((j.posts || []).length) {
      const first = j.posts[0];
      const mdURL = POSTS_DIR + encodeURIComponent(first.slug) + '.md';
      try { await ffetch(mdURL, { cache: 'no-store' }, 'first-md'); dbg('INFO', 'first md ok', mdURL); } catch {}
      const cat = first.category || 'ê¸°íƒ€';
      const cand = coverCandidates(cat, first.cover || '')[0];
      try { await ffetch(cand, { cache: 'no-store' }, 'cover-test'); dbg('INFO', 'cover candidate ok', cand); } catch {}
    }
  } catch {}
  dbg('INFO', 'â€” í—¬ìŠ¤ì²´í¬ ì™„ë£Œ â€”');
}

/* ===== ë¶€íŒ… ===== */
(async function init() {
  if (location.protocol === 'file:') {
    showDiag('ë¡œì»¬ íŒŒì¼ ëª¨ë“œ(file://)ì—ì„œëŠ” ë°ì´í„° ë¡œë“œê°€ ì°¨ë‹¨ë¼ìš”.', [
      'í„°ë¯¸ë„ì—ì„œ: python -m http.server 8000',
      'ê·¸ë¦¬ê³  http://localhost:8000/ ë¡œ ì ‘ì†í•˜ì„¸ìš”.'
    ]);
    dbg('WARN', 'file:// í™˜ê²½ - fetch ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ');
  }
  try {
    const r = await ffetch(DATA_URL, { cache: 'no-cache' }, 'posts.json');
    const j = await r.json();
    ALL = (j.posts || []).map(p => ({...p, category: p.category || 'ê¸°íƒ€'}));
    if (!Array.isArray(j.posts)) throw new Error('posts.jsonì— "posts" ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤.');
    dbg('INFO', `ë¡œë“œëœ posts: ${ALL.length}`);
  } catch (e) {
    LAST_ERR = (e && e.message) ? e.message : String(e || '');
    ALL = [];
  }

  buildLibraryFromPosts();
  attachAnimations();
  route();

  qs('#homeBtn').addEventListener('click', (e) => {
    e.preventDefault();
    location.href = './';
  });

  qs('#backBtn').addEventListener('click', (e) => {
    e.preventDefault();
    window.history.back();
  });

  if (/[?&]debug=1\b/.test(location.search) || localStorage.getItem('__blog_debug__') === '1') {
    runHealthCheck();
  }
})();
</script>
</body>
</html>
