<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>보관된 도서</title>

<!-- Markdown & code highlight -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
/* ============== 기본 ============== */
:root{
  --page-w: 1120px;

  /* 책 기본값 (카드별 덮어쓰기 가능: posts.json의 bw/bh) */
  --bw: 150px;
  --bh: 240px;

  /* 리본(책갈피) 기본값 */
  --ribbon-color: #e63746;
  --ribbon-w: 22px;
  --ribbon-l: 85%;

  /* 동적 배경색(커버 이미지에서 계산해 채움) */
  --bg: #0f1820;
  --bg-dark: #0a1117;
  --bg-light: #172532;

  /* 책장(선반) */
  --shelf-h: 120px;
  --shelf-gap: 40px;       /* 선반 사이의 빈 공간 */
  --shelf-thick: 8px;      /* 선반 두께(그림자 느낌) */
}
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0;
  font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  color:#e9f0f6;
  display:grid;
  place-items:start center;
  background: var(--bg);
}

/* ============== 도서관 ‘책장’ 배경 ============== */
.bg{
  position:fixed; inset:0; z-index:-2; pointer-events:none;
  /* 동적 색상으로 그라디언트 톤 */
  background:
    radial-gradient(120% 90% at 50% 100%, rgba(0,0,0,.28), transparent 55%),
    linear-gradient(120deg, var(--bg-dark) 0%, var(--bg) 45%, var(--bg-light) 100%);
}

/* 선반 그림자/두께 */
.bg .shelves{
  position:absolute; inset:0;
  background:
    /* 선반 상단 그림자 + 두께 */
    repeating-linear-gradient(to bottom,
      rgba(0,0,0,.35) 0 calc(var(--shelf-thick)/2),
      rgba(255,255,255,.06) calc(var(--shelf-thick)/2) var(--shelf-thick),
      transparent var(--shelf-thick) calc(var(--shelf-h) + var(--shelf-gap))
    );
  opacity:.45;
  filter: blur(.5px);
}

/* 선반 영역에만 보이는 ‘멀리 있는 책등’(세로 스트라이프) */
.bg .spines{
  position:absolute; inset:-10% -10%;
  background:
    repeating-linear-gradient(90deg,
      color-mix(in oklab, var(--bg-light) 80%, black 20%) 0 9px,
      color-mix(in oklab, var(--bg) 75%, white 10%) 9px 24px,
      color-mix(in oklab, var(--bg-dark) 88%, white 6%) 24px 36px),
    repeating-linear-gradient(90deg,
      color-mix(in oklab, var(--bg) 80%, white 8%) 0 12px,
      color-mix(in oklab, var(--bg-dark) 80%, black 10%) 12px 26px,
      color-mix(in oklab, var(--bg-light) 80%, black 12%) 26px 44px);
  filter: blur(12px) saturate(.9);
  opacity:.38;

  /* 선반 영역만 보이도록 마스크 */
  -webkit-mask:
    repeating-linear-gradient(to bottom,
      transparent 0, transparent var(--shelf-gap),
      #000 var(--shelf-gap) calc(var(--shelf-gap) + var(--shelf-h)));
          mask:
    repeating-linear-gradient(to bottom,
      transparent 0, transparent var(--shelf-gap),
      #000 var(--shelf-gap) calc(var(--shelf-gap) + var(--shelf-h)));
}

/* ============== 상단 내비 ============== */
.header{
  position:fixed; top:14px; left:14px; z-index:5; display:flex; gap:8px; align-items:center;
}
.btn{
  appearance:none; border:1px solid rgba(255,255,255,.15);
  background:rgba(0,0,0,.45); color:#fff;
  padding:8px 10px; border-radius:10px; font-weight:700; font-size:14px;
  text-decoration:none; backdrop-filter: blur(6px) saturate(1.05);
}
.btn:hover{ background:rgba(0,0,0,.65) }

.title{
  position:fixed; top:18px; right:18px; z-index:5;
  color:#e9f0f6; font-weight:800; font-size:16px; letter-spacing:.02em;
  background:rgba(255,255,255,.1); padding:6px 10px; border-radius:10px;
  border:1px solid rgba(255,255,255,.18);
}

/* ============== 컨텐츠 래퍼 ============== */
.content{
  width: min(var(--page-w), 100%);
  margin-top:64px;
  position:relative;
  padding: 8px 12px 24px;
}

/* ============== 카테고리 탭/검색 ============== */
.controls{
  display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:6px 0 10px;
}
.tabs{ display:flex; gap:6px; flex-wrap:wrap; }
.tab{
  background:rgba(255,255,255,.08); color:#e9f0f6; border:1px solid rgba(255,255,255,.16);
  padding:6px 10px; border-radius:9px; font-weight:700; cursor:pointer;
}
.tab.active{ background:#e9f0f6; color:#0b1218 }
.search{ margin-left:auto; display:flex; align-items:center; gap:6px; }
.search input[type="search"]{
  padding:8px 10px; border-radius:10px;
  border:1px solid rgba(255,255,255,.22); background:rgba(0,0,0,.25);
  color:#e9f0f6; min-width:220px;
}

/* ============== 라이브러리 그리드 ============== */
ul.library{
  margin:0; padding:0; list-style:none;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 24px 16px;
}
li.card{ display:grid; justify-items:center; gap:8px }

/* ============== 책 커버(hover/selected에서만 리본) ============== */
.book{
  position:relative;
  width: var(--bw); height: var(--bh);
  cursor:pointer;
  transition: transform .2s ease, filter .2s ease;
}
.book:hover{ transform: translateY(-3px); filter:saturate(1.04) }

.cover{
  width: var(--bw); height: var(--bh);
  box-shadow: 0 10px 22px rgba(0,0,0,.35);
  position:relative; border-radius: 10px; overflow:hidden;
}
.cover img{
  display:block; width:100%; height:100%; object-fit:cover; background:#112029;
}

/* 책갈피 리본 — 기본 숨김, hover/selected/focus에서만 */
.cover::after{
  content:"";
  position:absolute; top:-2px; right:10px;
  width: var(--ribbon-w); height: var(--ribbon-l);
  background:
    linear-gradient(0deg, rgba(255,255,255,.18), rgba(255,255,255,0) 18%),
    var(--ribbon-color);
  clip-path: polygon(0 0,100% 0,100% calc(100% - 18px),50% 100%,0 calc(100% - 18px));
  filter: drop-shadow(0 2px 2px rgba(0,0,0,.45));
  border-radius: 4px 4px 0 0;
  pointer-events:none;
  opacity:0; transform: translateY(-6px);
  transition: opacity .25s ease, transform .25s ease;
}
.book:hover .cover::after,
.book.selected .cover::after,
.book:focus-within .cover::after{
  opacity:1; transform: translateY(0);
}

.caption{
  width: var(--bw); text-align:center; font-weight:900; font-size:14px; line-height:1.35; color:#eef6ff;
  text-shadow: 0 1px 0 rgba(0,0,0,.35);
}
.meta{ font-size:12px; color:#a6b5c4 }

/* ============== 글 보기(본문) ============== */
#viewPost{ display:none; }
.paper{
  position:relative; padding:26px 22px;
  background:
    radial-gradient(150% 100% at 0% 0%, rgba(0,0,0,.22), transparent 40%),
    radial-gradient(150% 100% at 100% 0%, rgba(0,0,0,.18), transparent 42%),
    repeating-linear-gradient(0deg, rgba(0,0,0,.10), rgba(0,0,0,.10) 1px, transparent 1px, transparent 26px),
    linear-gradient(0deg,#0f151b,#0c1218);
  border-radius:12px; border:1px solid rgba(255,255,255,.16);
  box-shadow:0 1px 0 rgba(255,255,255,.06) inset, 0 14px 30px rgba(0,0,0,.45);
  color:#e9f0f6;
}
#pTitle{ margin:0 0 6px; font-size:22px }
#pMeta{ color:#a6b5c4; margin-bottom:14px }
#pBody{ line-height:1.75; font-size:16px }
#pBody h1,#pBody h2,#pBody h3{ margin-top:1.6em }
#pBody img{ display:block; margin:12px auto; border-radius:10px; max-width:100% }
#pBody blockquote{ margin:14px 0; padding:10px 12px; border-left:4px solid #ffd16633; background:#ffd16615; color:#ffd166; border-radius:8px }
#pBody a{ color:#8ecbff }

/* 접근성 */
@media (prefers-reduced-motion: reduce){
  .book, .cover::after{ transition:none !important }
}
</style>
</head>
<body>
<!-- 도서관(책장) 배경 -->
<div class="bg" aria-hidden="true">
  <div class="shelves"></div>
  <div class="spines"></div>
</div>

<nav class="header" aria-label="내비게이션">
  <a class="btn" id="homeBtn" href="#/">← 홈</a>
  <button class="btn" id="backBtn" type="button">뒤로</button>
</nav>
<div class="title" id="pageTitle">보관된 도서</div>

<main class="content">

  <!-- 메인: 카테고리 + 리스트 -->
  <section id="viewList" aria-label="도서 목록">
    <div class="controls">
      <div class="tabs" id="tabs"></div>
      <div class="search">
        <input id="q" type="search" placeholder="제목/태그 검색…" aria-label="검색">
      </div>
    </div>
    <ul class="library" id="library"></ul>
  </section>

  <!-- 글 보기 -->
  <section id="viewPost" aria-label="글 본문">
    <div class="paper">
      <h2 id="pTitle"></h2>
      <div id="pMeta" class="meta"></div>
      <article id="pBody"></article>
    </div>
  </section>

</main>

<script>
/* ===== 경로/도구 ===== */
const BASE = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, '/');
const DATA_URL  = BASE + 'data/posts.json';
const POSTS_DIR = BASE + 'posts/';

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const esc = s => String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const formatDate = x => x ? new Date(x).toISOString().slice(0,10) : '';

/* ===== 커버 경로 후보 & 로드 폴백 ===== */
function coverCandidates(slug, cover) {
  const out = [];
  const noSlash = s => (s||'').replace(/^\//,'');
  const add = url => { if (url && !out.includes(url)) out.push(url); };

  if (cover) { add(cover); add(BASE + noSlash(cover)); }

  ['jpg','png','webp'].forEach(ext=>{
    add(BASE + `assets/covers/${slug}.${ext}`);
    add(`/assets/covers/${slug}.${ext}`);
  });

  add(BASE + 'assets/covers/_placeholder.jpg');
  add('/assets/covers/_placeholder.jpg');

  return out;
}
window._coverSwap = function(ev){
  const img = ev.target;
  let list = [];
  try { list = JSON.parse(img.dataset.cands || '[]'); } catch {}
  const cur = img.getAttribute('src');
  const idx = list.indexOf(cur);
  const next = list[idx + 1];
  if (next) img.setAttribute('src', next);
};

/* ===== 상태 ===== */
let ALL = [];
let CURRENT_CAT = '전체';

/* ===== 카테고리 탭 렌더 ===== */
function renderTabs(){
  const tabs = $('#tabs');
  const cats = ['전체', ...new Set(ALL.map(p=>p.category || '기타'))];
  tabs.innerHTML = cats.map(c => `<button class="tab${c===CURRENT_CAT?' active':''}" data-cat="${esc(c)}">${esc(c)}</button>`).join('');
  tabs.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      CURRENT_CAT = btn.dataset.cat;
      location.hash = '#/cat/' + encodeURIComponent(CURRENT_CAT);
    });
  });
}

/* ===== 카드 HTML ===== */
function cardHTML(p){
  const bw = p.bw || 'var(--bw)';
  const bh = p.bh || 'var(--bh)';
  const ribbon = p.ribbon || 'var(--ribbon-color)';
  const ribbonW = p.ribbonW || 'var(--ribbon-w)';
  const ribbonL = p.ribbonL || 'var(--ribbon-l)';

  const cands = coverCandidates(p.slug, p.cover);
  const first = cands[0] || (BASE + 'assets/covers/_placeholder.jpg');

  return `
  <li class="card">
    <div class="book" tabindex="0" data-slug="${esc(p.slug)}"
         style="--bw:${esc(bw)}; --bh:${esc(bh)}; --ribbon-color:${esc(ribbon)}; --ribbon-w:${esc(ribbonW)}; --ribbon-l:${esc(ribbonL)}">
      <div class="cover" style="width:${esc(bw)};height:${esc(bh)}">
        <img src="${esc(first)}"
             alt="${esc(p.title)} 커버"
             data-cands='${esc(JSON.stringify(cands))}'
             onerror="_coverSwap(event)">
      </div>
    </div>
    <div class="caption">${esc(p.title)}</div>
    <div class="meta">${esc(p.category||'기타')} · ${esc(formatDate(p.date))}</div>
  </li>`;
}

/* ===== 리스트 렌더 ===== */
function renderList(){
  $('#viewPost').style.display = 'none';
  $('#viewList').style.display = '';
  $('#pageTitle').textContent = '보관된 도서';

  renderTabs();

  const q = $('#q').value.trim().toLowerCase();
  const list = ALL.filter(p=>{
    const inCat = (CURRENT_CAT==='전체') || ((p.category||'기타')===CURRENT_CAT);
    if (!inCat) return false;
    if (!q) return true;
    const hay = [p.title,p.author,(p.tags||[]).join(','),p.slug,p.category].join(' ').toLowerCase();
    return hay.includes(q);
  });

  const $lib = $('#library');
  $lib.innerHTML = list.map(p => cardHTML(p)).join('');

  // 카드 이벤트: 클릭 → 글 보기, hover → 배경색 동적 변경
  $$('#library .book').forEach(el=>{
    el.addEventListener('click', ()=>{
      const slug = el.dataset.slug;
      location.hash = '#/post/' + encodeURIComponent(slug);
    });
    el.addEventListener('keydown', (e)=>{
      if (e.key==='Enter') {
        const slug = el.dataset.slug;
        location.hash = '#/post/' + encodeURIComponent(slug);
      }
    });
    const img = el.querySelector('img');
    const hoverBg = () => updateBgFromImage(img.currentSrc || img.src);
    el.addEventListener('mouseenter', hoverBg);
    // 첫 렌더 시 첫 카드로 초기 배경 잡기
    if ($lib.firstElementChild && el === $lib.firstElementChild.querySelector('.book')) {
      if (img.complete) updateBgFromImage(img.currentSrc || img.src);
      else img.addEventListener('load', () => updateBgFromImage(img.currentSrc || img.src), {once:true});
    }
  });
}

/* ===== 글 보기 ===== */
async function renderPost(slug){
  const post = ALL.find(p=>p.slug===slug) || {title:slug};
  $('#viewList').style.display = 'none';
  $('#viewPost').style.display = '';
  $('#pageTitle').textContent = post.category ? `${post.category}` : '글 보기';

  $('#pTitle').textContent = post.title || slug;
  $('#pMeta').textContent = [post.category, formatDate(post.date)].filter(Boolean).join(' · ');
  $('#pBody').innerHTML = '불러오는 중…';

  // 배경색도 해당 커버로
  const imgURL = (coverCandidates(post.slug, post.cover)[0]);
  if (imgURL) updateBgFromImage(imgURL);

  const url = POSTS_DIR + encodeURIComponent(slug) + '.md';
  try{
    const r = await fetch(url,{cache:'no-cache'});
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    const md = await r.text();
    const body = md.replace(/^---[\s\S]*?---\s*/, ''); // frontmatter 제거
    $('#pBody').innerHTML = marked.parse(body,{mangle:false,headerIds:true});
    $('#pBody').querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
    document.title = post.title + ' - 보관된 도서';
  }catch(e){
    console.error(e);
    $('#pBody').innerHTML = `<p>게시글을 찾을 수 없습니다.<br><small>경로: ${esc(url)}</small></p>`;
  }
}

/* ===== 라우팅 ===== */
function route(){
  const mPost = location.hash.match(/^#\/post\/(.+)$/);
  const mCat  = location.hash.match(/^#\/cat\/(.+)$/);
  if (mPost){ renderPost(decodeURIComponent(mPost[1])); return; }
  if (mCat){ CURRENT_CAT = decodeURIComponent(mCat[1]); renderList(); return; }
  CURRENT_CAT = '전체';
  renderList();
}
$('#q').addEventListener('input', renderList);

/* ===== 뒤로가기 ===== */
$('#backBtn').addEventListener('click', ()=>{
  if (history.length > 1) history.back();
  else location.hash = '#/';
});

/* ===== 동적 배경: 커버 이미지 평균색 → CSS 변수 ===== */
async function updateBgFromImage(url){
  const rgb = await averageColor(url);
  if (!rgb) return; // 실패 시 유지
  const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
  const base = `hsl(${hsl.h} ${hsl.s}% ${hsl.l}%)`;
  const dark = `hsl(${hsl.h} ${hsl.s}% ${Math.max(0, hsl.l-12)}%)`;
  const light= `hsl(${hsl.h} ${Math.max(10, hsl.s-8)}% ${Math.min(100, hsl.l+10)}%)`;
  const root = document.documentElement.style;
  root.setProperty('--bg', base);
  root.setProperty('--bg-dark', dark);
  root.setProperty('--bg-light', light);
}

function averageColor(url){
  return new Promise(resolve=>{
    const img = new Image();
    img.crossOrigin = 'anonymous'; // CORS 허용된 커버(같은 도메인/허용 서버) 권장
    img.src = url;
    img.onload = () => {
      try{
        const c = document.createElement('canvas');
        const w=16,h=16; c.width=w; c.height=h;
        const ctx = c.getContext('2d', {willReadFrequently:true});
        ctx.drawImage(img,0,0,w,h);
        const data = ctx.getImageData(0,0,w,h).data;
        let r=0,g=0,b=0, count=w*h;
        for(let i=0;i<data.length;i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
        r=Math.round(r/count); g=Math.round(g/count); b=Math.round(b/count);
        resolve({r,g,b});
      }catch(e){ resolve(null); }
    };
    img.onerror = () => resolve(null);
  });
}
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){ h=s=0; }
  else{
    const d=max-min;
    s=l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d + (g<b?6:0); break;
      case g: h=(b-r)/d + 2; break;
      case b: h=(r-g)/d + 4; break;
    }
    h/=6;
  }
  return {h:Math.round(h*360), s:Math.round(s*100), l:Math.round(l*100)};
}

/* ===== 초기화 ===== */
(async ()=>{
  try{
    const r = await fetch(DATA_URL,{cache:'no-cache'});
    const j = await r.json();
    ALL = (j.posts||[]).map(p=>({
      ...p,
      category: p.category || '기타'
    }));
  }catch(e){
    console.warn('posts.json 로드 실패. 샘플 데이터 사용', e);
    // 샘플
    ALL = [
      { slug:'yeseoksi-1', title:'예식시 강력계정1 (완결)', author:'운영자', date:'2025-08-30', category:'ORPG 로그 백업', cover:'assets/covers/yeseoksi-1.jpg', ribbon:'#ff6b6b', bw:'160px', bh:'252px' },
      { slug:'scenario-overview', title:'시나리오 개요', author:'운영자', date:'2025-06-12', category:'시나리오들', cover:'assets/covers/scenario-overview.jpg', ribbon:'#7b3cff', ribbonL:'92%' },
      { slug:'clockwork', title:'A Clockwork Orange', author:'Anthony Burgess', date:'2025-05-01', category:'소설', cover:'https://picsum.photos/seed/clockwork/280/448', ribbon:'#d72d4f' }
    ];
  }
  route(); addEventListener('hashchange', route);
})();
</script>
</body>
</html>
