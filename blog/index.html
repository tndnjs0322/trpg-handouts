<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>블로그</title>

<!-- 폰트 & 라이브러리 -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://cdn.jsdelivr.net/gh/orion-orion/orion-assets@main/Pretendard-Orion.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
:root{--bg:#0d141b;--panel:#10171e;--line:#1e2732;--text:#e7edf3;--muted:#a8b3bf;--accent:#2c5282;--hi:#cfe1ff}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 "Pretendard",system-ui}
main{max-width:1040px;margin:28px auto;padding:0 16px;min-height:calc(100vh - 56px)}
main>header{display:flex;gap:8px;align-items:center;margin-bottom:12px;position:relative}
a.btn,button.btn{border:1px solid var(--line);background:#0b1117;color:var(--text);padding:8px 10px;border-radius:10px;text-decoration:none}
a.btn:hover,button.btn:hover{background:#151e2a;color:var(--hi)}

.hidden{display:none!important}

/* ====== 책장(list) – Jabas 스타일 유지 ====== */
.libwrap{position:relative;padding:20px;border-radius:14px;background:rgba(16,23,30,.35);box-shadow:inset 0 0 50px rgba(0,0,0,.2)}
.libwrap ul.library{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:20px;justify-content:center}
.libwrap li.book{width:140px;height:224px;cursor:pointer;position:relative;flex-shrink:0}
.libwrap .book .cover{width:140px;height:224px;box-shadow:3px 3px 10px rgba(0,0,0,.5)}
.libwrap .book .cover img{width:100%;height:100%;background:#0f161e;border:0}

#summaryPanel{position:absolute;left:50%;top:0;transform:translateX(-50%) translateY(-10px);opacity:0;pointer-events:none;display:flex;gap:18px;width:min(900px,92vw);background:rgba(15,22,30,.92);border:1px solid rgba(255,255,255,.08);border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,.5);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);transition:.35s ease}
#summaryPanel.active{transform:translateX(-50%) translateY(12px);opacity:1;pointer-events:auto;padding:18px}
#summaryPanel .panel-cover{width:180px;height:288px;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.35)}
#summaryPanel .panel-cover img{width:100%;height:100%;object-fit:cover}
#summaryPanel .panel-content{flex:1}
#summaryPanel h1{font-size:26px;margin:0 0 4px;color:var(--hi)}
#summaryPanel h2{font:italic 400 20px/1.3 Pretendard;margin:0 0 12px;padding:0 0 12px;border-bottom:2px dotted rgba(255,255,255,.14)}
#summaryPanel .mini{list-style:none;margin:10px 0 0;padding:0}
#summaryPanel .mini li{margin:0 0 6px}
#summaryPanel .mini a{color:#78a7ff;text-decoration:none}
#summaryPanel .mini a:hover{text-decoration:underline}

/* ====== 포스트: 코드펜 스타일(왼쪽 표지 + 오른쪽 요약) ====== */
.post{position:relative;display:flex;gap:0;border:1px solid var(--line);background:#141b24;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.45);overflow:hidden}
.post .page{width:50%;min-height:520px;padding:26px;position:relative}
.post .page.left{border-right:1px solid var(--line);display:grid;place-items:center;background:linear-gradient(90deg,rgba(0,0,0,.18),transparent)}
.post .page.right{border-left:1px solid var(--line);background:linear-gradient(270deg,rgba(0,0,0,.18),transparent)}
/* 왼쪽 큰 표지 */
.post .cover-lg{width:300px;height:468px;border:10px solid #fff;border-radius:6px;box-shadow:0 18px 30px rgba(0,0,0,.45)}
.post .cover-lg img{width:100%;height:100%;object-fit:cover;display:block}
/* 오른쪽 요약 */
.summary-block h1{font:700 34px/1.15 Pretendard;margin:0 0 6px}
.summary-block h2{font:italic 400 22px/1.2 Pretendard;margin:0 0 14px;padding:0 0 12px;color:#d7e5ff;border-bottom:2px dotted rgba(255,255,255,.18)}
.summary-block p{font-size:17px;line-height:1.6;margin:0}
.summary-block .meta{color:var(--muted);font-size:12px;margin:14px 0 0}
/* 읽기 전환 */
.read-actions{margin-top:14px;display:flex;gap:8px}
.read-actions .btn{padding:8px 12px}

/* 전체 본문 읽기 모드(오른쪽 페이지) */
#readingBody{max-height:calc(82vh - 80px);overflow:auto}
#readingBody pre{background:#0b1117;border:1px solid var(--line);padding:12px;border-radius:10px}

/* 빈/진단 */
.empty{margin:24px 0;padding:16px;border:1px solid var(--line);background:var(--panel);border-radius:12px}
.empty h3{margin:0 0 8px;font-size:16px} .empty code{background:#0b1117;border:1px solid var(--line);padding:2px 6px;border-radius:6px}

/* ===== Whisper Debug (유리 pill) ===== */
.dbg-pill{display:none;margin-left:auto;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));backdrop-filter:blur(12px) saturate(1.15);-webkit-backdrop-filter:blur(12px) saturate(1.15);color:#dfe7ef;cursor:pointer}
.dbg-pill svg{width:16px;height:16px} .dbg-pill.badge::after{content:"";width:7px;height:7px;border-radius:50%;background:#ff6b6b;box-shadow:0 0 0 4px rgba(255,107,107,.22);margin-left:2px;animation:ping 1.1s ease-out 1}
@keyframes ping{0%{transform:scale(.8);opacity:0}25%{opacity:1}100%{transform:scale(2.2);opacity:0}}
#dbgDrawer{position:fixed;z-index:100;display:none;min-width:360px;width:min(720px,92vw);max-height:62vh;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(14,20,28,.68);backdrop-filter:blur(14px) saturate(1.1)}
#dbgDrawer.open{display:block} #dbgDrawer header{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
#dbgDrawer header h4{margin:0;font:12px/1 Pretendard;opacity:.85;letter-spacing:.02em;text-transform:uppercase}
#dbgDrawer pre{margin:0;padding:10px 12px;background:transparent;font:12px/1.45 ui-monospace,Consolas,monospace;white-space:pre-wrap}
</style>
</head>
<body>
<main>
  <header>
    <a class="btn" id="homeBtn" href="../">← 홈</a>
    <button id="backBtn" class="btn" type="button">뒤로</button>
    <h1 id="title" style="margin:0 0 0 8px;font-size:18px">분류 전체보기</h1>
  </header>

  <!-- 책장 -->
  <section id="viewCats" class="libwrap">
    <ul class="library"></ul>
    <div id="summaryPanel">
      <div class="panel-cover"><img alt=""></div>
      <div class="panel-content"></div>
    </div>
    <div id="diag" class="empty hidden"></div>
  </section>

  <!-- 글 목록 -->
  <div id="viewList" class="hidden"></div>

  <!-- 포스트(코드펜 레이아웃) -->
  <section id="viewPost" class="post hidden" aria-label="글 본문">
    <div class="page left">
      <figure class="cover-lg"><img id="pCover" alt=""></figure>
    </div>
    <div class="page right">
      <div id="summaryBox" class="summary-block">
        <h1 id="pTitle"></h1>
        <h2 id="pAuthor"></h2>
        <p id="pExcerpt"></p>
        <div class="meta" id="pMeta"></div>
        <div class="read-actions">
          <a id="openFull" class="btn" href="#read">본문 전체 보기</a>
          <a id="openCat" class="btn" href="#">이 카테고리 보기</a>
        </div>
      </div>
      <article id="readingBody" class="hidden"></article>
    </div>
  </section>
</main>

<!-- 디버그 -->
<section id="dbgDrawer">
  <header><h4>Debug</h4><span style="flex:1"></span>
    <button id="wCopy" class="btn">복사</button>
    <button id="wClear" class="btn">지움</button>
    <button id="wHealth" class="btn">헬스</button>
  </header>
  <pre id="wLog"></pre>
</section>

<script>
/* ===== 경로/유틸 ===== */
const BASE = (()=>{const p=location.pathname;return /\/$/.test(p)?p:p.replace(/[^/]+$/,'/') })();
const DATA_URL  = BASE + 'data/posts.json';
const POSTS_DIR = BASE + 'posts/';
const $ = (s)=>document.querySelector(s);
const esc = (s)=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const d   = (x)=>x?new Date(x).toISOString().slice(0,10):'';
let ALL=[], CATS={}, library=[], LAST_ERR='';

/* 디버그 (유리 pill) */
(function(){
  const pill=document.createElement('button'); pill.className='dbg-pill'; pill.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="7" y="6" width="10" height="14" rx="5"/><path d="M5 10h14M19 14h1M4 14h1"/></svg><span>Debug</span>`;
  const hdr=document.querySelector('main>header'); hdr.appendChild(pill);
  const drawer=$('#dbgDrawer'), out=$('#wLog'); let buf=[];
  const line=(t,m,x)=>`[${new Date().toLocaleTimeString()}] ${t.padEnd(7)} │ ${m}${x?` │ ${x}`:''}`;
  function open(v){ drawer.classList.toggle('open',!!v); if(v){ out.textContent=buf.join('\n'); out.scrollTop=out.scrollHeight; const r=hdr.getBoundingClientRect(); drawer.style.top=(r.bottom+8)+'px'; drawer.style.right=Math.max(16,(innerWidth-r.right)+16)+'px'; } }
  pill.onclick=()=>open(!drawer.classList.contains('open'));
  $('#wCopy').onclick=()=>navigator.clipboard.writeText(out.textContent||buf.join('\n'));
  $('#wClear').onclick=()=>{buf=[]; out.textContent='';};
  $('#wHealth').onclick=()=>runHealthCheck?.();
  addEventListener('keydown',e=>{ if(e.altKey&&(e.key==='d'||e.key==='D')) open(!drawer.classList.contains('open')); });

  window.dbg=function(type,msg,extra){
    (type==='ERROR'?console.error:console.log)('[Blog]',type,msg,extra||'');
    buf.push(line(type,msg,extra)); if(buf.length>300) buf.shift();
    pill.style.display='inline-flex'; if(['ERROR','WARN'].includes(type)){ pill.classList.remove('badge'); void pill.offsetWidth; pill.classList.add('badge'); }
    if(type==='ERROR' && !drawer.classList.contains('open')) open(true);
    if(drawer.classList.contains('open')){ out.textContent=buf.join('\n'); out.scrollTop=out.scrollHeight; }
  };
})();

/* fetch 래퍼 */
async function ffetch(url,opt={},tag='fetch'){
  try{ const r=await fetch(url,opt); if(!r.ok) throw new Error(`${tag} HTTP ${r.status}`); return r; }
  catch(e){ LAST_ERR=e.message||String(e); dbg('ERROR',tag+' 실패',url); throw e; }
}

/* placeholder & cover 후보 */
function placeholderCover(){
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='280' height='448'><rect width='100%' height='100%' fill='%231a202c'/><text x='50%' y='52%' text-anchor='middle' dominant-baseline='middle' font-family='system-ui' font-size='14' fill='%238e9ab2'>No cover</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function coverCandidates(nameOrSlug,cover){
  const out=[]; const add=u=>{if(u&&!out.includes(u)) out.push(u)}; const noSlash=s=>(s||'').replace(/^\//,'');
  if(cover){ add(cover); add(BASE+noSlash(cover)); }
  const raw=String(nameOrSlug||'').trim(), dashed=raw.replace(/\s+/g,'-').replace(/[\/\\?#%:*|"<>]/g,'-'), undersc=raw.replace(/\s+/g,'_').replace(/[\/\\?#%:*|"<>]/g,'_');
  const roots=[BASE+'assets/covers/','/assets/covers/']; const exts=['jpg','png','webp','jpeg']; const bases=[raw,dashed,undersc]; const suf=['',' cover',' 커버','-cover','-커버','_cover','_커버',' 표지','-표지','_표지'];
  for(const rt of roots) for(const b of bases) for(const s of suf) for(const e of exts) add(rt+b+s+'.'+e);
  add(placeholderCover()); return out;
}

/* 데이터 → 카테고리 책 엔트리 */
function Book(cover,title,author,abstract){ this.cover=cover; this.title=title; this.author=author; this.abstract=abstract; library.push(this); }
function buildLibraryFromPosts(){
  CATS={}; ALL.forEach(p=>{const c=p.category||'기타'; (CATS[c]??={name:c,posts:[]}).posts.push(p);});
  library.length=0;
  Object.keys(CATS).sort((a,b)=>a.localeCompare(b,'ko')).forEach(cat=>{
    const posts=CATS[cat].posts, newest=posts.slice().sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
    const cand=coverCandidates(cat, newest?.cover); const bk=new Book(cand[0]||placeholderCover(),cat,'',posts.length+'개의 글'); bk._cat=cat; bk._coverCands=cand;
  });
}

/* 책장 렌더 */
function renderCats(){
  $('#title').textContent='분류 전체보기';
  $('#viewCats').classList.remove('hidden'); $('#viewList').classList.add('hidden'); $('#viewPost').classList.add('hidden');
  const UL=document.querySelector('#viewCats .library'); UL.innerHTML='';
  library.forEach(bk=>{
    UL.insertAdjacentHTML('beforeend', `<li class="book" data-cat="${esc(bk._cat)}"><div class="cover"><img src="${placeholderCover()}" data-cands='${esc(JSON.stringify(bk._coverCands||[]))}' alt="${esc(bk.title)}"></div></li>`);
  });
  initLazyCovers();
  if(!library.length){
    const tips=['posts.json 경로 확인 → '+DATA_URL,'구조: /blog/index.html, /blog/data/posts.json, /blog/posts/*.md'];
    const box=$('#diag'); box.classList.remove('hidden'); box.innerHTML = `<h3>불러올 카테고리가 없습니다.</h3><ul>${tips.map(t=>`<li>${esc(t)}`).join('')}</ul>${LAST_ERR?`<div style="margin-top:8px;color:#fbb">오류: ${esc(LAST_ERR)}</div>`:''}`;
  }
}

/* 요약 패널 */
function panelFor(cat){
  const posts=(CATS[cat]?.posts||[]).slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,8);
  const bk=library.find(b=>b._cat===cat)||{}; const cover=(bk._coverCands||[])[0]||placeholderCover();
  $('#summaryPanel .panel-cover img').src=cover;
  $('#summaryPanel .panel-cover img').alt=cat;
  let html=`<h1>${esc(cat)}</h1><h2>최근 글</h2><ul class="mini">`;
  posts.forEach(p=> html+=`<li><a href="#/post/${encodeURIComponent(p.slug)}">${esc(p.title)}</a> <small>· ${esc(d(p.date))}</small></li>`);
  html+=`</ul><p style="margin-top:8px"><a href="#/category/${encodeURIComponent(cat)}">이 카테고리 전체 보기 →</a></p>`;
  $('#summaryPanel .panel-content').innerHTML=html;
}

/* 책장 인터랙션 */
document.querySelector('#viewCats .library').addEventListener('click',e=>{
  const li=e.target.closest('li.book'); if(!li) return;
  panelFor(li.dataset.cat); $('#summaryPanel').classList.add('active');
});
document.addEventListener('keydown',e=>{ if(e.key==='Escape') $('#summaryPanel').classList.remove('active');});
$('#summaryPanel').addEventListener('click',e=>{ if(e.target.closest('a[href^="#"]')) $('#summaryPanel').classList.remove('active'); });

/* 목록 */
function renderList(cat){
  $('#title').textContent=cat; $('#viewCats').classList.add('hidden'); $('#viewList').classList.remove('hidden'); $('#viewPost').classList.add('hidden');
  const list=ALL.filter(p=>(p.category||'기타')===cat).sort((a,b)=>new Date(b.date)-new Date(a.date));
  $('#viewList').innerHTML = list.length ? list.map(p=>`<a class="item" href="#/post/${encodeURIComponent(p.slug)}"><div class="t">${esc(p.title)}</div><div class="m">${d(p.date)} · ${esc(p.summary||'')}</div></a>`).join('') : '<p class="m">글이 없습니다.</p>';
}

/* front matter(아주 단순) 파서 */
function parseFM(raw){
  const m=raw.match(/^---\s*([\s\S]*?)\s*---/); if(!m) return [{}, raw];
  const fm={}; m[1].split(/\r?\n/).forEach(line=>{ const mm=line.match(/^\s*([\w-]+)\s*:\s*(.+)\s*$/); if(mm) fm[mm[1].trim()]=mm[2].trim(); });
  return [fm, raw.slice(m[0].length)];
}
/* 본문에서 짧은 요약 추출 */
function excerptOf(html){
  const tmp=document.createElement('div'); tmp.innerHTML=html;
  const paras=[...tmp.querySelectorAll('p')].map(p=>p.textContent.trim()).filter(Boolean);
  const pick=(paras[0]||'').slice(0,420);
  return pick.length<paras[0]?.length ? pick+'…' : pick || '요약이 없습니다.';
}

/* 포스트 화면 (코드펜 모양) */
async function renderPost(slug){
  $('#viewCats').classList.add('hidden'); $('#viewList').classList.add('hidden'); $('#viewPost').classList.remove('hidden');
  const meta=ALL.find(p=>p.slug===slug)||{title:slug}; const cat=meta.category||'기타';
  $('#title').textContent=cat;
  $('#openCat').href = `#/category/${encodeURIComponent(cat)}`;

  try{
    const url=POSTS_DIR+encodeURIComponent(slug)+'.md';
    const r=await ffetch(url,{cache:'no-cache'},'post-md:'+slug);
    const raw=await r.text();
    const [fm, bodySrc]=parseFM(raw);
    const html=marked.parse(bodySrc,{mangle:false,headerIds:true});
    const author=fm.author||meta.author||'';
    const cover=(meta.cover || fm.cover || (coverCandidates(meta.title||slug)[0])) || placeholderCover();

    // 좌측 큰 표지
    $('#pCover').src = cover; $('#pCover').alt = meta.title || slug;

    // 요약(코드펜 스타일)
    $('#pTitle').textContent = meta.title || slug;
    $('#pAuthor').textContent = author ? `by ${author}` : '';
    $('#pExcerpt').textContent = excerptOf(html);
    $('#pMeta').textContent = [cat, d(meta.date)].filter(Boolean).join(' · ');

    // 전체 본문(읽기 버튼 누르면 교체)
    const full=$('#readingBody'); full.innerHTML = html; full.querySelectorAll('pre code').forEach(b=>hljs.highlightElement(b));
    $('#openFull').onclick=(e)=>{ e.preventDefault(); $('#summaryBox').classList.add('hidden'); full.classList.remove('hidden'); full.scrollTop=0; };

  }catch(e){
    $('#pTitle').textContent = meta.title || slug;
    $('#pAuthor').textContent=''; $('#pExcerpt').textContent='게시글을 불러올 수 없습니다.'; $('#pMeta').textContent=d(meta.date)||'';
    $('#pCover').src = placeholderCover();
  }
}

/* 라우팅 */
function route(){
  const mPost=location.hash.match(/^#\/post\/(.+)$/), mCat=location.hash.match(/^#\/category\/(.+)$/);
  if(mPost) return renderPost(decodeURIComponent(mPost[1]));
  if(mCat)  return renderList(decodeURIComponent(mCat[1]));
  return renderCats();
}
addEventListener('hashchange', route);

/* 이미지 지연 로드 + 후보 순환 */
function initLazyCovers(){
  const io=new IntersectionObserver(es=>{
    es.forEach(e=>{
      if(!e.isIntersecting) return;
      const img=e.target; if(img.dataset._started) return; img.dataset._started='1';
      let cands=[]; try{ cands=JSON.parse(img.getAttribute('data-cands')||'[]'); }catch{}
      let i=-1; const advance=()=>{ i++; if(i<cands.length){ img.src=cands[i]; } else { img.src=placeholderCover(); } };
      img.onload = ()=>{ dbg('INFO','img ok',img.currentSrc||img.src); img.onerror=img.onload=null; };
      img.onerror= ()=>{ dbg('WARN','img fail',img.src); setTimeout(advance,40); };
      advance(); io.unobserve(img);
    });
  },{rootMargin:'200px'});
  document.querySelectorAll('#viewCats .library img[data-cands]').forEach(img=>io.observe(img));
}

/* 헬스체크 */
async function runHealthCheck(){
  dbg('INFO','— 헬스체크 시작 —');
  try{
    const r=await ffetch(DATA_URL,{cache:'no-store'},'posts.json'); const j=await r.json();
    dbg('INFO',`posts=${(j.posts||[]).length}`);
    if((j.posts||[]).length){
      const p=j.posts[0];
      await ffetch(POSTS_DIR+encodeURIComponent(p.slug)+'.md',{cache:'no-store'},'first-md').catch(()=>{});
      const cand=coverCandidates(p.category||'기타',p.cover||'')[0]; await ffetch(cand,{cache:'no-store'},'cover-test').catch(()=>{});
    }
  }catch{}
  dbg('INFO','— 완료 —');
}

/* 홈/뒤로 */
$('#homeBtn').onclick=(e)=>{ e.preventDefault(); location.href='../'; };
$('#backBtn').onclick=()=>{ if(history.length>1) history.back(); else location.href='../'; };

/* 부팅 */
(async function init(){
  try{
    const r=await ffetch(DATA_URL,{cache:'no-cache'},'posts.json');
    const j=await r.json(); if(!Array.isArray(j.posts)) throw new Error('posts.json에 "posts" 배열이 없습니다.');
    ALL=(j.posts||[]).map(p=>({...p,category:p.category||'기타'}));
  }catch(e){ ALL=[]; }
  buildLibraryFromPosts();
  route();
  if (/[?&]debug=1\b/.test(location.search) || localStorage.getItem('__blog_debug__')==='1') runHealthCheck();
})();
</script>
</body>
</html>
