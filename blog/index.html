<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>블로그</title>

<!-- libs -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
:root{--bg:#0d141b;--panel:#10171e;--line:#1e2732;--text:#e7edf3;--muted:#a8b3bf;--accent:#5aa0ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
main{max-width:1040px;margin:28px auto;padding:0 16px;min-height:calc(100vh - 56px)}
main>header{display:flex;gap:8px;align-items:center;margin-bottom:12px;position:relative}
a.btn,button.btn{border:1px solid var(--line);background:#0b1117;color:var(--text);padding:8px 10px;border-radius:10px;text-decoration:none;cursor:pointer}
a.btn:hover,button.btn:hover{background:#151e2a}

/* ====== Library(카테고리) ====== */
.libwrap{position:relative;padding:20px;background:rgba(16,23,30,.4);border-radius:14px;overflow:hidden}
.libwrap ul.library{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:20px;justify-content:center}
.libwrap li.book{position:relative;width:140px;height:224px;cursor:pointer}
.libwrap .book .cover{width:140px;height:224px;box-shadow:3px 3px 10px rgba(0,0,0,.5)}
.libwrap .book .cover img{width:100%;height:100%;object-fit:cover;background:#0f1720;border:0}

/* 패널(요약) */
#summaryPanel{
  position:absolute;left:50%;top:0;transform:translate(-50%,-12px);
  display:flex;gap:18px;opacity:0;pointer-events:none;
  width:min(880px,92vw);background:rgba(14,20,28,.9);
  border:1px solid rgba(255,255,255,.08);border-radius:10px;
  box-shadow:0 18px 60px rgba(0,0,0,.5);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  transition:opacity .28s ease, transform .28s ease;
}
#summaryPanel.active{opacity:1;transform:translate(-50%,16px);pointer-events:auto}
#summaryPanel .panel-cover{width:200px;height:316px;border-radius:8px;overflow:hidden;flex-shrink:0}
#summaryPanel .panel-cover img{width:100%;height:100%;object-fit:cover}
#summaryPanel .panel-content{padding:14px 14px 14px 0;min-width:0}
#summaryPanel h1{margin:0 0 6px 0;font-size:26px}
#summaryPanel h2{margin:0 0 12px 0;font-size:18px;font-weight:400;opacity:.85;border-bottom:1px dashed rgba(255,255,255,.15);padding-bottom:10px}
#summaryPanel .mini{list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px}
#summaryPanel .mini a{color:var(--accent);text-decoration:none}
#summaryPanel .mini a:hover{text-decoration:underline}
#panelClose{
  position:absolute;right:10px;top:8px;border:1px solid rgba(255,255,255,.12);
  background:#0f1620;color:#cfe1ff;border-radius:8px;padding:4px 8px;cursor:pointer
}

/* 배경 딤(시각만, 클릭 통과) */
#panelBackdrop{
  position:absolute;inset:0;display:none;background:rgba(0,0,0,.18);
  backdrop-filter:blur(1.5px);pointer-events:none; /* ✅ 클릭 통과 */
}
#panelBackdrop.show{display:block}

/* ===== 목록/본문 ===== */
.hidden{display:none!important}
.list{display:grid;gap:12px}
.item{display:block;padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--panel);color:var(--text);text-decoration:none}
.item .m{color:var(--muted);font-size:12px;margin-top:4px}
.post{padding:16px;border:1px solid var(--line);border-radius:12px;background:var(--panel)}
.post .meta{color:var(--muted);font-size:12px;margin-bottom:12px}
.post img{max-width:100%;border-radius:10px}
pre{background:#0b1117;border:1px solid var(--line);padding:12px;border-radius:10px;overflow:auto}

/* ===== 디버그 pill / drawer ===== */
.dbg-pill{display:none;align-items:center;gap:6px;margin-left:auto;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);backdrop-filter:blur(12px);color:#dfe7ef}
.dbg-pill svg{width:16px;height:16px}
.dbg-pill.badge::after{content:"";width:7px;height:7px;border-radius:50%;background:#ff6b6b;box-shadow:0 0 0 4px rgba(255,107,107,.22);margin-left:2px}
#dbgDrawer{position:fixed;right:16px;top:76px;display:none;min-width:360px;width:min(720px,92vw);max-height:62vh;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(14,20,28,.7);backdrop-filter:blur(14px)}
#dbgDrawer.open{display:block}
#dbgDrawer header{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
#dbgDrawer header h4{margin:0;font-size:12px;opacity:.85}
#dbgDrawer header .sp{flex:1}
#dbgDrawer header button{padding:6px 8px;border:1px solid #2a3a46;background:#0f1821;color:#cfe1f0;border-radius:8px}
#dbgDrawer pre{margin:0;padding:10px}
</style>
</head>
<body>
<main>
  <header>
    <!-- ✅ 자리만 교체: 뒤로 → 홈 (기능은 그대로) -->
    <button id="backBtn" class="btn" type="button">뒤로</button>
    <a id="homeBtn" class="btn" href="../" data-home="">← 홈</a>

    <h1 id="title" style="margin:0 0 0 8px;font-size:18px">분류 전체보기</h1>
    <button id="dbgPill" class="dbg-pill" title="Alt+D (디버그)">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="7" y="6" width="10" height="14" rx="5"/><path d="M5 10h14"/></svg>
      <span>Debug</span>
    </button>
  </header>

  <!-- 카테고리 = 책장 -->
  <section id="viewCats" class="libwrap">
    <div id="panelBackdrop"></div>
    <ul class="library"></ul>

    <div id="summaryPanel" aria-live="polite">
      <button id="panelClose" type="button">닫기</button>
      <div class="panel-cover"><img alt=""></div>
      <div class="panel-content"></div>
    </div>

    <div id="diag" class="hidden" style="margin-top:12px"></div>
  </section>

  <!-- 글 목록 -->
  <div id="viewList" class="list hidden" aria-label="글 목록"></div>

  <!-- 본문 -->
  <section id="viewPost" class="post hidden" aria-label="글 본문">
    <h2 id="pTitle"></h2>
    <div id="pMeta" class="meta"></div>
    <article id="pBody"></article>
  </section>
</main>

<!-- Debug drawer -->
<section id="dbgDrawer" role="dialog" aria-modal="true" aria-label="디버그">
  <header>
    <h4>디버그</h4><span class="sp"></span>
    <button id="wCopy">복사</button>
    <button id="wClear">지움</button>
    <button id="wHealth">헬스</button>
  </header>
  <pre id="wLog"></pre>
</section>

<script>
/* ===== Paths ===== */
const BASE = (function(){ const p=location.pathname; return /\/$/.test(p)?p:p.replace(/[^/]+$/,'/'); })();
const DATA_URL  = BASE + 'data/posts.json';
const POSTS_DIR = BASE + 'posts/';

/* ===== Debug (pill+drawer, 에러때만 은은히 표시) ===== */
(function(){
  const pill = document.getElementById('dbgPill');
  const drawer = document.getElementById('dbgDrawer');
  const logEl = document.getElementById('wLog');
  const buf = [];
  const FORCE = /(?:\?|&)debug=1\b/.test(location.search) || localStorage.getItem('__blog_debug__')==='1';
  if (FORCE) pill.style.display='inline-flex';

  function line(t,m,x){ return `[${new Date().toLocaleTimeString()}] ${t.padEnd(5)} | ${m}${x?` | ${x}`:''}`; }
  function write(s){ buf.push(s); if(buf.length>300) buf.shift(); if(drawer.classList.contains('open')||FORCE){ logEl.textContent=buf.join('\n'); logEl.scrollTop=logEl.scrollHeight; } }
  function pulse(){ pill.classList.remove('badge'); void pill.offsetWidth; pill.classList.add('badge'); pill.style.display='inline-flex'; }

  window.dbg = (type,msg,extra) => {
    (type==='ERROR'?console.error:console.log)('[Blog]',type,msg,extra||'');
    write(line(type,msg,extra||''));
    if (type==='ERROR' || type==='WARN') pulse();
  };

  pill.addEventListener('click',()=>drawer.classList.toggle('open'));
  document.getElementById('wCopy').addEventListener('click',()=>navigator.clipboard.writeText(buf.join('\n')));
  document.getElementById('wClear').addEventListener('click',()=>{ buf.length=0; logEl.textContent=''; });
  document.getElementById('wHealth').addEventListener('click',()=>{ if (typeof runHealthCheck==='function') runHealthCheck(); });
  window.addEventListener('keydown',(e)=>{ if (e.altKey && (e.key==='d'||e.key==='D')) drawer.classList.toggle('open'); });
})();

/* ===== Utils ===== */
const $ = (s)=>document.querySelector(s);
const d = (x)=>x?new Date(x).toISOString().slice(0,10):'';
function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function placeholderCover(){
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='280' height='448'><rect width='100%' height='100%' fill='%23202833'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui' font-size='13' fill='%238ea0b7'>no cover</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function coverCandidates(nameOrSlug, cover){
  const out=[]; const add=u=>{if(u && !out.includes(u)) out.push(u);};
  const noSlash=s=>(s||'').replace(/^\//,'');
  if (cover){ add(cover); add(BASE+noSlash(cover)); }
  const raw=String(nameOrSlug||'').trim();
  const dashed=raw.replace(/\s+/g,'-').replace(/[\/\\?#%:*|"<>]/g,'-');
  const unders=raw.replace(/\s+/g,'_').replace(/[\/\\?#%:*|"<>]/g,'_');
  const roots=[BASE+'assets/covers/','/assets/covers/'];
  const bases=[raw,dashed,unders,raw.toLowerCase()];
  const suf=['','','-cover','-커버',' 표지','-표지','_cover','_커버','_표지'];
  const exts=['jpg','png','webp','jpeg'];
  for(const r of roots) for(const b of bases) for(const s of suf) for(const e of exts) add(r+b+s+'.'+e);
  add(placeholderCover());
  return out;
}
async function ffetch(url,opt={},tag='fetch'){
  try{ const r=await fetch(url,opt); dbg('INFO',tag,r.status+' '+url); if(!r.ok) throw new Error(tag+' '+r.status); return r; }
  catch(e){ dbg('ERROR',tag+' 실패', (e&&e.message)||String(e)); throw e; }
}

/* ===== Data → Library ===== */
let ALL=[], CATS={}, library=[];
function Book(cover,title,author,abstract){ this.cover=cover; this.title=title; this.author=author; this.abstract=abstract; library.push(this); }
function buildLibrary(){
  CATS={};
  ALL.forEach(p=>{ const c=p.category||'기타'; (CATS[c] ||= {name:c,posts:[]}).posts.push(p); });
  library.length=0;
  Object.keys(CATS).sort((a,b)=>a.localeCompare(b,'ko')).forEach(cat=>{
    const posts=CATS[cat].posts;
    const newest=posts.slice().sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
    const cand=coverCandidates(cat, newest?.cover);
    const bk=new Book(cand[0]||placeholderCover(), cat, '', posts.length+'개의 글'); bk._cat=cat; bk._coverCands=cand;
  });
}

/* ===== Library render & panel ===== */
let openCat=null;
function renderCats(){
  $('#title').textContent='분류 전체보기';
  $('#viewCats').classList.remove('hidden');
  $('#viewList').classList.add('hidden');
  $('#viewPost').classList.add('hidden');

  const ul=$('#viewCats ul.library'); ul.innerHTML='';
  library.forEach(bk=>{
    ul.insertAdjacentHTML('beforeend',
      `<li class="book" data-cat="${esc(bk._cat)}">
         <div class="cover"><img src="${esc(placeholderCover())}" data-cands='${esc(JSON.stringify(bk._coverCands||[]))}' alt="${esc(bk.title)}"></div>
       </li>`
    );
  });
  initLazyCovers();
}
function panelFor(cat){
  const posts=(CATS[cat]?.posts||[]).slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,8);
  const bk=library.find(b=>b._cat===cat)||{};
  const cover=(bk._coverCands && bk._coverCands[0])||placeholderCover();
  $('#summaryPanel .panel-cover img').src=cover;
  let html=`<h1>${esc(cat)}</h1><h2>최근 글</h2><ul class="mini">`;
  posts.forEach(p=>html+=`<li><a href="#/post/${encodeURIComponent(p.slug)}">${esc(p.title)}</a> <small>· ${esc(d(p.date))}</small></li>`);
  html+=`</ul><p style="margin-top:10px"><a href="#/category/${encodeURIComponent(cat)}">이 카테고리 전체 보기 →</a></p>`;
  $('#summaryPanel .panel-content').innerHTML=html;
}
function openPanel(cat){
  openCat=cat; panelFor(cat);
  $('#summaryPanel').classList.add('active');
  $('#panelBackdrop').classList.add('show'); /* 시각만 */
}
function closePanel(){
  openCat=null;
  $('#summaryPanel').classList.remove('active');
  $('#panelBackdrop').classList.remove('show');
}

/* 클릭: 같은 책 재클릭 → 닫힘, 다른 책 → 내용 교체/열기 */
$('#viewCats').addEventListener('click', (e)=>{
  const li=e.target.closest('li.book'); if(!li) return;
  const cat=li.dataset.cat;
  const opened=$('#summaryPanel').classList.contains('active');
  if (opened && openCat===cat){ closePanel(); }
  else if (opened){ openPanel(cat); } else { openPanel(cat); }
});
$('#panelClose').addEventListener('click', closePanel);
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePanel(); });

/* ===== 카테고리 → 글 목록 ===== */
function renderList(cat){
  $('#title').textContent=cat;
  $('#viewCats').classList.add('hidden');
  $('#viewList').classList.remove('hidden');
  $('#viewPost').classList.add('hidden');
  const list=ALL.filter(p=>(p.category||'기타')===cat).sort((a,b)=>new Date(b.date)-new Date(a.date));
  $('#viewList').innerHTML=list.length
    ? list.map(p=>`<a class="item" href="#/post/${encodeURIComponent(p.slug)}"><div class="t">${esc(p.title)}</div><div class="m">${esc(d(p.date))} · ${esc(p.summary||'')}</div></a>`).join('')
    : '<p class="m">글이 없습니다.</p>';
  closePanel();
}

/* ===== 게시글 ===== */
async function renderPost(slug){
  $('#viewCats').classList.add('hidden');
  $('#viewList').classList.add('hidden');
  $('#viewPost').classList.remove('hidden');
  closePanel();

  const m=ALL.find(p=>p.slug===slug)||{title:slug};
  $('#title').textContent=m.category||'게시글';
  $('#pTitle').textContent=m.title;
  $('#pMeta').textContent=[m.category,d(m.date)].filter(Boolean).join(' · ');
  $('#pBody').innerHTML='<p class="m">불러오는 중…</p>';
  try{
    const url=POSTS_DIR+encodeURIComponent(slug)+'.md';
    const r=await ffetch(url,{cache:'no-cache'},'post-md:'+slug);
    const md=await r.text();
    const body=md.replace(/^---[\s\S]*?---\s*/,'');
    $('#pBody').innerHTML=marked.parse(body,{mangle:false,headerIds:true});
    $('#pBody').querySelectorAll('pre code').forEach(b=>hljs.highlightElement(b));
    document.title=m.title+' - 블로그';
  }catch(e){
    $('#pBody').innerHTML='<p class="m">게시글을 찾을 수 없습니다.</p>';
  }
}

/* ===== 라우터 ===== */
function route(){
  const mPost=location.hash.match(/^#\/post\/(.+)$/);
  const mCat =location.hash.match(/^#\/category\/(.+)$/);
  if(mPost) return renderPost(decodeURIComponent(mPost[1]));
  if(mCat)  return renderList(decodeURIComponent(mCat[1]));
  return renderCats();
}
addEventListener('hashchange', route);

/* ===== Lazy cover ===== */
function initLazyCovers(){
  const getCands=(img)=>{ try{ return [...new Set(JSON.parse(img.getAttribute('data-cands')||'[]'))]; }catch{ return []; } };
  const io=new IntersectionObserver((ents)=>{
    ents.forEach(e=>{
      if(!e.isIntersecting) return;
      const img=e.target; if(img.dataset._started) return; img.dataset._started='1';
      const cands=getCands(img); let i=-1;
      const next=()=>{ i++; if(i<cands.length){ img.src=cands[i]; return; } img.onerror=img.onload=null; img.src=placeholderCover(); dbg('WARN','img fallback'); };
      img.onload =()=>{ dbg('INFO','img ok',img.currentSrc||img.src); img.onerror=img.onload=null; };
      img.onerror=()=>{ dbg('WARN','img fail',img.src); setTimeout(next,40); };
      next(); io.unobserve(img);
    });
  },{rootMargin:'200px'});
  document.querySelectorAll('#viewCats .library img[data-cands]').forEach(img=>io.observe(img));
}

/* ===== 헬스체크 ===== */
async function runHealthCheck(){
  dbg('INFO','health start');
  try{
    const r=await ffetch(DATA_URL,{cache:'no-store'},'posts.json');
    const j=await r.json(); dbg('INFO','posts='+((j.posts||[]).length));
    if ((j.posts||[]).length){
      const first=j.posts[0];
      try{ await ffetch(POSTS_DIR+encodeURIComponent(first.slug)+'.md',{cache:'no-store'},'first-md'); }catch{}
      const cat=first.category||'기타'; const cand=coverCandidates(cat,first.cover||'')[0]; try{ await ffetch(cand,{cache:'no-store'},'cover'); }catch{}
    }
  }catch{}
  dbg('INFO','health end');
}

/* ===== 홈/뒤로 핸들러(기능 유지) ===== */
document.getElementById('backBtn').addEventListener('click',()=>{ if(history.length>1) history.back(); else location.href='../'; });
(() => { const el=document.getElementById('homeBtn'); const explicit=(el.dataset.home||'').trim(); const fallback=new URL('../',location.href).href; el.href= explicit || fallback; })();

/* ===== 부팅 ===== */
(async function init(){
  try{
    const r=await ffetch(DATA_URL,{cache:'no-cache'},'posts.json');
    const j=await r.json();
    ALL=(j.posts||[]).map(p=>({...p,category:p.category||'기타'}));
  }catch(e){ dbg('ERROR','posts.json 불러오기 실패'); ALL=[]; }
  buildLibrary();
  route();
})();
</script>
</body>
</html>
