<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>보관된 도서</title>

<!-- Markdown & code highlight -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<style>
:root{
  --bg:#0d141b; --ink:#e7edf3; --muted:#a8b3bf; --line:#1e2732; --panel:#10171e;
  --min-card:192px;

  /* 책 스타일 */
  --book-radius:12px; --book-border:2px; --book-depth:16px; --book-tilt:.4deg;
  --spine-w:40px; /* 책등 더 도톰하게 */

  /* 3D 틸트 한계 */
  --tilt-x:10deg;  /* 위/아래 */
  --tilt-y:12deg;  /* 좌/우 */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:15px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  -webkit-font-smoothing:antialiased;
}
main{max-width:1120px;margin:28px auto;padding:0 16px}
header.page{display:flex;gap:8px;align-items:center;margin-bottom:16px}
.btn{border:1px solid var(--line);background:#0b1117;color:var(--ink);padding:8px 10px;border-radius:10px;text-decoration:none}
.hidden{display:none}

/* ===== 카테고리 그룹 ===== */
#viewList .group{margin:28px 0}
#viewList .group > .ghead{
  display:inline-block; margin:0 0 10px; font:800 17px/1.2 system-ui;
  color:#ffd166; letter-spacing:.02em;
  background:rgba(255,209,102,.10);
  border:1px solid rgba(255,209,102,.28);
  padding:7px 12px; border-radius:9px;
  text-shadow:0 1px 0 rgba(0,0,0,.22);
}
#viewList .grid{
  display:grid; gap:18px;
  grid-template-columns:repeat(auto-fill,minmax(var(--min-card),1fr));
}

/* ===== 책 카드 기본 컨테이너 ===== */
a.book{
  display:block; text-decoration:none; color:inherit; -webkit-tap-highlight-color:transparent;
  perspective:1200px; /* 안쪽 요소 3D */
}
.book article{
  position:relative; border-radius:var(--book-radius);
  border:var(--book-border) solid color-mix(in oklab, var(--avarage-color,#8aa0b4) 70%, black 30%);
  background:
    radial-gradient(120% 100% at 50% 0%, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
    linear-gradient(0deg, rgba(255,255,255,.05), transparent);
  /* 미세 가죽 텍스처 */
  background-image:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.06) 0 12%, transparent 13%),
    radial-gradient(circle at 70% 80%, rgba(255,255,255,.04) 0 14%, transparent 15%),
    linear-gradient(0deg, rgba(255,255,255,.05), transparent);
  box-shadow:
    0 0 0 1px rgba(255,255,255,.06) inset,
    0 8px var(--book-depth) rgba(0,0,0,.35),
    0 2px 12px rgba(0,0,0,.35);
  transform:
    rotate(var(--book-tilt))
    rotateX(var(--rx, 0deg))
    rotateY(var(--ry, 0deg));
  transition:transform .28s cubic-bezier(.22,.8,.2,1), box-shadow .28s, filter .28s, border-color .28s;
  overflow:hidden;
  will-change: transform;
}
a.book:is(:hover,:focus-visible) article{
  box-shadow:
    0 0 0 1px rgba(255,255,255,.08) inset,
    0 16px calc(var(--book-depth)+6px) rgba(0,0,0,.42),
    0 12px 30px rgba(0,0,0,.55);
  filter:saturate(1.05);
}

/* ===== 커버 프레임 ===== */
.book figure{
  margin:0; position:relative; aspect-ratio:257/364;
  border-radius:calc(var(--book-radius) - var(--book-border));
  overflow:hidden;
}
.book img{
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:cover; object-position:center;
  transform: translateZ(0); /* 레이어 분리 */
}

/* ===== 책등(스파인) — 더 선명 + 가이드라인 ===== */
.book .spine{
  position:absolute; inset:0 auto 0 0; width:var(--spine-w); z-index:3;
  background:
    linear-gradient(90deg, rgba(0,0,0,.55), rgba(255,255,255,.16) 48%, rgba(0,0,0,.42)),
    color-mix(in oklab, var(--avarage-color,#768aa2) 72%, black 28%);
  border-right:1px solid rgba(255,255,255,.22);
  box-shadow:
    2px 0 8px rgba(0,0,0,.45) inset,
    1px 0 0 rgba(255,255,255,.06) inset;
}
.spine::after{
  /* 얕은 재봉선/문양 느낌 */
  content:""; position:absolute; inset:6px 4px; border-left:1px dashed rgba(0,0,0,.25);
  opacity:.35;
}
.spine .t{
  position:absolute; inset:auto 0 10px 0; /* 아래에서 살짝 올라오게 */
  writing-mode:vertical-rl; text-orientation:mixed;
  margin:auto; max-height:86%;
  padding:10px 0 8px;
  font-weight:900; letter-spacing:.08em; line-height:1.02; font-size:13px;
  color:#f8fbff;
  text-shadow:0 1px 0 rgba(0,0,0,.65), 0 0 10px rgba(255,255,255,.15);
  filter:drop-shadow(0 0 1px rgba(0,0,0,.6));
  overflow:hidden;
}

/* ===== 오른쪽 페이지 단면(엣지) ===== */
.book .edge{
  position:absolute; top:6px; bottom:6px; right:6px; width:12px; z-index:2;
  background:
    repeating-linear-gradient(180deg,
      #f5f6f8 0 2px,
      #e7e9ef 2px 4px);
  border-left:1px solid rgba(0,0,0,.08);
  box-shadow:inset 0 0 3px rgba(0,0,0,.15), 0 0 0 1px rgba(255,255,255,.04);
  border-radius:3px;
  opacity:.95;
}

/* ===== 커버 글라스 라벨(하단 캡션) ===== */
.book figcaption{
  position:absolute; left:calc(var(--spine-w) + 10px); right:12px; bottom:12px; z-index:4;
  padding:9px 12px; border-radius:11px;
  background:
    linear-gradient(180deg, rgba(10,14,18,.78), rgba(10,14,18,.46)),
    radial-gradient(80% 100% at 50% 0%, rgba(255,255,255,.08), transparent 70%);
  backdrop-filter: blur(7px) saturate(1.18);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 2px 12px rgba(0,0,0,.46), inset 0 1px 0 rgba(255,255,255,.08);
  color:#fff; font-weight:900; font-size:14px; line-height:1.2; letter-spacing:.01em;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  transform:translateY(0); transition:transform .2s ease, box-shadow .2s ease;
}
a.book:is(:hover,:focus-visible) figcaption{ transform:translateY(-2px) }

/* ===== 리본(책갈피) — 입체/스티치/반짝 스윕 ===== */
.book .ribbon{
  position:absolute; top:-2px; right:14px; width:18px; height:38px; z-index:5;
  background:
    linear-gradient(180deg, #ff9aa8 0%, #e63a49 48%, #b11823 100%);
  clip-path:polygon(0 0,100% 0,100% 72%,50% 100%,0 72%);
  filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));
  border:1px solid rgba(0,0,0,.35);
  box-shadow: inset 0 -6px 10px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.28);
}
.book .ribbon::before{
  /* 스티치 */
  content:""; position:absolute; left:2px; right:2px; top:2px; height:2px;
  background:
    repeating-linear-gradient(90deg, rgba(255,255,255,.9) 0 2px, rgba(255,255,255,0) 2px 4px);
  opacity:.9; filter:drop-shadow(0 1px 0 rgba(0,0,0,.25));
}
.book .ribbon::after{
  /* 반짝 스윕 */
  content:""; position:absolute; inset:-6px; transform:translateX(-120%) rotate(18deg);
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.7) 45%, transparent 70%);
  mix-blend-mode:screen; opacity:.9;
}
a.book:is(:hover,:focus-visible) .ribbon::after{
  animation: shine 900ms ease forwards;
}
@keyframes shine{
  to { transform:translateX(40%) rotate(18deg); opacity:0; }
}

/* ===== 커버 하이라이트(글로스 스윕) ===== */
.book .gloss{
  position:absolute; inset:-20%; pointer-events:none; z-index:4; opacity:.0;
  background:
    linear-gradient(110deg, transparent 35%, rgba(255,255,255,.35) 48%, transparent 62%);
  transform: translateX(calc((var(--mx, .5) - .5) * 20%));
  transition: opacity .25s ease;
}
a.book:is(:hover,:focus-visible) .gloss{ opacity:.22 }

/* 본문(글 보기) */
#viewPost.post{padding:0;border:none;background:none;margin-top:8px}
#viewPost .paper{
  position:relative; padding:26px 22px;
  background:
    radial-gradient(150% 100% at 0% 0%, rgba(0,0,0,.26), transparent 40%),
    radial-gradient(150% 100% at 100% 0%, rgba(0,0,0,.22), transparent 42%),
    repeating-linear-gradient(0deg, rgba(0,0,0,.04), rgba(0,0,0,.04) 1px, transparent 1px, transparent 26px),
    linear-gradient(0deg,#0f141a,#0f161c);
  border-radius:12px; border:1px solid var(--line);
  box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 14px 30px rgba(0,0,0,.45);
}
#pTitle{margin:0 0 6px; font-size:22px}
#pMeta{color:var(--muted); margin-bottom:14px}
#pBody{line-height:1.75; font-size:16px}
#pBody h1,#pBody h2,#pBody h3{margin-top:1.6em}
#pBody img{display:block; margin:12px auto; border-radius:10px; max-width:100%}
#pBody blockquote{margin:14px 0; padding:10px 12px; border-left:4px solid #ffd16633; background:#ffd1660f; color:#ffd166; border-radius:8px}
#pBody a{color:#8ecbff}
</style>
</head>

<body>
<main>
  <header class="page">
    <a class="btn" href="../">← 홈</a>
    <button id="backBtn" class="btn" type="button" aria-label="뒤로 가기">뒤로</button>
    <h1 id="title" style="margin:0 0 0 8px;font-size:18px">분류 전체보기</h1>
  </header>

  <div id="viewList" aria-label="책 목록"></div>

  <section id="viewPost" class="post hidden" aria-label="글 본문">
    <h2 id="pTitle"></h2>
    <div id="pMeta" class="meta"></div>
    <article id="pBody"></article>
  </section>
</main>

<script>
/* ===== 경로 & 데이터 ===== */
const BASE = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, '/');
const DATA_URL  = BASE + 'data/posts.json';
const POSTS_DIR = BASE + 'posts/';

const $=s=>document.querySelector(s);
const d=x=>x?new Date(x).toISOString().slice(0,10):'';
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* 커버 폴백: /assets → BASE/assets → placeholder */
window._coverNext = function (ev) {
  const img = ev.target;
  try {
    const list = JSON.parse(img.dataset.cands || "[]");
    if (list.length) {
      const next = list.shift();
      img.dataset.cands = JSON.stringify(list);
      img.src = next;
      return;
    }
  } catch (_) {}
};

/* 커버 후보: jpg → png → webp, 루트와 BASE 모두 + 플레이스홀더 */
function coverCandidates(slug, cover) {
  if (cover) {
    return [
      cover,
      `/assets/covers/_placeholder.jpg`,
      `${BASE}assets/covers/_placeholder.jpg`,
    ];
  }
  return [
    `/assets/covers/${slug}.jpg`,
    `${BASE}assets/covers/${slug}.jpg`,
    `/assets/covers/${slug}.png`,
    `${BASE}assets/covers/${slug}.png`,
    `/assets/covers/${slug}.webp`,
    `${BASE}assets/covers/${slug}.webp`,
    `/assets/covers/_placeholder.jpg`,
    `${BASE}assets/covers/_placeholder.jpg`,
  ];
}

/* 책 카드 하나 */
function bookCardHTML(p){
  const slug   = p.slug;
  const color  = p.color || '#8e8e8e';
  const cands  = coverCandidates(slug, p.cover);

  return `
    <a class="book" href="#/post/${encodeURIComponent(slug)}" aria-label="${esc(p.title)}">
      <article style="--avarage-color:${color}">
        <figure>
          <img
            src="${esc(cands[0])}"
            data-cands='${esc(JSON.stringify(cands.slice(1)))}'
            onerror="window._coverNext && window._coverNext(event)"
            alt="">
          <div class="spine"><span class="t">${esc(p.shortTitle || p.title)}</span></div>
          <span class="edge" aria-hidden="true"></span>
          <span class="gloss" aria-hidden="true"></span>
          <div class="ribbon" aria-hidden="true"></div>
          <figcaption>${esc(p.title)}</figcaption>
        </figure>
      </article>
    </a>`;
}

/* 카테고리 묶음 */
function groupHTML(cat, list){
  return `
    <div class="group">
      <h2 class="ghead">${esc(cat)}</h2>
      <div class="grid">
        ${list.map(bookCardHTML).join('')}
      </div>
    </div>`;
}

/* 데이터/렌더 */
let ALL=[];
function renderIndex(){
  $('#title').textContent='분류 전체보기';
  $('#viewPost').classList.add('hidden');

  const byCat={};
  ALL.forEach(p => (byCat[p.category||'기타'] ||= []).push(p));

  const html = Object.entries(byCat)
    .sort(([a],[b])=>a.localeCompare(b,'ko'))
    .map(([cat, list]) => groupHTML(cat, list.sort((a,b)=>new Date(b.date)-new Date(a.date))))
    .join('');

  $('#viewList').innerHTML = html;
  enhanceBooks(); // 커서-따라 3D 인터랙션 부착
}

async function renderPost(slug){
  $('#viewPost').classList.remove('hidden');
  const m = ALL.find(p=>p.slug===slug) || {title:slug};
  $('#title').textContent = m.category || '';
  $('#pTitle').textContent = m.title || slug;
  $('#pMeta').textContent = [m.category, d(m.date)].filter(Boolean).join(' · ');
  $('#pBody').innerHTML = '불러오는 중…';

  const url = POSTS_DIR + encodeURIComponent(slug) + '.md';
  try{
    const r = await fetch(url,{cache:'no-cache'});
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    const md = await r.text();
    const body = md.replace(/^---[\s\S]*?---\s*/, ''); // front-matter 제거
    $('#pBody').innerHTML = marked.parse(body,{mangle:false,headerIds:true});
    $('#pBody').querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
    document.title = m.title + ' - 보관된 도서';

    // 종이 래퍼 한번만
    if (!document.querySelector('#viewPost .paper')) {
      const wrap = document.createElement('div');
      wrap.className = 'paper';
      const art = $('#pBody');
      art.parentNode.insertBefore(wrap, art);
      wrap.appendChild(art);
    }
  }catch(e){
    console.error(e);
    $('#pBody').innerHTML = `<p class="m">게시글을 찾을 수 없습니다.<br><small>경로: ${url}</small></p>`;
  }
}

/* 라우트 */
function route(){
  const mPost=location.hash.match(/^#\/post\/(.+)$/);
  if(mPost){ renderPost(decodeURIComponent(mPost[1])); return; }
  renderIndex();
}
$('#backBtn').addEventListener('click', () => {
  if (document.referrer && new URL(document.referrer).origin === location.origin) history.back();
  else location.assign('../');
});

/* ===== 커서-따라 3D 틸트 & 글로스 위치 ===== */
function enhanceBooks(){
  const reduce = matchMedia?.('(prefers-reduced-motion: reduce)').matches ?? false;
  if (reduce) return;

  const books = document.querySelectorAll('#viewList a.book');
  books.forEach((card) => {
    const art = card.querySelector('article');
    const gloss = card.querySelector('.gloss');

    let raf = 0;

    function onMove(e){
      if (!art) return;
      const rect = art.getBoundingClientRect();
      const cx = (e.clientX - rect.left) / rect.width;   // 0..1
      const cy = (e.clientY - rect.top)  / rect.height;  // 0..1
      const rx = (0.5 - cy) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tilt-x')) || 0;
      const ry = (cx - 0.5) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tilt-y')) || 0;

      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        art.style.setProperty('--rx', rx + ''); // deg 포함됨
        art.style.setProperty('--ry', ry + '');
        if (gloss){
          gloss.style.setProperty('--mx', cx.toFixed(3));
          gloss.style.setProperty('--my', cy.toFixed(3));
        }
      });
    }
    function reset(){
      cancelAnimationFrame(raf);
      art?.style.setProperty('--rx','0deg');
      art?.style.setProperty('--ry','0deg');
    }

    card.addEventListener('pointermove', (e)=>{ if(e.pointerType==='mouse') onMove(e); });
    card.addEventListener('pointerleave', reset);
  });
}

/* 초기화 */
(async () => {
  try{
    const r=await fetch(DATA_URL,{cache:'no-cache'});
    const j=await r.json();
    ALL=(j.posts||[]).map(p=>({...p,category:p.category||'기타'}));
  }catch(e){ console.error('posts.json 로드 실패',e); ALL=[]; }
  route(); addEventListener('hashchange',route);
})();
</script>
</body>
</html>
